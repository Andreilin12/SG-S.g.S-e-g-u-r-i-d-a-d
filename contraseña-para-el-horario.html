<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gestión de Contraseñas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --primary: #15a086;
      --secondary: #12876f;
      --error: #e74c3c;
      --success: #2ecc71;
      --warning: #f39c12;
      --glow: #00ffcc;
      --modal-bg: rgba(26, 42, 56, 0.95);
      --dark: #2c3e50;
      --light: #ecf0f1;
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #2c3e50, #1a2a38);
      color: white;
      margin: 0;
      padding: 20px;
      font-size: 14px;
      -webkit-text-size-adjust: 100%;
      overflow-x: hidden;
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: var(--modal-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
      border: 1px solid var(--glass-border);
    }

    h1 {
      color: var(--primary);
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 20px;
      text-shadow: 0 0 10px var(--glow);
    }

    h2 {
      color: white;
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
      text-shadow: 0 0 5px var(--glow);
    }

    h2 i {
      color: var(--primary);
    }

    .message {
      padding: 10px;
      border-radius: 5px;
      text-align: center;
      display: none;
      margin-bottom: 15px;
    }

    .error {
      background: rgba(231, 76, 60, 0.2);
      color: var(--error);
      border: 1px solid var(--error);
      display: block;
    }

    .success {
      background: rgba(46, 204, 113, 0.2);
      color: var(--success);
      border: 1px solid var(--success);
      display: block;
    }

    .warning {
      background: rgba(243, 156, 18, 0.2);
      color: var(--warning);
      border: 1px solid var(--warning);
      display: block;
    }

    .auth-section {
      background-color: rgba(31, 43, 56, 0.6);
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 1px solid var(--glass-border);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #bdc3c7;
    }

    input, select {
      width: 100%;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid var(--glass-border);
      background-color: rgba(31, 43, 56, 0.7);
      color: white;
      font-size: 1rem;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(21, 160, 134, 0.3);
    }

    button {
      padding: 10px 15px;
      border-radius: 6px;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.9rem;
    }

    button:hover {
      background: var(--secondary);
      box-shadow: 0 0 10px var(--glow);
      transform: translateY(-2px);
    }

    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    /* Menu Section */
    .menu-section {
      display: none;
      text-align: center;
      margin-bottom: 30px;
    }

    .menu-options {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .menu-option {
      background: rgba(31, 43, 56, 0.7);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--glass-border);
      cursor: pointer;
      transition: all 0.3s ease;
      width: 200px;
      text-align: center;
    }

    .menu-option:hover {
      background: var(--primary);
      transform: scale(1.05);
      box-shadow: 0 0 15px var(--glow);
    }

    .menu-option i {
      font-size: 2rem;
      margin-bottom: 10px;
      color: var(--primary);
    }

    .menu-option:hover i {
      color: white;
    }

    .menu-option span {
      font-size: 1rem;
      font-weight: 500;
    }

    /* Employee Password Section */
    .employee-password-section {
      display: none;
    }

    .search-container {
      margin-bottom: 20px;
      position: relative;
    }

    .search-container input {
      width: 100%;
      padding: 12px 15px;
      padding-right: 40px;
      border-radius: 8px;
      border: 1px solid rgba(21, 160, 134, 0.5);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .search-container input:focus {
      outline: none;
      box-shadow: 0 0 10px var(--glow);
    }

    .search-container i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
    }

    .employee-list {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
      border: 1px solid rgba(21, 160, 134, 0.3);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
    }

    .employee-item {
      padding: 12px 15px;
      border-bottom: 1px solid rgba(21, 160, 134, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .employee-item:hover {
      background: rgba(21, 160, 134, 0.2);
      transform: translateX(5px);
    }

    .employee-item.selected {
      background: rgba(21, 160, 134, 0.3);
      box-shadow: 0 0 10察px var(--glow);
    }

    .employee-info {
      flex: 1;
    }

    .employee-name {
      font-weight: 500;
      margin-bottom: 5px;
      font-size: 1rem;
    }

    .employee-details {
      font-size: 0.8rem;
      color: #bdc3c7;
      display: flex;
      gap: 15px;
    }

    .employee-password {
      font-size: 0.9rem;
      background: rgba(21, 160, 134, 0.3);
      padding: 5px 10px;
      border-radius: 4px;
      margin-left: 10px;
      transition: all 0.3s ease;
    }

    .employee-password:hover {
      background: rgba(21, 160, 134, 0.5);
      box-shadow: 0 0 5px var(--glow);
    }

    .password-section {
      background: rgba(26, 42, 56, 0.7);
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
      position: relative;
      z-index: 2;
    }

    .selected-employee {
      margin-bottom: 15px;
      text-align: center;
      font-weight: 500;
      font-size: 1.1rem;
    }

    .password-display-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .password-display {
      font-size: 1.4rem;
      letter-spacing: 3px;
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      min-height: 45px;
      min-width: 160px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .password-display:hover {
      background: rgba(0, 0, 0, 0.5);
      box-shadow: 0 0 15px var(--glow);
    }

    .password-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      justify-content: center;
    }

    .password-actions button {
      flex: 1;
      max-width: 200px;
    }

    .numpad-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--modal-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px var(--glow);
      z-index: 500;
      backdrop-filter: blur(5px);
      border: 1px solid var(--glow);
    }

    .numpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .numpad button {
      padding: 15px;
      font-size: 1.2rem;
      background: rgba(44, 62, 80, 0.8);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: white;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    }

    .numpad button:hover {
      background: var(--primary);
      box-shadow: 0 0 10px var(--glow);
      transform: scale(1.05);
    }

    .numpad button:active {
      transform: scale(0.95);
    }

    .numpad .clear-btn {
      background: var(--error);
    }

    .numpad .clear-btn:hover {
      background: #c0392b;
    }

    .numpad .save-btn {
      background: var(--success);
      grid-column: span 2;
    }

    .numpad .save-btn:hover {
      background: #27ae60;
    }

    .export-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }

    .export-buttons button {
      flex: 1;
      max-width: 200px;
    }

    .copy-btn {
      background: #3498db;
    }

    .copy-btn:hover {
      background: #2980b9;
    }

    .download-btn {
      background: #9b59b6;
    }

    .download-btn:hover {
      background: #8e44ad;
    }

    .download-jpg-btn {
      background: var(--warning);
    }

    .download-jpg-btn:hover {
      background: #e67e22;
    }

    /* Guide Styles */
    .guide-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      z-index: 999;
    }

    .guide-magnifier {
      position: fixed;
      width: 150px;
      height: 150px;
      border-radius: 50%;
      border: 3px solid var(--glow);
      box-shadow: 0 0 20px var(--glow), inset 0 0 10px var(--glow);
      background: transparent;
      pointer-events: none;
      z-index: 1001;
      transition: all 0.5s ease;
    }

    .guide-description {
      position: fixed;
      background: var(--modal-bg);
      padding: 15px;
      border-radius: 8px;
      color: white;
      font-size: 0.9rem;
      max-width: 80vw;
      min-width: 200px;
      box-shadow: 0 0 15px var(--glow);
      z-index: 1002;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 10px;
      white-space: normal;
      word-wrap: break-word;
      line-height: 1.4;
    }

    .guide-description i {
      font-size: 1.2rem;
      color: var(--primary);
      flex-shrink: 0;
    }

    .guide-buttons {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 1002;
    }

    .guide-buttons button {
      padding: 10px 20px;
      font-size: 0.9rem;
    }

    .guide-skip-btn {
      background: #e74c3c;
    }

    .guide-skip-btn:hover {
      background: #c0392b;
    }

    .guide-highlight {
      position: relative;
      z-index: 1000;
      box-shadow: 0 0 15px var(--glow);
      transition: all 0.3s ease;
    }

    /* Position Password Section */
    .position-password-section {
      display: none;
    }

    .password-display {
      font-size: 24px;
      letter-spacing: 3px;
      margin: 20px 0;
      padding: 15px;
      background-color: rgba(31, 43, 56, 0.7);
      border-radius: 8px;
      text-align: center;
      min-height: 40px;
      border: 1px solid var(--glass-border);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .password-display .toggle-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 1rem;
      cursor: pointer;
      padding: 5px;
    }

    .password-display .copy-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 1rem;
      cursor: pointer;
      padding: 5px;
    }

    .keyboard-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 12px;
    }

    .positions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
      margin-bottom: 15px;
    }

    .print-all-btn {
      background-color: var(--warning);
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .print-all-btn:hover {
      background-color: #e67e22;
    }

    .position-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      margin-bottom: 12px;
      background-color: rgba(31, 43, 56, 0.6);
      border-radius: 8px;
      border: 1px solid var(--glass-border);
      position: relative;
    }

    .position-info {
      flex: 1;
    }

    .position-name {
      font-weight: 600;
      color: white;
      margin-bottom: 5px;
    }

    .position-password {
      font-family: monospace;
      letter-spacing: 2px;
      color: #bdc3c7;
      font-size: 0.9rem;
    }

    .position-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      min-width: 80px;
    }

    .view-btn {
      background-color: rgba(21, 160, 134, 0.2);
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .view-btn:hover {
      background-color: var(--primary);
      color: white;
    }

    .delete-btn {
      background-color: rgba(231, 76, 60, 0.2);
      color: var(--error);
      border: 1px solid var(--error);
    }

    .delete-btn:hover {
      background-color: var(--error);
      color: white;
    }

    .hidden-actions {
      position: absolute;
      right: 15px;
      top: -15px;
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .position-item:hover .hidden-actions {
      opacity: 1;
    }

    .hidden-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      background-color: rgba(31, 43, 56, 0.9);
      border: 1px solid var(--glass-border);
      color: var(--light);
      cursor: pointer;
      transition: all 0.3s;
    }

    .hidden-btn:hover {
      background-color: var(--primary);
      transform: scale(1.1);
    }

    .copy-all-btn {
      color: var(--success);
    }

    .copy-all-btn:hover {
      background-color: var(--success);
      color: white;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .employee-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .employee-password {
        margin-left: 0;
        margin-top: 5px;
        width: 100%;
      }

      .employee-details {
        flex-direction: column;
        gap: 3px;
      }

      .numpad button {
        padding: 12px;
        font-size: 1.1rem;
        height: 45px;
      }

      .password-actions,
      .export-buttons,
      .action-buttons {
        flex-direction: column;
        align-items: center;
      }

      .password-actions button,
      .export-buttons button,
      .action-buttons button {
        max-width: 100%;
        width: 100%;
      }

      .guide-magnifier {
        width: 100px;
        height: 100px;
      }

      .guide-description {
        font-size: 0.8rem;
        max-width: 90vw;
        min-width: 150px;
      }

      .menu-options {
        flex-direction: column;
        align-items: center;
      }

      .menu-option {
        width: 100%;
        max-width: 300px;
      }

      .positions-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .print-all-btn {
        width: 100%;
      }

      .position-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
        padding-top: 25px;
      }

      .position-actions {
        width: 100%;
        justify-content: flex-end;
      }

      .hidden-actions {
        top: 5px;
        right: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-key"></i> Gestión de Contraseñas</h1>

    <div class="message" id="message"></div>

    <div class="auth-section" id="authSection">
      <h2><i class="fas fa-user-shield"></i> Verificación Requerida</h2>
      <p>Para acceder a la gestión de contraseñas, ingrese su contraseña actual:</p>
      <div class="form-group">
        <label for="currentPassword">Contraseña:</label>
        <input type="password" id="currentPassword" placeholder="Ingrese su contraseña">
      </div>
      <button onclick="verifyUser()"><i class="fas fa-check-circle"></i> Verificar</button>
    </div>

    <div class="menu-section" id="menuSection">
      <h2><i class="fas fa-list"></i> Seleccione una Opción</h2>
      <div class="menu-options">
        <div class="menu-option" onclick="showSection('employee-password-section')">
          <i class="fas fa-user"></i>
          <span>Asignación de Contraseñas</span>
        </div>
        <div class="menu-option" onclick="showSection('position-password-section')">
          <i class="fas fa-briefcase"></i>
          <span>Contraseñas por Posición</span>
        </div>
      </div>
    </div>

    <div class="guide-overlay" id="guideOverlay">
      <div class="guide-magnifier" id="guideMagnifier"></div>
      <div class="guide-description" id="guideDescription"></div>
      <div class="guide-buttons">
        <button class="guide-skip-btn" id="guideSkipBtn"><i class="fas fa-times"></i> Omitir Guía</button>
        <button id="guideNextBtn"><i class="fas fa-arrow-right"></i> Siguiente</button>
      </div>
    </div>

    <div class="employee-password-section" id="employee-password-section">
      <div class="search-container">
        <input type="text" id="employeeSearch" placeholder="Buscar colaborador por nombre, posición o código...">
        <i class="fas fa-search"></i>
      </div>

      <div class="employee-list" id="employeeList"></div>

      <div class="password-section" id="passwordSection">
        <h2><i class="fas fa-lock"></i> Asignar Contraseña</h2>
        <div class="selected-employee" id="selectedEmployeeName">
          Colaborador: [Nombre del Colaborador]
        </div>
        <div class="password-display-container">
          <div class="password-display" id="passwordDisplay" onclick="openNumpadForPassword()">
            Ingrese una contraseña
          </div>
          <button class="copy-btn" id="copyPasswordBtn">
            <i class="fas fa-copy"></i> Copiar
          </button>
        </div>
        <div class="password-actions">
          <button id="generateRandomBtn">
            <i class="fas fa-random"></i> Generar Aleatoria
          </button>
          <button id="openNumpadBtn">
            <i class="fas fa-keyboard"></i> Ingresar Manual
          </button>
          <button id="clearPasswordBtn">
            <i class="fas fa-backspace"></i> Limpiar
          </button>
        </div>
        <div class="export-buttons">
          <button class="download-btn" id="downloadCsvBtn">
            <i class="fas fa-file-csv"></i> Descargar CSV
          </button>
          <button class="download-jpg-btn" id="downloadJpgBtn">
            <i class="fas fa-file-image"></i> Descargar JPG
          </button>
        </div>
      </div>

      <div class="numpad-modal" id="numpadModal">
        <div class="numpad">
          <button class="numpad-btn" data-digit="1" onclick="appendEmployeePassword('1')">1</button>
          <button class="numpad-btn" data-digit="2" onclick="appendEmployeePassword('2')">2</button>
          <button class="numpad-btn" data-digit="3" onclick="appendEmployeePassword('3')">3</button>
          <button class="numpad-btn" data-digit="4" onclick="appendEmployeePassword('4')">4</button>
          <button class="numpad-btn" data-digit="5" onclick="appendEmployeePassword('5')">5</button>
          <button class="numpad-btn" data-digit="6" onclick="appendEmployeePassword('6')">6</button>
          <button class="numpad-btn" data-digit="7" onclick="appendEmployeePassword('7')">7</button>
          <button class="numpad-btn" data-digit="8" onclick="appendEmployeePassword('8')">8</button>
          <button class="numpad-btn" data-digit="9" onclick="appendEmployeePassword('9')">9</button>
          <button class="clear-btn" id="numpadClearBtn" onclick="clearEmployeePassword()">
            <i class="fas fa-backspace"></i>
          </button>
          <button class="numpad-btn" data-digit="0" onclick="appendEmployeePassword('0')">0</button>
          <button class="save-btn" id="numpadSaveBtn" onclick="saveEmployeePassword()">
            <i class="fas fa-save"></i> Guardar
          </button>
        </div>
      </div>
    </div>

    <div class="position-password-section" id="position-password-section">
      <h2><i class="fas fa-key"></i> Asignar Contraseña por Posición</h2>
      <div class="form-group">
        <label for="positionSelect">Seleccionar Posición:</label>
        <select id="positionSelect">
          <option value="">-- Seleccione una posición --</option>
        </select>
      </div>
      <div class="form-group">
        <label>Contraseña (4-6 dígitos):</label>
        <div class="password-display" id="positionPasswordDisplay">
          <span id="positionPasswordText"></span>
          <button class="toggle-btn" id="togglePositionPasswordBtn" onclick="togglePositionPasswordVisibility()" title="Mostrar/ocultar">
            <i class="fas fa-eye"></i>
          </button>
          <button class="copy-btn" id="copyPositionPasswordBtn" onclick="copyPositionPassword()" title="Copiar contraseña">
            <i class="fas fa-copy"></i>
          </button>
        </div>
        <div class="keyboard-container">
          <div class="numpad" id="positionNumpad">
            <button class="numpad-btn" data-digit="1" onclick="appendPositionPassword('1')">1</button>
            <button class="numpad-btn" data-digit="2" onclick="appendPositionPassword('2')">2</button>
            <button class="numpad-btn" data-digit="3" onclick="appendPositionPassword('3')">3</button>
            <button class="numpad-btn" data-digit="4" onclick="appendPositionPassword('4')">4</button>
            <button class="numpad-btn" data-digit="5" onclick="appendPositionPassword('5')">5</button>
            <button class="numpad-btn" data-digit="6" onclick="appendPositionPassword('6')">6</button>
            <button class="numpad-btn" data-digit="7" onclick="appendPositionPassword('7')">7</button>
            <button class="numpad-btn" data-digit="8" onclick="appendPositionPassword('8')">8</button>
            <button class="numpad-btn" data-digit="9" onclick="appendPositionPassword('9')">9</button>
            <button class="clear-btn" id="positionBackspaceBtn" onclick="backspacePositionPassword()"><i class="fas fa-backspace"></i></button>
            <button class="numpad-btn" data-digit="0" onclick="appendPositionPassword('0')">0</button>
            <button class="clear-btn" id="positionClearBtn" onclick="clearPositionPassword()">
              <i class="fas fa-trash"></i> Limpiar
            </button>
            <button class="save-btn" id="positionSaveBtn" onclick="savePositionPassword()">
              <i class="fas fa-save"></i> Guardar
            </button>
          </div>
        </div>
      </div>
      <div class="positions-list">
        <div class="positions-header">
          <h2><i class="fas fa-list-check"></i> Contraseñas Asignadas</h2>
          <button class="print-all-btn" id="printAllBtn" onclick="printAllPositionPasswords()">
            <i class="fas fa-print"></i> Imprimir
          </button>
        </div>
        <div id="positionsList">
          <p>No hay contraseñas configuradas aún.</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged,
      reauthenticateWithCredential,
      EmailAuthProvider
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      doc, 
      getDoc, 
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
      authDomain: "inventario-35d6b.firebaseapp.com",
      databaseURL: "https://inventario-35d6b-default-rtdb.firebaseio.com",
      projectId: "inventario-35d6b",
      storageBucket: "inventario-35d6b.appspot.com",
      messagingSenderId: "266100399659",
      appId: "1:266100399659:web:92358d28cbd803c8a7d46e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables
    let currentUser = null;
    let isAdmin = false;
    let currentGuideStep = 0;
    let currentGuideType = '';

    // Employee Password Section Variables
    let allEmployees = [];
    let selectedEmployee = null;
    let employeeCurrentPassword = '';
    let employeeDetails = {};
    let employeePasswords = {};

    // Position Password Section Variables
    let positionCurrentPassword = '';
    let positionPasswords = {};
    let showPositionPasswordText = false;

    // Show message
    function showMessage(text, type) {
      const messageElement = document.getElementById('message');
      messageElement.textContent = text;
      messageElement.className = `message ${type}`;
      messageElement.style.display = 'block';
      setTimeout(() => messageElement.style.display = 'none', 5000);
    }

    // Verify user
    window.verifyUser = async function() {
      const password = document.getElementById('currentPassword').value;
      if (!password) {
        showMessage('Ingrese su contraseña', 'error');
        return;
      }

      try {
        const credential = EmailAuthProvider.credential(currentUser.email, password);
        await reauthenticateWithCredential(currentUser, credential);
        const userDoc = await getDoc(doc(db, "users", currentUser.uid));
        if (userDoc.exists() && userDoc.data().tipoUsuario === 'admin') {
          isAdmin = true;
          document.getElementById('authSection').style.display = 'none';
          document.getElementById('menuSection').style.display = 'block';
          showMessage('Verificación exitosa', 'success');
        } else {
          showMessage('Solo administradores pueden acceder', 'error');
        }
      } catch (error) {
        console.error("Error:", error);
        showMessage('Contraseña incorrecta', 'error');
      }
    }

    // Show section based on menu selection
    window.showSection = function(sectionId) {
      console.log('Showing section:', sectionId);
      try {
        document.getElementById('menuSection').style.display = 'none';
        document.getElementById('employee-password-section').style.display = sectionId === 'employee-password-section' ? 'block' : 'none';
        document.getElementById('position-password-section').style.display = sectionId === 'position-password-section' ? 'block' : 'none';
        
        if (sectionId === 'employee-password-section') {
          loadEmployees();
          if (!localStorage.getItem('employeeGuideSeen')) {
            currentGuideType = 'employee';
            startGuide();
          }
        } else if (sectionId === 'position-password-section') {
          loadPositions();
          loadPositionPasswords();
          if (!localStorage.getItem('positionGuideSeen')) {
            currentGuideType = 'position';
            startGuide();
          }
        }
      } catch (error) {
        console.error('Error showing section:', error);
        showMessage('Error al cargar la sección', 'error');
      }
    }

    // Guide Definitions
    const employeeGuideSteps = [
      {
        elementId: 'employeeSearch',
        description: 'Escribe el nombre, posición o código del colaborador para buscarlo en la lista.',
        guideIcon: 'fa-search'
      },
      {
        elementId: 'employeeList',
        subSelector: '.employee-name',
        description: 'Selecciona el nombre de un colaborador de la lista para asignarle o modificar su contraseña.',
        guideIcon: 'fa-user'
      },
      {
        elementId: 'generateRandomBtn',
        description: 'Haz clic aquí para generar una contraseña aleatoria de 6 dígitos.',
        guideIcon: 'fa-random'
      },
      {
        elementId: 'openNumpadBtn',
        description: 'Abre el teclado numérico para ingresar una contraseña manualmente.',
        guideIcon: 'fa-keyboard',
        action: () => {
          if (!selectedEmployee && allEmployees.length > 0) {
            selectEmployee(allEmployees[0]);
          }
          document.getElementById('numpadModal').style.display = 'block';
        }
      },
      {
        elementId: 'numpadModal',
        subSelector: '.numpad-btn[data-digit="1"]',
        description: 'Usa los botones numéricos para ingresar una contraseña de 6 dígitos.',
        guideIcon: 'fa-1'
      },
      {
        elementId: 'numpadModal',
        subSelector: '#numpadClearBtn',
        description: 'Haz clic aquí para borrar la contraseña ingresada.',
        guideIcon: 'fa-backspace'
      },
      {
        elementId: 'numpadModal',
        subSelector: '#numpadSaveBtn',
        description: 'Guarda la contraseña ingresada para el colaborador seleccionado.',
        guideIcon: 'fa-save',
        action: () => document.getElementById('numpadModal').style.display = 'none'
      },
      {
        elementId: 'copyPasswordBtn',
        description: 'Copia la contraseña actual al portapapeles para compartirla.',
        guideIcon: 'fa-copy'
      },
      {
        elementId: 'downloadCsvBtn',
        description: 'Descarga un archivo CSV con todas las contraseñas de los colaboradores.',
        guideIcon: 'fa-file-csv'
      },
      {
        elementId: 'downloadJpgBtn',
        description: 'Descarga una imagen JPG con la contraseña del colaborador seleccionado.',
        guideIcon: 'fa-file-image'
      }
    ];

    const positionGuideSteps = [
      {
        elementId: 'positionSelect',
        description: 'Selecciona una posición de la lista para asignarle una contraseña.',
        guideIcon: 'fa-briefcase'
      },
      {
        elementId: 'positionPasswordDisplay',
        description: 'Aquí se muestra la contraseña ingresada. Haz clic para alternar visibilidad o copiar.',
        guideIcon: 'fa-lock'
      },
      {
        elementId: 'togglePositionPasswordBtn',
        description: 'Muestra u oculta la contraseña ingresada.',
        guideIcon: 'fa-eye'
      },
      {
        elementId: 'copyPositionPasswordBtn',
        description: 'Copia la contraseña actual al portapapeles.',
        guideIcon: 'fa-copy'
      },
      {
        elementId: 'positionNumpad',
        subSelector: '.numpad-btn[data-digit="1"]',
        description: 'Usa los botones numéricos para ingresar una contraseña de 4 a 6 dígitos.',
        guideIcon: 'fa-1'
      },
      {
        elementId: 'positionBackspaceBtn',
        description: 'Elimina el último dígito de la contraseña ingresada.',
        guideIcon: 'fa-backspace'
      },
      {
        elementId: 'positionClearBtn',
        description: 'Borra toda la contraseña ingresada.',
        guideIcon: 'fa-trash'
      },
      {
        elementId: 'positionSaveBtn',
        description: 'Guarda la contraseña para la posición seleccionada.',
        guideIcon: 'fa-save'
      },
      {
        elementId: 'printAllBtn',
        description: 'Imprime todas las contraseñas asignadas a las posiciones.',
        guideIcon: 'fa-print'
      },
      {
        elementId: 'positionsList',
        description: 'Aquí se muestran las contraseñas asignadas. Puedes verlas o eliminarlas.',
        guideIcon: 'fa-list-check'
      }
    ];

    // Guide Logic
    function startGuide() {
      const overlay = document.getElementById('guideOverlay');
      overlay.style.display = 'block';
      // Disable scrolling
      document.body.style.overflow = 'hidden';
      currentGuideStep = 0;
      showGuideStep(currentGuideStep);
    }

    function showGuideStep(stepIndex) {
      const steps = currentGuideType === 'employee' ? employeeGuideSteps : positionGuideSteps;
      const step = steps[stepIndex];
      if (!step) {
        endGuide();
        return;
      }

      if (step.action) {
        step.action();
      }

      let element = document.getElementById(step.elementId);
      if (step.subSelector) {
        element = document.querySelector(step.subSelector) || element.querySelector(step.subSelector);
      }

      if (!element || element.offsetParent === null) {
        currentGuideStep++;
        showGuideStep(currentGuideStep);
        return;
      }

      // Scroll the element into view
      element.scrollIntoView({ behavior: 'smooth', block: 'center' });

      const rect = element.getBoundingClientRect();
      const magnifier = document.getElementById('guideMagnifier');
      const description = document.getElementById('guideDescription');
      const nextBtn = document.getElementById('guideNextBtn');

      if (stepIndex === steps.length - 1) {
        nextBtn.innerHTML = '<i class="fas fa-check"></i> Finalizar';
      } else {
        nextBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Siguiente';
      }

      const isSmallElement = rect.width < 100 || rect.height < 50;
      const baseSize = window.innerWidth <= 600 ? (isSmallElement ? 80 : 100) : (isSmallElement ? 100 : 150);
      const magnifierSize = Math.min(baseSize, Math.max(rect.width, rect.height) * 1.5);
      magnifier.style.width = `${magnifierSize}px`;
      magnifier.style.height = `${magnifierSize}px`;

      // Use viewport coordinates (getBoundingClientRect) since scrolling is disabled
      let magnifierLeft = rect.left + rect.width / 2 - magnifierSize / 2;
      let magnifierTop = rect.top + rect.height / 2 - magnifierSize / 2;

      magnifierLeft = Math.max(5, Math.min(magnifierLeft, window.innerWidth - magnifierSize - 5));
      magnifierTop = Math.max(5, Math.min(magnifierTop, window.innerHeight - magnifierSize - 5));

      magnifier.style.left = `${magnifierLeft}px`;
      magnifier.style.top = `${magnifierTop}px`;
      magnifier.style.display = 'block';

      description.innerHTML = `<i class="fas ${step.guideIcon}"></i> ${step.description}`;
      description.style.display = 'none';

      description.style.visibility = 'hidden';
      description.style.display = 'flex';
      const descRect = description.getBoundingClientRect();
      description.style.visibility = 'visible';

      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      const magnifierCenterX = magnifierLeft + magnifierSize / 2;
      const magnifierCenterY = magnifierTop + magnifierSize / 2;
      const margin = 10;

      const positions = [
        {
          name: 'bottom',
          top: magnifierTop + magnifierSize + margin,
          left: magnifierCenterX - descRect.width / 2,
          fits: magnifierTop + magnifierSize + margin + descRect.height <= viewportHeight &&
                magnifierCenterX - descRect.width / 2 >= 5 &&
                magnifierCenterX + descRect.width / 2 <= viewportWidth
        },
        {
          name: 'top',
          top: magnifierTop - descRect.height - margin,
          left: magnifierCenterX - descRect.width / 2,
          fits: magnifierTop - descRect.height - margin >= 0 &&
                magnifierCenterX - descRect.width / 2 >= 5 &&
                magnifierCenterX + descRect.width / 2 <= viewportWidth
        },
        {
          name: 'right',
          top: magnifierCenterY - descRect.height / 2,
          left: magnifierLeft + magnifierSize + margin,
          fits: magnifierLeft + magnifierSize + margin + descRect.width <= viewportWidth &&
                magnifierCenterY - descRect.height / 2 >= 5 &&
                magnifierCenterY + descRect.height / 2 <= viewportHeight
        },
        {
          name: 'left',
          top: magnifierCenterY - descRect.height / 2,
          left: magnifierLeft - descRect.width - margin,
          fits: magnifierLeft - descRect.width - margin >= 0 &&
                magnifierCenterY - descRect.height / 2 >= 5 &&
                magnifierCenterY + descRect.height / 2 <= viewportHeight
        }
      ];

      let bestPosition = positions.find(pos => pos.fits) || positions[0];

      let descLeft = Math.max(5, Math.min(bestPosition.left, viewportWidth - descRect.width - 5));
      let descTop = Math.max(5, Math.min(bestPosition.top, viewportHeight - descRect.height - 5));

      if (descLeft + descRect.width > viewportWidth) {
        description.style.maxWidth = `${viewportWidth - 10}px`;
      } else {
        description.style.maxWidth = '80vw';
      }

      description.style.left = `${descLeft}px`;
      description.style.top = `${descTop}px`;
      description.style.display = 'flex';

      document.querySelectorAll('.guide-highlight').forEach(el => el.classList.remove('guide-highlight'));
      element.classList.add('guide-highlight');
    }

    document.getElementById('guideNextBtn').addEventListener('click', function() {
      currentGuideStep++;
      showGuideStep(currentGuideStep);
    });

    document.getElementById('guideSkipBtn').addEventListener('click', endGuide);

    function endGuide() {
      document.getElementById('guideOverlay').style.display = 'none';
      document.getElementById('guideMagnifier').style.display = 'none';
      document.getElementById('guideDescription').style.display = 'none';
      document.querySelectorAll('.guide-highlight').forEach(el => el.classList.remove('guide-highlight'));
      document.getElementById('numpadModal').style.display = 'none';
      // Re-enable scrolling
      document.body.style.overflow = 'auto';
      if (currentGuideType === 'employee') {
        localStorage.setItem('employeeGuideSeen', 'true');
      } else if (currentGuideType === 'position') {
        localStorage.setItem('positionGuideSeen', 'true');
      }
      currentGuideStep = 0;
      currentGuideType = '';
    }

    // Employee Password Section Logic
    async function loadEmployees() {
      try {
        const schedulesQuery = await getDocs(collection(db, "Horarios"));
        const employees = [];

        schedulesQuery.forEach((doc) => {
          const data = doc.data();
          if (data.employeeName) {
            employeeDetails[data.employeeName] = {
              position: data.employeePosition || 'No especificada',
              code: data.employeeCode || 'No especificado'
            };
            if (!employees.includes(data.employeeName)) {
              employees.push(data.employeeName);
            }
          }
        });

        const passwordsRef = doc(db, "Configuraciones", "PasswordsColaboradores");
        const passwordsSnap = await getDoc(passwordsRef);

        if (passwordsSnap.exists()) {
          employeePasswords = passwordsSnap.data();
        }

        allEmployees = employees.sort();
        displayEmployeeList();
      } catch (error) {
        console.error("Error al cargar colaboradores:", error);
        showMessage('Error al cargar la lista de colaboradores', 'error');
      }
    }

    function displayEmployeeList() {
      const employeeList = document.getElementById('employeeList');
      employeeList.innerHTML = '';

      allEmployees.forEach(employee => {
        const details = employeeDetails[employee] || {};
        const password = employeePasswords[employee] || 'Sin contraseña';

        const employeeItem = document.createElement('div');
        employeeItem.className = 'employee-item';
        employeeItem.onclick = () => selectEmployee(employee);

        const employeeInfo = document.createElement('div');
        employeeInfo.className = 'employee-info';

        const nameElement = document.createElement('div');
        nameElement.className = 'employee-name';
        nameElement.textContent = employee;

        const detailsElement = document.createElement('div');
        detailsElement.className = 'employee-details';
        detailsElement.innerHTML = `
          <span><i class="fas fa-briefcase"></i> ${details.position}</span>
          <span><i class="fas fa-id-card"></i> ${details.code}</span>
        `;

        employeeInfo.appendChild(nameElement);
        employeeInfo.appendChild(detailsElement);

        const passwordElement = document.createElement('div');
        passwordElement.className = 'employee-password';
        passwordElement.innerHTML = `<i class="fas fa-key"></i> ${password}`;
        passwordElement.onclick = (e) => {
          e.stopPropagation();
          copyToClipboard(password, `Contraseña de ${employee} copiada`);
        };

        employeeItem.appendChild(employeeInfo);
        employeeItem.appendChild(passwordElement);
        employeeList.appendChild(employeeItem);
      });
    }

    document.getElementById('employeeSearch').addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const employeeItems = document.querySelectorAll('.employee-item');

      employeeItems.forEach(item => {
        const name = item.querySelector('.employee-name').textContent.toLowerCase();
        const details = item.querySelector('.employee-details').textContent.toLowerCase();
        const password = item.querySelector('.employee-password').textContent.toLowerCase();

        if (name.includes(searchTerm) || details.includes(searchTerm) || password.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    });

    function selectEmployee(employee) {
      document.querySelectorAll('.employee-item').forEach(item => {
        item.classList.remove('selected');
      });

      const items = document.querySelectorAll('.employee-item');
      for (let item of items) {
        if (item.querySelector('.employee-name').textContent === employee) {
          item.classList.add('selected');
          break;
        }
      }

      selectedEmployee = employee;
      employeeCurrentPassword = employeePasswords[employee] || '';

      document.getElementById('passwordSection').style.display = 'block';
      document.getElementById('selectedEmployeeName').textContent = `Colaborador: ${employee}`;
      updateEmployeePasswordDisplay();

      if (employeeCurrentPassword) {
        showMessage('Este colaborador ya tiene una contraseña asignada', 'success');
      } else {
        showMessage('Este colaborador no tiene contraseña asignada', 'warning');
      }
    }

    function updateEmployeePasswordDisplay() {
      const display = document.getElementById('passwordDisplay');
      if (employeeCurrentPassword) {
        display.textContent = employeeCurrentPassword;
        display.style.fontWeight = 'bold';
        display.style.letterSpacing = '3px';
      } else {
        display.textContent = 'Ingrese una contraseña';
        display.style.fontWeight = 'normal';
        display.style.letterSpacing = 'normal';
      }
    }

    window.appendEmployeePassword = function(digit) {
      if (employeeCurrentPassword.length < 6) {
        employeeCurrentPassword += digit;
        updateEmployeePasswordDisplay();
      }
    };

    window.clearEmployeePassword = function() {
      employeeCurrentPassword = '';
      updateEmployeePasswordDisplay();
      document.getElementById('numpadModal').style.display = 'none';
    };

    window.openNumpadForPassword = function() {
      if (!selectedEmployee) {
        showMessage('Por favor seleccione un colaborador primero', 'error');
        return;
      }
      document.getElementById('numpadModal').style.display = 'block';
    };

    document.getElementById('generateRandomBtn').addEventListener('click', function() {
      if (!selectedEmployee) {
        showMessage('Por favor seleccione un colaborador primero', 'error');
        return;
      }
      employeeCurrentPassword = Math.floor(100000 + Math.random() * 900000).toString();
      updateEmployeePasswordDisplay();
      showMessage('Contraseña generada automáticamente', 'success');
    });

    document.getElementById('openNumpadBtn').addEventListener('click', function() {
      if (!selectedEmployee) {
        showMessage('Por favor seleccione un colaborador primero', 'error');
        return;
      }
      document.getElementById('numpadModal').style.display = 'block';
    });

    window.saveEmployeePassword = async function() {
      if (!selectedEmployee) {
        showMessage('Por favor seleccione un colaborador primero', 'error');
        return;
      }

      if (employeeCurrentPassword.length !== 6) {
        showMessage('La contraseña debe tener exactamente 6 dígitos', 'error');
        return;
      }

      try {
        employeePasswords[selectedEmployee] = employeeCurrentPassword;
        await setDoc(doc(db, "Configuraciones", "PasswordsColaboradores"), employeePasswords);

        const employeeItems = document.querySelectorAll('.employee-item');
        for (let item of employeeItems) {
          if (item.querySelector('.employee-name').textContent === selectedEmployee) {
            item.querySelector('.employee-password').innerHTML = `<i class="fas fa-key"></i> ${employeeCurrentPassword}`;
            break;
          }
        }

        showMessage('Contraseña guardada exitosamente', 'success');
        document.getElementById('numpadModal').style.display = 'none';
      } catch (error) {
        console.error("Error al guardar contraseña:", error);
        showMessage('Error al guardar la contraseña', 'error');
      }
    };

    document.getElementById('copyPasswordBtn').addEventListener('click', function() {
      if (!employeeCurrentPassword) {
        showMessage('No hay contraseña para copiar', 'error');
        return;
      }
      copyToClipboard(employeeCurrentPassword, 'Contraseña copiada al portapapeles');
    });

    document.getElementById('downloadCsvBtn').addEventListener('click', function() {
      if (Object.keys(employeePasswords).length === 0) {
        showMessage('No hay contraseñas para exportar', 'error');
        return;
      }

      let csvContent = "Nombre,Posición,Código,Contraseña\n";
      allEmployees.forEach(employee => {
        const details = employeeDetails[employee] || {};
        const password = employeePasswords[employee] || '';
        csvContent += `"${employee}","${details.position}","${details.code}","${password}"\n`;
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'contraseñas_colaboradores.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showMessage('Archivo CSV generado para descargar', 'success');
    });

    document.getElementById('downloadJpgBtn').addEventListener('click', async function() {
      if (!selectedEmployee || !employeeCurrentPassword) {
        showMessage('Seleccione un colaborador y asegúrese de que tenga una contraseña', 'error');
        return;
      }

      try {
        const tempDiv = document.createElement('div');
        tempDiv.style.background = 'linear-gradient(135deg, #1a2a38, #2c3e50)';
        tempDiv.style.padding = '30px';
        tempDiv.style.borderRadius = '12px';
        tempDiv.style.maxWidth = '600px';
        tempDiv.style.margin = '0 auto';
        tempDiv.style.boxShadow = '0 0 20px rgba(0, 255, 204, 0.5)';
        tempDiv.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        tempDiv.style.color = 'white';

        const title = document.createElement('h1');
        title.textContent = 'Contraseña del Colaborador';
        title.style.color = '#15a086';
        title.style.textAlign = 'center';
        title.style.marginBottom = '20px';
        title.style.textShadow = '0 0 10px #00ffcc';
        tempDiv.appendChild(title);

        const content = document.createElement('div');
        content.style.textAlign = 'center';
        content.style.fontSize = '1.2rem';
        content.style.padding = '20px';
        content.style.background = 'rgba(255, 255, 255, 0.1)';
        content.style.borderRadius = '8px';
        content.innerHTML = `
          <p><strong>Colaborador:</strong> ${selectedEmployee}</p>
          <p><strong>Posición:</strong> ${employeeDetails[selectedEmployee]?.position || 'No especificada'}</p>
          <p><strong>Código:</strong> ${employeeDetails[selectedEmployee]?.code || 'No especificado'}</p>
          <p><strong>Contraseña:</strong> <span style="font-size: 1.5rem; letter-spacing: 3px;">${employeeCurrentPassword}</span></p>
        `;
        tempDiv.appendChild(content);

        const footer = document.createElement('div');
        footer.textContent = `Generado el ${new Date().toLocaleDateString()} a las ${new Date().toLocaleTimeString()}`;
        footer.style.textAlign = 'right';
        footer.style.marginTop = '20px';
        footer.style.fontSize = '0.8rem';
        footer.style.color = '#bdc3c7';
        tempDiv.appendChild(footer);

        document.body.appendChild(tempDiv);

        const canvas = await html2canvas(tempDiv, {
          backgroundColor: null,
          scale: 2
        });

        document.body.removeChild(tempDiv);

        const link = document.createElement('a');
        link.download = `contraseña_${selectedEmployee}.jpg`;
        link.href = canvas.toDataURL('image/jpeg', 0.9);
        link.click();

        showMessage('Imagen JPG generada para descargar', 'success');
      } catch (error) {
        console.error('Error al generar JPG:', error);
        showMessage('Error al generar la imagen JPG', 'error');
      }
    });

    document.getElementById('clearPasswordBtn').addEventListener('click', clearEmployeePassword);

    // Position Password Section Logic
    function updatePositionPasswordDisplay() {
      const passwordText = document.getElementById('positionPasswordText');
      if (showPositionPasswordText) {
        passwordText.textContent = positionCurrentPassword;
      } else {
        passwordText.textContent = '•'.repeat(positionCurrentPassword.length);
      }
    }

    window.togglePositionPasswordVisibility = function() {
      showPositionPasswordText = !showPositionPasswordText;
      updatePositionPasswordDisplay();
      const eyeIcon = document.getElementById('togglePositionPasswordBtn').querySelector('i');
      eyeIcon.className = showPositionPasswordText ? 'fas fa-eye-slash' : 'fas fa-eye';
    }

    window.appendPositionPassword = function(digit) {
      if (positionCurrentPassword.length < 6) {
        positionCurrentPassword += digit;
        updatePositionPasswordDisplay();
      }
    }

    window.backspacePositionPassword = function() {
      if (positionCurrentPassword.length > 0) {
        positionCurrentPassword = positionCurrentPassword.slice(0, -1);
        updatePositionPasswordDisplay();
      }
    }

    window.clearPositionPassword = function() {
      positionCurrentPassword = '';
      updatePositionPasswordDisplay();
    }

    window.copyPositionPassword = function() {
      if (positionCurrentPassword.length === 0) {
        showMessage('No hay contraseña para copiar', 'error');
        return;
      }

      navigator.clipboard.writeText(positionCurrentPassword).then(() => {
        showMessage('Contraseña copiada al portapapeles', 'success');
      }).catch(err => {
        console.error('Error al copiar:', err);
        showMessage('Error al copiar contraseña', 'error');
      });
    }

    async function loadPositions() {
      try {
        const querySnapshot = await getDocs(collection(db, "Horarios"));
        const positions = new Set();

        querySnapshot.forEach(doc => {
          const data = doc.data();
          if (data.employeePosition) positions.add(data.employeePosition);
        });

        const select = document.getElementById('positionSelect');
        select.innerHTML = '<option value="">-- Seleccione una posición --</option>';

        Array.from(positions).sort().forEach(position => {
          const option = document.createElement('option');
          option.value = position;
          option.textContent = position;
          select.appendChild(option);
        });
      } catch (error) {
        console.error("Error al cargar posiciones:", error);
        showMessage('Error al cargar posiciones', 'error');
      }
    }

    async function loadPositionPasswords() {
      try {
        const docRef = doc(db, "Configuraciones", "PasswordsPosiciones");
        const docSnap = await getDoc(docRef);

        positionPasswords = docSnap.exists() ? docSnap.data() : {};
        updatePositionsList();
      } catch (error) {
        console.error("Error al cargar contraseñas:", error);
        showMessage('Error al cargar contraseñas', 'error');
      }
    }

    function updatePositionsList() {
      const container = document.getElementById('positionsList');
      container.innerHTML = '';

      if (Object.keys(positionPasswords).length === 0) {
        container.innerHTML = '<p>No hay contraseñas configuradas aún.</p>';
        return;
      }

      Object.entries(positionPasswords).forEach(([position, password]) => {
        const item = document.createElement('div');
        item.className = 'position-item';

        item.innerHTML = `
          <div class="hidden-actions">
            <button class="hidden-btn copy-all-btn" onclick="copyPositionData('${position}', '${password}')" title="Copiar datos">
              <i class="fas fa-copy"></i>
            </button>
          </div>
          <div class="position-info">
            <div class="position-name">${position}</div>
            <div class="position-password">••••••</div>
          </div>
          <div class="position-actions">
            <button class="action-btn view-btn" onclick="showPositionPassword('${position}', '${password}')">
              <i class="fas fa-eye"></i> Ver
            </button>
            <button class="action-btn delete-btn" onclick="deletePositionPassword('${position}')">
              <i class="fas fa-trash"></i> Eliminar
            </button>
          </div>
        `;

        container.appendChild(item);
      });
    }

    window.showPositionPassword = function(position, password) {
      Swal.fire({
        title: `Contraseña para ${position}`,
        html: `
          <div style="font-size: 1.5rem; letter-spacing: 3px; margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.1); border-radius: 8px; position: relative;">
            ${password}
            <button onclick="copyToClipboard('${password}')" 
              style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #15a086; cursor: pointer;">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        `,
        icon: 'info',
        confirmButtonColor: '#15a086',
        showCancelButton: true,
        cancelButtonText: 'Cerrar',
        confirmButtonText: 'Copiar',
        cancelButtonColor: '#e74c3c',
        focusConfirm: false,
        preConfirm: () => {
          return copyToClipboard(password);
        }
      });
    }

    window.copyPositionData = function(position, password) {
      const text = `Posición: ${position}\nContraseña: ${password}`;
      navigator.clipboard.writeText(text).then(() => {
        showMessage('Datos copiados al portapapeles', 'success');
      }).catch(err => {
        console.error('Error al copiar:', err);
        showMessage('Error al copiar datos', 'error');
      });
    }

    window.printAllPositionPasswords = function() {
      if (Object.keys(positionPasswords).length === 0) {
        showMessage('No hay contraseñas para imprimir', 'error');
        return;
      }

      let printContent = `
        <div style="padding: 20px; font-family: Arial, sans-serif;">
          <h1 style="color: #15a086; text-align: center;">Contraseñas por Posición</h1>
          <p style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">
            Generado el ${new Date().toLocaleDateString()} a las ${new Date().toLocaleTimeString()}
          </p>
          <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
              <tr style="background-color: #15a086; color: white;">
                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Posición</th>
                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Contraseña</th>
              </tr>
            </thead>
            <tbody>
      `;

      Object.entries(positionPasswords).forEach(([position, password]) => {
        printContent += `
          <tr style="border-bottom: 1px solid #ddd;">
            <td style="padding: 12px; border: 1px solid #ddd;">${position}</td>
            <td style="padding: 12px; border: 1px solid #ddd; font-family: monospace; letter-spacing: 2px;">${password}</td>
          </tr>
        `;
      });

      printContent += `
            </tbody>
          </table>
        </div>
      `;

      const win = window.open('', '_blank');
      win.document.write(printContent);
      win.document.close();
      win.focus();
      setTimeout(() => {
        win.print();
        win.close();
      }, 500);
    }

    window.savePositionPassword = async function() {
      const position = document.getElementById('positionSelect').value;

      if (!position) {
        showMessage('Seleccione una posición', 'error');
        return;
      }

      if (positionCurrentPassword.length < 4 || positionCurrentPassword.length > 6) {
        showMessage('La contraseña debe tener 4-6 dígitos', 'error');
        return;
      }

      try {
        positionPasswords[position] = positionCurrentPassword;
        await setDoc(doc(db, "Configuraciones", "PasswordsPosiciones"), positionPasswords);

        showMessage(`Contraseña guardada para ${position}`, 'success');
        positionCurrentPassword = '';
        showPositionPasswordText = false;
        updatePositionPasswordDisplay();
        document.getElementById('togglePositionPasswordBtn').querySelector('i').className = 'fas fa-eye';
        updatePositionsList();
      } catch (error) {
        console.error("Error al guardar:", error);
        showMessage('Error al guardar contraseña', 'error');
      }
    }

    window.deletePositionPassword = async function(position) {
      const result = await Swal.fire({
        title: `¿Eliminar contraseña para ${position}?`,
        text: "Esta acción no se puede deshacer",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#15a086',
        cancelButtonColor: '#e74c3c',
        confirmButtonText: 'Sí, eliminar'
      });

      if (result.isConfirmed) {
        try {
          delete positionPasswords[position];
          await setDoc(doc(db, "Configuraciones", "PasswordsPosiciones"), positionPasswords);
          showMessage('Contraseña eliminada', 'success');
          updatePositionsList();
        } catch (error) {
          console.error("Error al eliminar:", error);
          showMessage('Error al eliminar contraseña', 'error');
        }
      }
    }

    function copyToClipboard(text, successMessage) {
      navigator.clipboard.writeText(text).then(() => {
        showMessage(successMessage, 'success');
      }).catch(err => {
        console.error('Error al copiar:', err);
        showMessage('Error al copiar al portapapeles', 'error');
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists() && userDoc.data().tipoUsuario === 'admin') {
            document.getElementById('authSection').style.display = 'block';
          } else {
            showMessage('Acceso solo para administradores', 'error');
            setTimeout(() => window.location.href = "index.html", 3000);
          }
        } else {
          window.location.href = "login.html";
        }
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Futurista</title>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <!-- SweetAlert2 para notificaciones -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <style>
    :root {
      --primary: #00f7ff;
      --secondary: #7b2dff;
      --dark: #0a0a1a;
      --light: #e0e0ff;
      --accent: #ff2d7b;
      --success: #00ff88;
      --info: #0095ff;
      --warning: #ffcc00;
      --danger: #ff4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      display: flex;
      height: 100vh;
      background-color: var(--dark);
      font-family: 'Orbitron', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      color: var(--light);
    }

    /* Efectos de fondo futurista */
    .glow-effect {
      position: fixed;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(123, 45, 255, 0.2) 0%, transparent 70%);
      filter: blur(50px);
      z-index: -1;
    }

    .glow-1 {
      top: -100px;
      left: -100px;
    }

    .glow-2 {
      bottom: -100px;
      right: -100px;
      background: radial-gradient(circle, rgba(0, 247, 255, 0.2) 0%, transparent 70%);
    }

    .container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    /* Ventana de usuarios */
    .user-list {
      width: 30%;
      background-color: rgba(20, 20, 40, 0.8);
      border-right: 1px solid rgba(0, 247, 255, 0.1);
      overflow-y: auto;
      padding: 20px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .user-list h2 {
      margin-bottom: 20px;
      font-size: 24px;
      color: var(--primary);
      text-shadow: 0 0 10px var(--primary);
      letter-spacing: 1px;
    }

    .user-list ul {
      list-style: none;
      padding: 0;
    }

    .user-list li {
      display: flex;
      align-items: center;
      padding: 15px;
      border-radius: 12px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: all 0.3s ease;
      position: relative;
      background-color: rgba(30, 30, 60, 0.5);
      border: 1px solid rgba(0, 247, 255, 0.1);
    }

    .user-list li:hover {
      background-color: rgba(0, 247, 255, 0.2);
      transform: translateX(5px);
    }

    .user-list li.active {
      background-color: rgba(0, 247, 255, 0.3);
      border-left: 4px solid var(--primary);
    }

    .user-list img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
      border: 2px solid var(--primary);
      box-shadow: 0 0 10px var(--primary);
    }

    .user-list .unread {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 12px;
      height: 12px;
      background-color: var(--danger);
      border-radius: 50%;
      box-shadow: 0 0 5px var(--danger);
    }

    .user-list .user-info {
      flex: 1;
    }

    .user-list .user-name {
      font-weight: bold;
      margin-bottom: 3px;
    }

    .user-list .user-status {
      font-size: 12px;
      color: var(--primary);
      display: flex;
      align-items: center;
    }

    .user-list .typing-indicator {
      font-size: 12px;
      color: var(--success);
      font-style: italic;
    }

    .user-list .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--success);
      margin-right: 5px;
    }

    /* Ventana de chat */
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: rgba(10, 10, 30, 0.7);
      backdrop-filter: blur(10px);
    }

    /* Cabecera del chat */
    .chat-header {
      background-color: rgba(20, 20, 50, 0.8);
      color: var(--light);
      padding: 20px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid rgba(0, 247, 255, 0.1);
      position: relative;
    }

    .chat-header img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 15px;
      border: 2px solid var(--primary);
      box-shadow: 0 0 15px var(--primary);
      transition: all 0.3s ease;
    }

    .chat-header img:hover {
      transform: scale(1.1);
    }

    .chat-header span {
      font-size: 20px;
      font-weight: bold;
      color: var(--primary);
    }

    .chat-header .online-status {
      position: absolute;
      bottom: 15px;
      left: 65px;
      width: 12px;
      height: 12px;
      background-color: var(--success);
      border-radius: 50%;
      border: 2px solid var(--dark);
    }

    /* Mensajes del chat */
    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background-color: rgba(10, 10, 20, 0.5);
      display: flex;
      flex-direction: column;
    }

    .message {
      margin: 10px 0;
      max-width: 70%;
      padding: 15px;
      border-radius: 15px;
      position: relative;
      display: flex;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease-out;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message:hover {
      transform: scale(1.02);
    }

    .message.received {
      background: linear-gradient(135deg, rgba(0, 150, 136, 0.8), rgba(0, 100, 136, 0.8));
      text-align: left;
      margin-right: auto;
      color: white;
      border-top-left-radius: 5px;
    }

    .message.sent {
      background: linear-gradient(135deg, rgba(0, 200, 136, 0.8), rgba(0, 150, 200, 0.8));
      text-align: right;
      margin-left: auto;
      color: white;
      border-top-right-radius: 5px;
    }

    .message-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 10px;
      margin-top: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .message-image:hover {
      transform: scale(1.05);
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
      border: 2px solid var(--primary);
      align-self: flex-start;
    }

    .message-content {
      flex: 1;
    }

    .message-text {
      margin-bottom: 5px;
      line-height: 1.4;
    }

    .message-time {
      font-size: 0.7em;
      opacity: 0.8;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-top: 5px;
    }

    .message-actions {
      position: absolute;
      top: 5px;
      right: 5px;
      display: none;
    }

    .message:hover .message-actions {
      display: flex;
      gap: 5px;
    }

    .message-action {
      background-color: rgba(255, 255, 255, 0.2);
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .message-action:hover {
      background-color: var(--primary);
      transform: scale(1.1);
    }

    .seen-indicator {
      color: var(--info);
      margin-left: 5px;
    }

    /* Barra de entrada de mensaje */
    .chat-input-container {
      padding: 15px;
      background-color: rgba(20, 20, 50, 0.8);
      border-top: 1px solid rgba(0, 247, 255, 0.1);
      display: flex;
      align-items: center;
      position: relative;
    }

    .chat-input-tools {
      display: flex;
      gap: 10px;
      margin-right: 10px;
    }

    .chat-input-tools button {
      background-color: transparent;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: var(--primary);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .chat-input-tools button:hover {
      background-color: rgba(0, 247, 255, 0.2);
      transform: scale(1.1);
    }

    .chat-input {
      flex: 1;
      display: flex;
      align-items: center;
      background-color: rgba(30, 30, 60, 0.7);
      border-radius: 25px;
      padding: 5px 15px;
      border: 1px solid rgba(0, 247, 255, 0.2);
    }

    .chat-input textarea {
      flex: 1;
      resize: none;
      padding: 10px;
      border: none;
      background: transparent;
      color: var(--light);
      font-size: 1em;
      max-height: 120px;
      min-height: 40px;
      outline: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .chat-input textarea::placeholder {
      color: rgba(224, 224, 255, 0.5);
    }

    .chat-input button {
      background-color: var(--primary);
      color: var(--dark);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-left: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-input button:hover {
      background-color: var(--success);
      transform: scale(1.1);
    }

    /* Modal de vista previa de imagen */
    .image-preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .image-preview-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .image-preview-container {
      position: relative;
      max-width: 90%;
      max-height: 80%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .image-preview {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0, 247, 255, 0.3);
    }

    .image-preview-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .image-preview-btn {
      padding: 12px 25px;
      border-radius: 25px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
    }

    .image-preview-btn.send {
      background-color: var(--success);
      color: var(--dark);
    }

    .image-preview-btn.cancel {
      background-color: var(--danger);
      color: white;
    }

    .image-preview-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    /* Notificación de nuevo mensaje */
    .message-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: rgba(20, 20, 50, 0.9);
      border: 1px solid var(--primary);
      border-radius: 15px;
      padding: 15px;
      max-width: 300px;
      display: flex;
      align-items: center;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      transform: translateX(150%);
      transition: transform 0.3s ease;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .message-notification.show {
      transform: translateX(0);
    }

    .notification-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 15px;
      border: 2px solid var(--primary);
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--primary);
    }

    .notification-text {
      font-size: 14px;
      opacity: 0.9;
    }

    .notification-close {
      background: none;
      border: none;
      color: var(--light);
      font-size: 18px;
      cursor: pointer;
      margin-left: 10px;
    }

    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(10, 10, 30, 0.5);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--success);
    }

    /* Animaciones */
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    .pulse {
      animation: pulse 2s infinite ease-in-out;
    }

    /* Efecto de neón para títulos */
    .neon-text {
      text-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary), 0 0 20px var(--primary);
    }

    /* Modal de cámara */
    .camera-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .camera-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .camera-container {
      position: relative;
      width: 90%;
      max-width: 500px;
      height: 70vh;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(0, 247, 255, 0.3);
    }

    #camera-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      padding-bottom: 30px;
    }

    .camera-actions {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    .camera-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.2);
      border: 2px solid var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .camera-btn.capture {
      background-color: var(--danger);
      border-color: var(--danger);
      width: 70px;
      height: 70px;
    }

    .camera-btn:hover {
      transform: scale(1.1);
      background-color: var(--primary);
    }

    .camera-preview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }

    .camera-preview.active {
      display: block;
    }

    .camera-preview-actions {
      position: absolute;
      bottom: 20px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: var(--primary);
      color: var(--dark);
      border: none;
      border-radius: 50px;
      padding: 12px 25px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s;
      z-index: 1000;
      box-shadow: 0 0 15px var(--primary);
    }

    .back-button:hover {
      background-color: var(--success);
      transform: translateY(-3px);
    }
  </style>
</head>
<body>
  <!-- Efectos de fondo -->
  <div class="glow-effect glow-1"></div>
  <div class="glow-effect glow-2"></div>

  <!-- Botón de volver -->
  <button class="back-button" id="backButton">
    <i class="fas fa-arrow-left"></i> Volver
  </button>

  <div class="container">
    <!-- Ventana Izquierda: Lista de Usuarios -->
    <div class="user-list">  
      <h2 class="neon-text">Contactos</h2>
      <ul id="userList"></ul>
    </div>

    <!-- Ventana Derecha: Chat -->
    <div class="chat-window">
      <div class="chat-header">
        <img id="chatUserImage" src="https://firebasestorage.googleapis.com/v0/b/inventario-35d6b.appspot.com/o/RETOM%20COMPLETO%20(1).png?alt=media&token=55cc155d-a70b-463d-a723-6fb646cde75c" alt="Usuario">
        <span id="chatUserName">Chat Futurista</span>
        <div class="online-status"></div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-container">
        <div class="chat-input-tools">
          <button id="attachFileButton" title="Adjuntar archivo">
            <i class="fas fa-paperclip"></i>
          </button>
          <button id="openCameraButton" title="Abrir cámara">
            <i class="fas fa-camera"></i>
          </button>
        </div>
        <div class="chat-input">
          <textarea id="messageInput" placeholder="Escribe un mensaje..."></textarea>
          <button id="sendMessageButton">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de vista previa de imagen -->
  <div class="image-preview-modal" id="imagePreviewModal">
    <div class="image-preview-container">
      <img class="image-preview" id="imagePreview" src="" alt="Vista previa">
      <div class="image-preview-actions">
        <button class="image-preview-btn send" id="sendImageButton">
          <i class="fas fa-paper-plane"></i> Enviar
        </button>
        <button class="image-preview-btn cancel" id="cancelImageButton">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de cámara -->
  <div class="camera-modal" id="cameraModal">
    <div class="camera-container">
      <video id="camera-video" autoplay playsinline></video>
      <canvas id="camera-canvas" class="camera-preview"></canvas>
      <div class="camera-overlay">
        <div class="camera-actions">
          <button class="camera-btn" id="switchCameraButton">
            <i class="fas fa-sync-alt"></i>
          </button>
          <button class="camera-btn capture" id="captureButton">
            <i class="fas fa-camera"></i>
          </button>
          <button class="camera-btn" id="closeCameraButton">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="camera-preview-actions" id="cameraPreviewActions" style="display: none;">
        <button class="image-preview-btn send" id="sendPhotoButton">
          <i class="fas fa-check"></i> Enviar
        </button>
        <button class="image-preview-btn cancel" id="retakePhotoButton">
          <i class="fas fa-redo"></i> Volver a tomar
        </button>
      </div>
    </div>
  </div>

  <!-- Notificación de nuevo mensaje -->
  <div class="message-notification" id="messageNotification">
    <img class="notification-avatar" id="notificationAvatar" src="" alt="Usuario">
    <div class="notification-content">
      <div class="notification-title" id="notificationTitle"></div>
      <div class="notification-text" id="notificationText"></div>
    </div>
    <button class="notification-close" id="closeNotification">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      addDoc, 
      onSnapshot, 
      query, 
      orderBy, 
      doc, 
      updateDoc,
      serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { 
      getAuth, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { 
      getStorage, 
      ref, 
      uploadBytes, 
      getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
      authDomain: "inventario-35d6b.firebaseapp.com",
      projectId: "inventario-35d6b",
      storageBucket: "inventario-35d6b.appspot.com",
      messagingSenderId: "266100399659",
      appId: "1:266100399659:web:92358d28cbd803c8a7d46e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // Variables de estado
    let activeUser = null;
    let activeUserId = null;
    let activeChatId = null;
    let users = {};
    let cameraStream = null;
    let currentCameraFacing = 'environment'; // 'environment' (trasera) o 'user' (frontal)
    let selectedFile = null;
    let capturedPhoto = null;

    // Inicializar la aplicación cuando el usuario esté autenticado
    onAuthStateChanged(auth, (user) => {
      if (user) {
        activeUser = user.uid;
        loadUsers();
        setupMessageNotifications();
      } else {
        Swal.fire({
          title: 'Acceso requerido',
          text: 'Por favor, inicia sesión para usar el chat',
          icon: 'warning',
          confirmButtonText: 'Ir a login',
          background: '#1a1a2e',
          color: '#fff'
        }).then(() => {
          window.location.href = "index.html";
        });
      }
    });

    // Cargar lista de usuarios
    const loadUsers = async () => {
      const usersSnapshot = await getDocs(collection(db, "users"));
      const userList = document.getElementById("userList");
      userList.innerHTML = "";

      usersSnapshot.forEach((doc) => {
        const user = doc.data();
        const userId = doc.id;
        users[userId] = user;

        if (userId !== activeUser) {
          const li = document.createElement("li");
          li.dataset.userId = userId;
          
          const img = document.createElement("img");
          img.src = user.photoURL || "https://via.placeholder.com/40";
          img.alt = user.name;
          
          const userInfo = document.createElement("div");
          userInfo.className = "user-info";
          
          const userName = document.createElement("div");
          userName.className = "user-name";
          userName.textContent = user.name;
          
          const userStatus = document.createElement("div");
          userStatus.className = "user-status";
          
          const statusDot = document.createElement("div");
          statusDot.className = "status-dot";
          
          const statusText = document.createElement("span");
          statusText.textContent = "En línea";
          
          userStatus.appendChild(statusDot);
          userStatus.appendChild(statusText);
          
          const typingIndicator = document.createElement("div");
          typingIndicator.className = "typing-indicator";
          typingIndicator.style.display = "none";
          typingIndicator.textContent = "escribiendo...";
          
          userInfo.appendChild(userName);
          userInfo.appendChild(userStatus);
          userInfo.appendChild(typingIndicator);
          
          li.appendChild(img);
          li.appendChild(userInfo);
          
          // Indicador de mensajes no leídos
          const unreadIndicator = document.createElement("div");
          unreadIndicator.className = "unread";
          unreadIndicator.style.display = "none";
          li.appendChild(unreadIndicator);
          
          li.addEventListener("click", () => openChat(userId));
          userList.appendChild(li);
          
          // Escuchar cambios de estado de escritura
          listenForTyping(userId, typingIndicator);
          // Verificar mensajes no leídos
          checkUnreadMessages(userId, unreadIndicator);
        }
      });
    };

    // Abrir chat con un usuario
    const openChat = async (userId) => {
      activeUserId = userId;
      activeChatId = getChatId(activeUser, userId);
      
      const user = users[userId];
      document.getElementById("chatUserName").textContent = user.name;
      document.getElementById("chatUserImage").src = user.photoURL || "https://via.placeholder.com/40";
      
      // Marcar mensajes como leídos
      await markMessagesAsRead();
      
      // Ocultar indicador de no leídos
      const userItem = document.querySelector(`li[data-user-id="${userId}"] .unread`);
      if (userItem) {
        userItem.style.display = "none";
      }
      
      loadMessages();
    };

    // Marcar mensajes como leídos
    const markMessagesAsRead = async () => {
      if (!activeChatId) return;
      
      const messagesRef = collection(db, `chats/${activeChatId}/messages`);
      const q = query(messagesRef, orderBy("timestamp"));
      
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach(async (doc) => {
        const message = doc.data();
        if (message.sender === activeUserId && !message.read) {
          await updateDoc(doc.ref, {
            read: true,
            readTime: serverTimestamp()
          });
        }
      });
    };

    // Verificar mensajes no leídos
    const checkUnreadMessages = (userId, unreadIndicator) => {
      const chatId = getChatId(activeUser, userId);
      const messagesRef = collection(db, `chats/${chatId}/messages`);
      const q = query(messagesRef, orderBy("timestamp"));
      
      onSnapshot(q, (snapshot) => {
        let hasUnread = false;
        snapshot.forEach((doc) => {
          const message = doc.data();
          if (message.sender === userId && !message.read) {
            hasUnread = true;
          }
        });
        
        if (unreadIndicator) {
          unreadIndicator.style.display = hasUnread ? "block" : "none";
        }
      });
    };

    // Escuchar cambios de estado de escritura
    const listenForTyping = (userId, typingIndicator) => {
      const typingRef = doc(db, `typing/${getChatId(activeUser, userId)}`);
      
      onSnapshot(typingRef, (doc) => {
        const typingData = doc.data();
        if (typingData && typingData[userId] && typingData[userId].typing) {
          typingIndicator.style.display = "block";
        } else {
          typingIndicator.style.display = "none";
        }
      });
    };

    // Cargar mensajes del chat
    const loadMessages = () => {
      if (!activeChatId) return;
      
      const messagesQuery = query(
        collection(db, `chats/${activeChatId}/messages`), 
        orderBy("timestamp")
      );
      
      onSnapshot(messagesQuery, (snapshot) => {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = "";
        
        snapshot.forEach((doc) => {
          const message = doc.data();
          addMessageToChat(message, doc.id);
        });
        
        scrollToBottom();
      });
    };

    // Añadir mensaje al chat
    const addMessageToChat = (message, messageId) => {
      const chatMessages = document.getElementById("chatMessages");
      const isSent = message.sender === activeUser;
      
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
      messageDiv.dataset.messageId = messageId;
      
      const avatar = document.createElement("img");
      avatar.className = "message-avatar";
      avatar.src = isSent ? 
        (users[activeUser]?.photoURL || "https://via.placeholder.com/40") : 
        (users[activeUserId]?.photoURL || "https://via.placeholder.com/40");
      messageDiv.appendChild(avatar);
      
      const contentDiv = document.createElement("div");
      contentDiv.className = "message-content";
      
      if (message.text) {
        const textDiv = document.createElement("div");
        textDiv.className = "message-text";
        textDiv.textContent = message.text;
        contentDiv.appendChild(textDiv);
      }
      
      if (message.imageUrl) {
        const imgDiv = document.createElement("img");
        imgDiv.className = "message-image";
        imgDiv.src = message.imageUrl;
        imgDiv.alt = "Imagen enviada";
        
        // Agregar funcionalidad para abrir imagen en grande
        imgDiv.addEventListener("click", () => {
          Swal.fire({
            imageUrl: message.imageUrl,
            imageAlt: 'Imagen del chat',
            background: '#1a1a2e',
            showConfirmButton: false,
            showCloseButton: true
          });
        });
        
        contentDiv.appendChild(imgDiv);
      }
      
      const timeDiv = document.createElement("div");
      timeDiv.className = "message-time";
      
      const timestamp = message.timestamp?.toDate ? message.timestamp.toDate() : new Date();
      timeDiv.textContent = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      if (isSent && message.read) {
        const seenIcon = document.createElement("i");
        seenIcon.className = "fas fa-check-double seen-indicator";
        timeDiv.appendChild(seenIcon);
      }
      
      contentDiv.appendChild(timeDiv);
      
      // Acciones del mensaje (copiar, compartir)
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "message-actions";
      
      if (message.text) {
        const copyButton = document.createElement("button");
        copyButton.className = "message-action";
        copyButton.title = "Copiar mensaje";
        copyButton.innerHTML = '<i class="far fa-copy"></i>';
        copyButton.addEventListener("click", () => {
          navigator.clipboard.writeText(message.text).then(() => {
            Swal.fire({
              title: 'Copiado',
              text: 'El mensaje ha sido copiado al portapapeles',
              icon: 'success',
              timer: 1500,
              showConfirmButton: false,
              background: '#1a1a2e',
              color: '#fff'
            });
          });
        });
        actionsDiv.appendChild(copyButton);
      }
      
      if (message.imageUrl) {
        const shareButton = document.createElement("button");
        shareButton.className = "message-action";
        shareButton.title = "Compartir imagen";
        shareButton.innerHTML = '<i class="fas fa-share-alt"></i>';
        shareButton.addEventListener("click", () => shareImage(message.imageUrl));
        actionsDiv.appendChild(shareButton);
        
        const downloadButton = document.createElement("button");
        downloadButton.className = "message-action";
        downloadButton.title = "Descargar imagen";
        downloadButton.innerHTML = '<i class="fas fa-download"></i>';
        downloadButton.addEventListener("click", () => downloadImage(message.imageUrl));
        actionsDiv.appendChild(downloadButton);
      }
      
      messageDiv.appendChild(contentDiv);
      messageDiv.appendChild(actionsDiv);
      chatMessages.appendChild(messageDiv);
      
      // Animación para mensajes nuevos
      if (message.sender !== activeUser && !message.read) {
        messageDiv.style.animation = "pulse 2s";
        playNotificationSound();
      }
    };

    // Función para compartir imagen
    const shareImage = async (imageUrl) => {
      try {
        // Convertir la imagen a blob
        const response = await fetch(imageUrl);
        const blob = await response.blob();
        
        // Compartir usando la Web Share API
        if (navigator.share) {
          await navigator.share({
            title: 'Imagen del chat',
            files: [new File([blob], 'imagen-chat.jpg', { type: 'image/jpeg' })]
          });
        } else {
          // Fallback para navegadores que no soportan compartir archivos
          const a = document.createElement('a');
          a.href = imageUrl;
          a.download = 'imagen-chat.jpg';
          a.click();
          
          Swal.fire({
            title: 'Descargar imagen',
            text: 'La imagen se está descargando ya que tu navegador no soporta compartir directamente',
            icon: 'info',
            background: '#1a1a2e',
            color: '#fff'
          });
        }
      } catch (error) {
        console.error('Error al compartir imagen:', error);
        Swal.fire({
          title: 'Error',
          text: 'No se pudo compartir la imagen',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Función para descargar imagen
    const downloadImage = (imageUrl) => {
      const a = document.createElement('a');
      a.href = imageUrl;
      a.download = 'imagen-chat.jpg';
      a.click();
    };

    // Función para generar un ID único de chat
    const getChatId = (user1Id, user2Id) => {
      return user1Id < user2Id ? user1Id + user2Id : user2Id + user1Id;
    };

    // Enviar mensaje de texto
    const sendMessage = async (messageText) => {
      if (!messageText.trim() || !activeChatId) return;
      
      await addDoc(collection(db, `chats/${activeChatId}/messages`), {
        sender: activeUser,
        text: messageText,
        timestamp: serverTimestamp(),
        read: false
      });
      
      // Actualizar estado de escritura
      updateTypingStatus(false);
      
      document.getElementById("messageInput").value = "";
    };

    // Enviar imagen
    const sendImage = async (imageFile) => {
      if (!imageFile || !activeChatId) return;
      
      try {
        // Subir imagen a Firebase Storage
        const storageRef = ref(storage, `chat_images/${activeChatId}/${Date.now()}_${imageFile.name}`);
        const uploadTask = await uploadBytes(storageRef, imageFile);
        const downloadURL = await getDownloadURL(uploadTask.ref);
        
        // Guardar referencia en Firestore
        await addDoc(collection(db, `chats/${activeChatId}/messages`), {
          sender: activeUser,
          imageUrl: downloadURL,
          timestamp: serverTimestamp(),
          read: false
        });
        
        // Cerrar modal de vista previa
        document.getElementById("imagePreviewModal").classList.remove("active");
        selectedFile = null;
        
      } catch (error) {
        console.error("Error al enviar imagen:", error);
        Swal.fire({
          title: 'Error',
          text: 'No se pudo enviar la imagen',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Actualizar estado de "escribiendo"
    const updateTypingStatus = (isTyping) => {
      if (!activeChatId) return;
      
      const typingRef = doc(db, `typing/${activeChatId}`);
      updateDoc(typingRef, {
        [activeUser]: {
          typing: isTyping,
          timestamp: serverTimestamp()
        }
      });
    };

    // Configurar notificaciones de nuevos mensajes
    const setupMessageNotifications = () => {
      // Escuchar todos los chats del usuario
      const chatsQuery = query(collection(db, "chats"));
      
      onSnapshot(chatsQuery, (snapshot) => {
        snapshot.forEach((doc) => {
          const chatId = doc.id;
          
          // Verificar si este chat incluye al usuario actual
          if (chatId.includes(activeUser)) {
            const otherUserId = chatId.replace(activeUser, '');
            const messagesRef = collection(db, `chats/${chatId}/messages`);
            const q = query(messagesRef, orderBy("timestamp", "desc"), limit(1));
            
            onSnapshot(q, (messageSnapshot) => {
              messageSnapshot.forEach((messageDoc) => {
                const message = messageDoc.data();
                
                // Mostrar notificación si el mensaje es nuevo y no es del usuario actual
                if (message.sender !== activeUser && 
                    (!message.read || message.read === undefined)) {
                  showMessageNotification(otherUserId, message);
                }
              });
            });
          }
        });
      });
    };

    // Mostrar notificación de nuevo mensaje
    const showMessageNotification = (userId, message) => {
      const user = users[userId];
      if (!user) return;
      
      const notification = document.getElementById("messageNotification");
      const notificationAvatar = document.getElementById("notificationAvatar");
      const notificationTitle = document.getElementById("notificationTitle");
      const notificationText = document.getElementById("notificationText");
      
      notificationAvatar.src = user.photoURL || "https://via.placeholder.com/40";
      notificationTitle.textContent = user.name;
      notificationText.textContent = message.text || "Nueva imagen";
      
      notification.classList.add("show");
      playNotificationSound();
      
      // Cerrar automáticamente después de 5 segundos
      setTimeout(() => {
        notification.classList.remove("show");
      }, 5000);
    };

    // Reproducir sonido de notificación
    const playNotificationSound = () => {
      const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
      audio.play().catch(e => console.log("No se pudo reproducir sonido:", e));
    };

    // Desplazar el chat hacia abajo
    const scrollToBottom = () => {
      const chatMessages = document.getElementById("chatMessages");
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // Manejo del envío de mensaje
    document.getElementById("sendMessageButton").addEventListener("click", () => {
      const message = document.getElementById("messageInput").value;
      sendMessage(message);
    });

    // Enviar mensaje con Enter (pero no con Shift+Enter)
    document.getElementById("messageInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        const message = document.getElementById("messageInput").value;
        sendMessage(message);
      }
    });

    // Detectar cuando el usuario está escribiendo
    document.getElementById("messageInput").addEventListener("input", (e) => {
      if (e.target.value.length > 0) {
        updateTypingStatus(true);
      } else {
        updateTypingStatus(false);
      }
    });

    // Cerrar notificación
    document.getElementById("closeNotification").addEventListener("click", () => {
      document.getElementById("messageNotification").classList.remove("show");
    });

    // Botón de volver
    document.getElementById("backButton").addEventListener("click", () => {
      window.history.back();
    });

    // ========== Funcionalidad de adjuntar archivos ==========
    document.getElementById("attachFileButton").addEventListener("click", () => {
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*,.pdf,.doc,.docx,.txt";
      
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Verificar tipo de archivo
        if (file.type.startsWith("image/")) {
          selectedFile = file;
          showImagePreview(file);
        } else {
          // Para otros tipos de archivos (PDF, documentos, etc.)
          uploadAndSendFile(file);
        }
      });
      
      fileInput.click();
    });

    // Mostrar vista previa de imagen
    const showImagePreview = (file) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById("imagePreview").src = e.target.result;
        document.getElementById("imagePreviewModal").classList.add("active");
      };
      reader.readAsDataURL(file);
    };

    // Subir y enviar archivo (no imagen)
    const uploadAndSendFile = async (file) => {
      try {
        // Subir archivo a Firebase Storage
        const storageRef = ref(storage, `chat_files/${activeChatId}/${Date.now()}_${file.name}`);
        const uploadTask = await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(uploadTask.ref);
        
        // Guardar referencia en Firestore
        await addDoc(collection(db, `chats/${activeChatId}/messages`), {
          sender: activeUser,
          fileUrl: downloadURL,
          fileName: file.name,
          fileType: file.type,
          timestamp: serverTimestamp(),
          read: false
        });
        
        Swal.fire({
          title: 'Archivo enviado',
          text: `El archivo ${file.name} ha sido enviado`,
          icon: 'success',
          timer: 1500,
          showConfirmButton: false,
          background: '#1a1a2e',
          color: '#fff'
        });
        
      } catch (error) {
        console.error("Error al enviar archivo:", error);
        Swal.fire({
          title: 'Error',
          text: 'No se pudo enviar el archivo',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Enviar imagen desde vista previa
    document.getElementById("sendImageButton").addEventListener("click", () => {
      if (selectedFile) {
        sendImage(selectedFile);
      }
    });

    // Cancelar envío de imagen
    document.getElementById("cancelImageButton").addEventListener("click", () => {
      document.getElementById("imagePreviewModal").classList.remove("active");
      selectedFile = null;
    });

    // ========== Funcionalidad de cámara ==========
    document.getElementById("openCameraButton").addEventListener("click", () => {
      openCamera();
    });

    // Abrir cámara
    const openCamera = async () => {
      try {
        const constraints = {
          video: {
            facingMode: currentCameraFacing,
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        };
        
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById("camera-video");
        video.srcObject = cameraStream;
        
        document.getElementById("cameraModal").classList.add("active");
        document.getElementById("cameraPreviewActions").style.display = "none";
        
      } catch (error) {
        console.error("Error al acceder a la cámara:", error);
        Swal.fire({
          title: 'Error',
          text: 'No se pudo acceder a la cámara. Asegúrate de haber concedido los permisos.',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Capturar foto
    document.getElementById("captureButton").addEventListener("click", () => {
      const video = document.getElementById("camera-video");
      const canvas = document.getElementById("camera-canvas");
      const context = canvas.getContext('2d');
      
      // Ajustar tamaño del canvas al video
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      // Dibujar el frame actual en el canvas
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Mostrar vista previa
      document.getElementById("cameraPreviewActions").style.display = "flex";
      
      // Detener la transmisión de video
      cameraStream.getTracks().forEach(track => track.stop());
    });

    // Volver a tomar foto
    document.getElementById("retakePhotoButton").addEventListener("click", () => {
      openCamera();
    });

    // Enviar foto capturada
    document.getElementById("sendPhotoButton").addEventListener("click", async () => {
      const canvas = document.getElementById("camera-canvas");
      
      // Convertir canvas a blob
      canvas.toBlob(async (blob) => {
        try {
          // Crear archivo desde el blob
          const file = new File([blob], `foto-${Date.now()}.jpg`, { type: 'image/jpeg' });
          await sendImage(file);
          
          // Cerrar modal de cámara
          document.getElementById("cameraModal").classList.remove("active");
          capturedPhoto = null;
          
        } catch (error) {
          console.error("Error al enviar foto:", error);
          Swal.fire({
            title: 'Error',
            text: 'No se pudo enviar la foto',
            icon: 'error',
            background: '#1a1a2e',
            color: '#fff'
          });
        }
      }, 'image/jpeg', 0.9);
    });

    // Cambiar cámara
    document.getElementById("switchCameraButton").addEventListener("click", () => {
      currentCameraFacing = currentCameraFacing === 'user' ? 'environment' : 'user';
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      openCamera();
    });

    // Cerrar cámara
    document.getElementById("closeCameraButton").addEventListener("click", () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      document.getElementById("cameraModal").classList.remove("active");
    });

    // Limpieza al cerrar la página
    window.addEventListener('beforeunload', () => {
      // Detener transmisión de cámara si está activa
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      
      // Actualizar estado de escritura
      updateTypingStatus(false);
    });
  </script>
</body>
</html>

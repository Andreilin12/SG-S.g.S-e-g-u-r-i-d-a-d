<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Chat Futurista</title>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <!-- SweetAlert2 para notificaciones -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <style>
    :root {
      --primary: #00f7ff;
      --secondary: #7b2dff;
      --dark: #0a0a1a;
      --light: #e0e0ff;
      --accent: #ff2d7b;
      --success: #00ff88;
      --info: #0095ff;
      --warning: #ffcc00;
      --danger: #ff4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      display: flex;
      height: 100vh;
      background-color: var(--dark);
      font-family: 'Orbitron', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      color: var(--light);
    }

    /* Efectos de fondo futurista */
    .glow-effect {
      position: fixed;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(123, 45, 255, 0.2) 0%, transparent 70%);
      filter: blur(50px);
      z-index: -1;
    }

    .glow-1 {
      top: -100px;
      left: -100px;
    }

    .glow-2 {
      bottom: -100px;
      right: -100px;
      background: radial-gradient(circle, rgba(0, 247, 255, 0.2) 0%, transparent 70%);
    }

    .container {
      display: flex;
      width: 100%;
      height: 100%;
      flex-direction: column;
    }

    /* Ventana de usuarios */
    .user-list {
      width: 100%;
      background-color: rgba(20, 20, 40, 0.8);
      border-right: 1px solid rgba(0, 247, 255, 0.1);
      overflow-y: auto;
      padding: 20px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      display: none;
    }

    .user-list.active {
      display: block;
    }

    .user-list h2 {
      margin-bottom: 20px;
      font-size: 24px;
      color: var(--primary);
      text-shadow: 0 0 10px var(--primary);
      letter-spacing: 1px;
    }

    /* Buscador de usuarios */
    .user-search {
      position: relative;
      margin-bottom: 20px;
    }

    .user-search input {
      width: 100%;
      padding: 10px 15px 10px 40px;
      background-color: rgba(30, 30, 60, 0.7);
      border: 1px solid rgba(0, 247, 255, 0.2);
      border-radius: 25px;
      color: var(--light);
      outline: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .user-search i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
    }

    .user-list ul {
      list-style: none;
      padding: 0;
    }

    .user-list li {
      display: flex;
      align-items: center;
      padding: 15px;
      border-radius: 12px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: all 0.3s ease;
      position: relative;
      background-color: rgba(30, 30, 60, 0.5);
      border: 1px solid rgba(0, 247, 255, 0.1);
    }

    .user-list li:hover {
      background-color: rgba(0, 247, 255, 0.2);
      transform: translateX(5px);
    }

    .user-list li.active {
      background-color: rgba(0, 247, 255, 0.3);
      border-left: 4px solid var(--primary);
    }

    .user-list img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
      border: 2px solid var(--primary);
      box-shadow: 0 0 10px var(--primary);
    }

    .user-list .unread {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 12px;
      height: 12px;
      background-color: var(--danger);
      border-radius: 50%;
      box-shadow: 0 0 5px var(--danger);
    }

    .user-list .user-info {
      flex: 1;
    }

    .user-list .user-name {
      font-weight: bold;
      margin-bottom: 3px;
    }

    .user-list .user-status {
      font-size: 12px;
      color: var(--primary);
      display: flex;
      align-items: center;
    }

    .user-list .typing-indicator {
      font-size: 12px;
      color: var(--success);
      font-style: italic;
    }

    .user-list .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--success);
      margin-right: 5px;
    }

    .user-list .last-activity {
      font-size: 10px;
      color: rgba(224, 224, 255, 0.6);
      margin-top: 3px;
    }

    /* Ventana de chat */
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: rgba(10, 10, 30, 0.7);
      backdrop-filter: blur(10px);
      position: relative;
    }

    /* Cabecera del chat */
    .chat-header {
      background-color: rgba(20, 20, 50, 0.8);
      color: var(--light);
      padding: 15px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid rgba(0, 247, 255, 0.1);
      position: relative;
      z-index: 10;
    }

    .chat-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 15px;
      border: 2px solid var(--primary);
      box-shadow: 0 0 15px var(--primary);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .chat-header img:hover {
      transform: scale(1.1);
    }

    .chat-header span {
      font-size: 18px;
      font-weight: bold;
      color: var(--primary);
      cursor: pointer;
      flex: 1;
    }

    .chat-header .online-status {
      position: absolute;
      bottom: 10px;
      left: 55px;
      width: 12px;
      height: 12px;
      background-color: var(--success);
      border-radius: 50%;
      border: 2px solid var(--dark);
    }

    .chat-header .menu-button {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 1.5em;
      cursor: pointer;
      margin-left: 10px;
    }

    /* Mensajes del chat */
    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background-color: rgba(10, 10, 20, 0.5);
      display: flex;
      flex-direction: column;
      padding-bottom: 80px;
    }

    .message {
      margin: 10px 0;
      max-width: 80%;
      padding: 12px;
      border-radius: 15px;
      position: relative;
      display: flex;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease-out;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message:hover {
      transform: scale(1.02);
    }

    .message.received {
      background: linear-gradient(135deg, rgba(0, 150, 136, 0.8), rgba(0, 100, 136, 0.8));
      text-align: left;
      margin-right: auto;
      color: white;
      border-top-left-radius: 5px;
    }

    .message.sent {
      background: linear-gradient(135deg, rgba(0, 200, 136, 0.8), rgba(0, 150, 200, 0.8));
      text-align: right;
      margin-left: auto;
      color: white;
      border-top-right-radius: 5px;
    }

    .message-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 10px;
      margin-top: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .message-image:hover {
      transform: scale(1.05);
    }

    .message-audio {
      width: 100%;
      margin-top: 5px;
      border-radius: 10px;
      background-color: rgba(0, 0, 0, 0.3);
    }

    .message-video {
      max-width: 100%;
      max-height: 300px;
      border-radius: 10px;
      margin-top: 5px;
      cursor: pointer;
    }

    .message-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
      border: 2px solid var(--primary);
      align-self: flex-start;
    }

    .message-content {
      flex: 1;
    }

    .message-text {
      margin-bottom: 5px;
      line-height: 1.4;
    }

    .message-time {
      font-size: 0.7em;
      opacity: 0.8;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-top: 5px;
    }

    .message-actions {
      position: absolute;
      top: 5px;
      right: 5px;
      display: none;
    }

    .message:hover .message-actions {
      display: flex;
      gap: 5px;
    }

    .message-action {
      background-color: rgba(255, 255, 255, 0.2);
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .message-action:hover {
      background-color: var(--primary);
      transform: scale(1.1);
    }

    .seen-indicator {
      color: var(--info);
      margin-left: 5px;
    }

    /* Barra de entrada de mensaje */
    .chat-input-container {
      padding: 10px;
      background-color: rgba(20, 20, 50, 0.9);
      border-top: 1px solid rgba(0, 247, 255, 0.1);
      display: flex;
      align-items: center;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);
    }

    .chat-input-tools {
      display: flex;
      gap: 8px;
      margin-right: 8px;
    }

    .chat-input-tools button {
      background-color: transparent;
      border: none;
      font-size: 1.3em;
      cursor: pointer;
      color: var(--primary);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .chat-input-tools button:hover {
      background-color: rgba(0, 247, 255, 0.2);
      transform: scale(1.1);
    }

    .chat-input {
      flex: 1;
      display: flex;
      align-items: center;
      background-color: rgba(30, 30, 60, 0.7);
      border-radius: 25px;
      padding: 5px 12px;
      border: 1px solid rgba(0, 247, 255, 0.2);
    }

    .chat-input textarea {
      flex: 1;
      resize: none;
      padding: 8px;
      border: none;
      background: transparent;
      color: var(--light);
      font-size: 0.9em;
      max-height: 100px;
      min-height: 36px;
      outline: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .chat-input textarea::placeholder {
      color: rgba(224, 224, 255, 0.5);
    }

    .chat-input button {
      background-color: var(--primary);
      color: var(--dark);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-left: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-input button:hover {
      background-color: var(--success);
      transform: scale(1.1);
    }

    /* Modal de vista previa de imagen */
    .image-preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .image-preview-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .image-preview-container {
      position: relative;
      max-width: 90%;
      max-height: 80%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .image-preview {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0, 247, 255, 0.3);
    }

    .image-preview-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .image-preview-btn {
      padding: 10px 20px;
      border-radius: 25px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
    }

    .image-preview-btn.send {
      background-color: var(--success);
      color: var(--dark);
    }

    .image-preview-btn.cancel {
      background-color: var(--danger);
      color: white;
    }

    .image-preview-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    /* Notificación de nuevo mensaje */
    .message-notification {
      position: fixed;
      bottom: 70px;
      right: 10px;
      background-color: rgba(20, 20, 50, 0.9);
      border: 1px solid var(--primary);
      border-radius: 15px;
      padding: 12px;
      max-width: 280px;
      display: flex;
      align-items: center;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      transform: translateX(150%);
      transition: transform 0.3s ease;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .message-notification.show {
      transform: translateX(0);
    }

    .notification-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 12px;
      border: 2px solid var(--primary);
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--primary);
      font-size: 14px;
    }

    .notification-text {
      font-size: 12px;
      opacity: 0.9;
    }

    .notification-close {
      background: none;
      border: none;
      color: var(--light);
      font-size: 16px;
      cursor: pointer;
      margin-left: 8px;
    }

    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(10, 10, 30, 0.5);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--success);
    }

    /* Animaciones */
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    .pulse {
      animation: pulse 2s infinite ease-in-out;
    }

    /* Efecto de neón para títulos */
    .neon-text {
      text-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary), 0 0 20px var(--primary);
    }

    /* Modal de cámara */
    .camera-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .camera-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .camera-container {
      position: relative;
      width: 95%;
      max-width: 500px;
      height: 60vh;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(0, 247, 255, 0.3);
    }

    #camera-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      padding-bottom: 20px;
    }

    .camera-actions {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }

    .camera-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.2);
      border: 2px solid var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .camera-btn.capture {
      background-color: var(--danger);
      border-color: var(--danger);
      width: 60px;
      height: 60px;
    }

    .camera-btn:hover {
      transform: scale(1.1);
      background-color: var(--primary);
    }

    .camera-preview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }

    .camera-preview.active {
      display: block;
    }

    .camera-preview-actions {
      position: absolute;
      bottom: 15px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    /* Loading futurista */
    .futuristic-loader {
      display: flex;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(10, 10, 30, 0.8);
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .loader-content {
      text-align: center;
    }

    .loader-spinner {
      width: 80px;
      height: 80px;
      border: 5px solid rgba(0, 247, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
      box-shadow: 0 0 20px var(--primary);
    }

    .loader-text {
      color: var(--primary);
      font-size: 18px;
      text-shadow: 0 0 10px var(--primary);
      letter-spacing: 2px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Iconos para tipos de archivo */
    .file-type-icon {
      font-size: 24px;
      margin-right: 10px;
      color: var(--primary);
    }

    .back-button {
      position: fixed;
      top: 15px;
      left: 15px;
      background-color: var(--primary);
      color: var(--dark);
      border: none;
      border-radius: 50px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      z-index: 1000;
      box-shadow: 0 0 15px var(--primary);
    }

    .back-button:hover {
      background-color: var(--success);
      transform: translateY(-3px);
    }

    /* Modal para compartir imagen */
    .share-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .share-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .share-modal-container {
      background-color: rgba(20, 20, 50, 0.9);
      border-radius: 15px;
      padding: 15px;
      width: 95%;
      max-width: 500px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 30px rgba(0, 247, 255, 0.3);
    }

    .share-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0, 247, 255, 0.2);
    }

    .share-modal-title {
      font-size: 1.3em;
      color: var(--primary);
    }

    .share-modal-close {
      background: none;
      border: none;
      color: var(--light);
      font-size: 1.3em;
      cursor: pointer;
    }

    .share-modal-search {
      position: relative;
      margin-bottom: 15px;
    }

    .share-modal-search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
      cursor: pointer;
    }

    .share-modal-search-input {
      width: 100%;
      padding: 8px 8px 8px 35px;
      background-color: rgba(30, 30, 60, 0.7);
      border: 1px solid rgba(0, 247, 255, 0.2);
      border-radius: 25px;
      color: var(--light);
      outline: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .share-modal-users {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    .share-modal-user {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 10px;
      cursor: pointer;
      margin-bottom: 8px;
      transition: all 0.3s ease;
      background-color: rgba(30, 30, 60, 0.5);
      border: 1px solid rgba(0, 247, 255, 0.1);
    }

    .share-modal-user:hover {
      background-color: rgba(0, 247, 255, 0.2);
    }

    .share-modal-user.selected {
      background-color: rgba(0, 247, 255, 0.3);
      border-left: 4px solid var(--primary);
    }

    .share-modal-user img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      margin-right: 12px;
      object-fit: cover;
      border: 2px solid var(--primary);
    }

    .share-modal-user-info {
      flex: 1;
    }

    .share-modal-user-name {
      font-weight: bold;
      font-size: 14px;
    }

    .share-modal-user-status {
      font-size: 11px;
      color: var(--primary);
      display: flex;
      align-items: center;
    }

    .share-modal-user-status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background-color: var(--success);
      margin-right: 5px;
    }

    .share-modal-checkbox {
      margin-left: 12px;
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
      cursor: pointer;
    }

    .share-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .share-modal-btn {
      padding: 10px 20px;
      border-radius: 25px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: bold;
    }

    .share-modal-btn.send {
      background-color: var(--success);
      color: var(--dark);
    }

    .share-modal-btn.cancel {
      background-color: var(--danger);
      color: white;
    }

    .share-modal-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    /* Modal de información de usuario */
    .user-info-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .user-info-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .user-info-container {
      background-color: rgba(20, 20, 50, 0.9);
      border-radius: 15px;
      padding: 20px;
      width: 95%;
      max-width: 500px;
      box-shadow: 0 0 30px rgba(0, 247, 255, 0.3);
    }

    .user-info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(0, 247, 255, 0.2);
    }

    .user-info-title {
      font-size: 1.3em;
      color: var(--primary);
    }

    .user-info-close {
      background: none;
      border: none;
      color: var(--light);
      font-size: 1.3em;
      cursor: pointer;
    }

    .user-info-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .user-info-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 12px;
      object-fit: cover;
      border: 3px solid var(--primary);
      box-shadow: 0 0 20px var(--primary);
    }

    .user-info-field {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(0, 247, 255, 0.1);
      font-size: 14px;
    }

    .user-info-label {
      font-weight: bold;
      color: var(--primary);
      min-width: 100px;
    }

    .user-info-value {
      flex: 1;
      text-align: right;
      word-break: break-word;
    }

    /* Estilo para el botón de copiar */
    .copy-btn {
      background-color: rgba(0, 247, 255, 0.2);
      border: none;
      color: var(--primary);
      padding: 4px 8px;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 8px;
      font-size: 11px;
      transition: all 0.2s;
    }

    .copy-btn:hover {
      background-color: rgba(0, 247, 255, 0.4);
    }

    /* Estilo para los checks de mensaje leído */
    .read-status {
      display: flex;
      align-items: center;
      margin-left: 5px;
    }

    .read-check {
      color: var(--info);
      font-size: 11px;
      margin-left: 2px;
    }

    /* Reproductor de audio personalizado futurista */
    .audio-player-container {
      position: relative;
      width: 100%;
      margin-top: 5px;
      background: linear-gradient(135deg, rgba(30, 30, 60, 0.8), rgba(20, 20, 50, 0.8));
      border-radius: 15px;
      padding: 10px;
      box-shadow: 0 0 15px rgba(0, 247, 255, 0.2);
      display: flex;
      align-items: center;
    }

    .audio-icon {
      font-size: 24px;
      color: var(--primary);
      margin-right: 10px;
      text-shadow: 0 0 10px var(--primary);
    }

    .audio-player {
      flex: 1;
      height: 30px;
      -webkit-appearance: none;
      background: transparent;
    }

    .audio-player::-webkit-slider-runnable-track {
      height: 4px;
      background: rgba(0, 247, 255, 0.3);
      border-radius: 2px;
    }

    .audio-player::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: var(--primary);
      margin-top: -5px;
      cursor: pointer;
      box-shadow: 0 0 5px var(--primary);
    }

    .audio-time {
      font-size: 12px;
      color: var(--primary);
      margin-left: 10px;
      min-width: 50px;
      text-align: right;
    }

    /* Reproductor de video personalizado futurista */
    .video-player-container {
      position: relative;
      width: 100%;
      max-height: 300px;
      margin-top: 5px;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0, 247, 255, 0.3);
    }

    .video-player {
      width: 100%;
      height: 100%;
      background-color: #000;
    }

    .video-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
      padding: 10px;
      display: flex;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .video-player-container:hover .video-controls {
      opacity: 1;
    }

    .video-control-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 16px;
      margin: 0 5px;
      cursor: pointer;
      text-shadow: 0 0 5px var(--primary);
    }

    .video-progress {
      flex: 1;
      height: 4px;
      background: rgba(0, 247, 255, 0.3);
      border-radius: 2px;
      margin: 0 10px;
      position: relative;
    }

    .video-progress-filled {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--primary);
      border-radius: 2px;
    }

    .video-time {
      font-size: 12px;
      color: var(--primary);
      margin-left: 5px;
      min-width: 80px;
      text-align: center;
    }

    /* Media queries para dispositivos móviles */
    @media (min-width: 768px) {
      .container {
        flex-direction: row;
      }
      
      .user-list {
        width: 30%;
        display: block;
      }
      
      .chat-header .menu-button {
        display: none;
      }
      
      .chat-messages {
        padding-bottom: 15px;
      }
      
      .chat-input-container {
        position: relative;
        bottom: auto;
      }
    }

    @media (max-width: 767px) {
      .chat-header {
        padding: 10px;
      }
      
      .chat-header img {
        width: 35px;
        height: 35px;
      }
      
      .chat-header span {
        font-size: 16px;
      }
      
      .message {
        max-width: 85%;
        padding: 10px;
      }
      
      .message-avatar {
        width: 30px;
        height: 30px;
      }
      
      .image-preview-btn, .share-modal-btn {
        padding: 8px 15px;
        font-size: 13px;
      }
    }

    /* Botón para alternar lista de usuarios en móvil */
    .toggle-user-list {
      display: none;
      position: fixed;
      bottom: 70px;
      right: 15px;
      background-color: var(--primary);
      color: var(--dark);
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      z-index: 90;
      box-shadow: 0 0 15px var(--primary);
    }

    @media (max-width: 767px) {
      .toggle-user-list {
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Efectos de fondo -->
  <div class="glow-effect glow-1"></div>
  <div class="glow-effect glow-2"></div>

  <!-- Loading futurista -->
  <div class="futuristic-loader" id="loader">
    <div class="loader-content">
      <div class="loader-spinner"></div>
      <div class="loader-text">Cargando...</div>
    </div>
  </div>


  <!-- Botón para alternar lista de usuarios en móvil -->
  <button class="toggle-user-list" id="toggleUserList">
    <i class="fas fa-users"></i>
  </button>

  <div class="container">
    <!-- Ventana Izquierda: Lista de Usuarios -->
    <div class="user-list" id="userListContainer">  
      <h2 class="neon-text">Contactos</h2>
      <div class="user-search">
        <i class="fas fa-search"></i>
        <input type="text" id="userSearchInput" placeholder="Buscar contactos...">
      </div>
      <ul id="userList"></ul>
    </div>

    <!-- Ventana Derecha: Chat -->
    <div class="chat-window">
      <div class="chat-header">
        <img id="chatUserImage" src="https://firebasestorage.googleapis.com/v0/b/inventario-35d6b.appspot.com/o/RETOM%20COMPLETO%20(1).png?alt=media&token=55cc155d-a70b-463d-a723-6fb646cde75c" alt="Usuario">
        <span id="chatUserName">Chat Futurista</span>
        <div class="online-status"></div>
        <button class="menu-button" id="menuButton">
          <i class="fas fa-ellipsis-v"></i>
        </button>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-container">
        <div class="chat-input-tools">
          <button id="attachFileButton" title="Adjuntar archivo">
            <i class="fas fa-paperclip"></i>
          </button>
          <button id="openCameraButton" title="Abrir cámara">
            <i class="fas fa-camera"></i>
          </button>
        </div>
        <div class="chat-input">
          <textarea id="messageInput" placeholder="Escribe un mensaje..."></textarea>
          <button id="sendMessageButton">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de vista previa de imagen -->
  <div class="image-preview-modal" id="imagePreviewModal">
    <div class="image-preview-container">
      <img class="image-preview" id="imagePreview" src="" alt="Vista previa">
      <div class="image-preview-actions">
        <button class="image-preview-btn send" id="sendImageButton">
          <i class="fas fa-paper-plane"></i> Enviar
        </button>
        <button class="image-preview-btn cancel" id="cancelImageButton">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal para compartir imagen -->
  <div class="share-modal" id="shareModal">
    <div class="share-modal-container">
      <div class="share-modal-header">
        <div class="share-modal-title">Compartir archivo</div>
        <button class="share-modal-close" id="closeShareModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="share-modal-search">
        <i class="fas fa-search share-modal-search-icon"></i>
        <input type="text" class="share-modal-search-input" id="shareSearchInput" placeholder="Buscar usuario...">
      </div>
      <div class="share-modal-users" id="shareUserList"></div>
      <div class="share-modal-actions">
        <button class="share-modal-btn cancel" id="cancelShareButton">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button class="share-modal-btn send" id="confirmShareButton">
          <i class="fas fa-paper-plane"></i> Enviar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de información de usuario -->
  <div class="user-info-modal" id="userInfoModal">
    <div class="user-info-container">
      <div class="user-info-header">
        <div class="user-info-title">Información del Usuario</div>
        <button class="user-info-close" id="closeUserInfoModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="user-info-content">
        <img class="user-info-avatar" id="userInfoAvatar" src="" alt="Avatar">
        <div class="user-info-field">
          <span class="user-info-label">Nombre:</span>
          <span class="user-info-value" id="userInfoName"></span>
        </div>
        <div class="user-info-field">
          <span class="user-info-label">Departamento:</span>
          <span class="user-info-value" id="userInfoDepartment"></span>
        </div>
        <div class="user-info-field">
          <span class="user-info-label">Área de trabajo:</span>
          <span class="user-info-value" id="userInfoWorkArea"></span>
        </div>
        <div class="user-info-field">
          <span class="user-info-label">Posición:</span>
          <span class="user-info-value" id="userInfoPosition"></span>
        </div>
        <div class="user-info-field">
          <span class="user-info-label">Fecha de nacimiento:</span>
          <span class="user-info-value" id="userInfoBirthDate"></span>
        </div>
        <div class="user-info-field">
          <span class="user-info-label">Correo:</span>
          <span class="user-info-value" id="userInfoEmail"></span>
        </div>
        <div class="user-info-field">
          <span class="user-info-label">Código de trabajo:</span>
          <span class="user-info-value" id="userInfoWorkCode"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de cámara -->
  <div class="camera-modal" id="cameraModal">
    <div class="camera-container">
      <video id="camera-video" autoplay playsinline></video>
      <canvas id="camera-canvas" class="camera-preview"></canvas>
      <div class="camera-overlay">
        <div class="camera-actions">
          <button class="camera-btn" id="switchCameraButton">
            <i class="fas fa-sync-alt"></i>
          </button>
          <button class="camera-btn capture" id="captureButton">
            <i class="fas fa-camera"></i>
          </button>
          <button class="camera-btn" id="closeCameraButton">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="camera-preview-actions" id="cameraPreviewActions" style="display: none;">
        <button class="image-preview-btn send" id="sendPhotoButton">
          <i class="fas fa-check"></i> Enviar
        </button>
        <button class="image-preview-btn cancel" id="retakePhotoButton">
          <i class="fas fa-redo"></i> Volver a tomar
        </button>
      </div>
    </div>
  </div>

  <!-- Notificación de nuevo mensaje -->
  <div class="message-notification" id="messageNotification">
    <img class="notification-avatar" id="notificationAvatar" src="" alt="Usuario">
    <div class="notification-content">
      <div class="notification-title" id="notificationTitle"></div>
      <div class="notification-text" id="notificationText"></div>
    </div>
    <button class="notification-close" id="closeNotification">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      addDoc, 
      onSnapshot, 
      query, 
      orderBy, 
      doc, 
      updateDoc,
      deleteDoc,
      serverTimestamp,
      where,
      limit
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { 
      getAuth, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { 
      getStorage, 
      ref, 
      uploadBytes, 
      getDownloadURL,
      deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
      authDomain: "inventario-35d6b.firebaseapp.com",
      projectId: "inventario-35d6b",
      storageBucket: "inventario-35d6b.appspot.com",
      messagingSenderId: "266100399659",
      appId: "1:266100399659:web:92358d28cbd803c8a7d46e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // Variables de estado
    let activeUser = null;
    let activeUserId = null;
    let activeChatId = null;
    let users = {};
    let cameraStream = null;
    let currentCameraFacing = 'environment';
    let selectedFile = null;
    let capturedPhoto = null;
    let selectedUsersToShare = [];
    let fileToShare = null;
    let fileTypeToShare = null;
    let userActivity = {};

    // Mostrar loader
    const showLoader = () => {
      document.getElementById("loader").style.display = "flex";
    };

    // Ocultar loader
    const hideLoader = () => {
      document.getElementById("loader").style.display = "none";
    };

    // Inicializar la aplicación cuando el usuario esté autenticado
    onAuthStateChanged(auth, (user) => {
      if (user) {
        activeUser = user.uid;
        loadUsers();
        setupMessageNotifications();
        hideLoader();
      } else {
        Swal.fire({
          title: 'Acceso requerido',
          text: 'Por favor, inicia sesión para usar el chat',
          icon: 'warning',
          confirmButtonText: 'Ir a login',
          background: '#1a1a2e',
          color: '#fff'
        }).then(() => {
          window.location.href = "index.html";
        });
      }
    });

    // Cargar lista de usuarios con información adicional
    const loadUsers = async () => {
      showLoader();
      const usersSnapshot = await getDocs(collection(db, "users"));
      const userList = document.getElementById("userList");
      userList.innerHTML = "";

      let usersArray = [];

      usersSnapshot.forEach((doc) => {
        const user = doc.data();
        const userId = doc.id;
        users[userId] = user;
        userActivity[userId] = { lastActivity: 0 };

        if (userId !== activeUser) {
          usersArray.push({ userId, ...user });
        }
      });

      await loadUserActivities(usersArray);
      hideLoader();
    };

    // Cargar la última actividad de cada usuario
    const loadUserActivities = async (usersArray) => {
      const userList = document.getElementById("userList");
      
      for (const userData of usersArray) {
        const userId = userData.userId;
        const chatId = getChatId(activeUser, userId);
        
        const messagesRef = collection(db, `chats/${chatId}/messages`);
        const q = query(messagesRef, orderBy("timestamp", "desc"), limit(1));
        
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach((doc) => {
          const message = doc.data();
          userActivity[userId] = {
            lastActivity: message.timestamp?.toMillis() || 0,
            lastMessage: message.text || "Archivo enviado"
          };
        });
      }

      usersArray.sort((a, b) => {
        return (userActivity[b.userId]?.lastActivity || 0) - (userActivity[a.userId]?.lastActivity || 0);
      });

      displaySortedUsers(usersArray);
    };

    // Mostrar usuarios ordenados por actividad
    const displaySortedUsers = (usersArray) => {
      const userList = document.getElementById("userList");
      userList.innerHTML = "";

      usersArray.forEach(userData => {
        const userId = userData.userId;
        const user = users[userId];
        
        const li = document.createElement("li");
        li.dataset.userId = userId;
        
        const img = document.createElement("img");
        img.src = user.photoURL || "https://via.placeholder.com/40";
        img.alt = user.name;
        
        const userInfo = document.createElement("div");
        userInfo.className = "user-info";
        
        const userName = document.createElement("div");
        userName.className = "user-name";
        userName.textContent = user.name;
        
        const userStatus = document.createElement("div");
        userStatus.className = "user-status";
        
        const statusDot = document.createElement("div");
        statusDot.className = "status-dot";
        
        const statusText = document.createElement("span");
        statusText.textContent = "En línea";
        
        userStatus.appendChild(statusDot);
        userStatus.appendChild(statusText);
        
        const typingIndicator = document.createElement("div");
        typingIndicator.className = "typing-indicator";
        typingIndicator.style.display = "none";
        typingIndicator.textContent = "escribiendo...";
        
        const lastActivity = document.createElement("div");
        lastActivity.className = "last-activity";
        if (userActivity[userId]?.lastActivity) {
          const lastDate = new Date(userActivity[userId].lastActivity);
          lastActivity.textContent = `Última actividad: ${lastDate.toLocaleString()}`;
        } else {
          lastActivity.textContent = "Sin actividad reciente";
        }
        
        userInfo.appendChild(userName);
        userInfo.appendChild(userStatus);
        userInfo.appendChild(typingIndicator);
        userInfo.appendChild(lastActivity);
        
        li.appendChild(img);
        li.appendChild(userInfo);
        
        const unreadIndicator = document.createElement("div");
        unreadIndicator.className = "unread";
        unreadIndicator.style.display = "none";
        li.appendChild(unreadIndicator);
        
        li.addEventListener("click", () => {
          openChat(userId);
          if (window.innerWidth <= 767) {
            document.getElementById("userListContainer").classList.remove("active");
          }
        });
        
        userName.addEventListener("click", (e) => {
          e.stopPropagation();
          showUserInfo(userId);
        });
        
        img.addEventListener("click", (e) => {
          e.stopPropagation();
          showUserInfo(userId);
        });
        
        userList.appendChild(li);
        
        listenForTyping(userId, typingIndicator);
        checkUnreadMessages(userId, unreadIndicator);
      });

      document.getElementById("userSearchInput").addEventListener("input", (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const userElements = document.querySelectorAll("#userList li");
        
        userElements.forEach(userElement => {
          const userName = userElement.querySelector(".user-name").textContent.toLowerCase();
          if (userName.includes(searchTerm)) {
            userElement.style.display = "flex";
          } else {
            userElement.style.display = "none";
          }
        });
      });
    };

    // Mostrar información detallada del usuario
    const showUserInfo = (userId) => {
      const user = users[userId];
      if (!user) return;
      
      document.getElementById("userInfoAvatar").src = user.photoURL || "https://via.placeholder.com/100";
      document.getElementById("userInfoName").textContent = user.name || "No disponible";
      document.getElementById("userInfoDepartment").textContent = user.department || "No disponible";
      document.getElementById("userInfoWorkArea").textContent = user.workArea || "No disponible";
      document.getElementById("userInfoPosition").textContent = user.position || "No disponible";
      document.getElementById("userInfoBirthDate").textContent = user.birthDate || "No disponible";
      document.getElementById("userInfoEmail").textContent = user.email || "No disponible";
      document.getElementById("userInfoWorkCode").textContent = user.workCode || "No disponible";
      
      const copyButtons = document.querySelectorAll('.copy-btn');
      copyButtons.forEach(btn => btn.remove());
      
      const fields = ['userInfoName', 'userInfoDepartment', 'userInfoWorkArea', 
                     'userInfoPosition', 'userInfoBirthDate', 'userInfoEmail', 'userInfoWorkCode'];
      
      fields.forEach(fieldId => {
        const fieldElement = document.getElementById(fieldId);
        const value = fieldElement.textContent;
        
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.innerHTML = '<i class="far fa-copy"></i>';
        copyBtn.title = 'Copiar';
        copyBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(value).then(() => {
            Swal.fire({
              title: 'Copiado',
              text: 'El texto ha sido copiado al portapapeles',
              icon: 'success',
              timer: 1500,
              showConfirmButton: false,
              background: '#1a1a2e',
              color: '#fff'
            });
          });
        });
        
        fieldElement.parentNode.insertBefore(copyBtn, fieldElement.nextSibling);
      });
      
      document.getElementById("userInfoModal").classList.add("active");
    };

    // Abrir chat con un usuario
    const openChat = async (userId) => {
      showLoader();
      activeUserId = userId;
      activeChatId = getChatId(activeUser, userId);
      
      const user = users[userId];
      document.getElementById("chatUserName").textContent = user.name;
      document.getElementById("chatUserImage").src = user.photoURL || "https://via.placeholder.com/40";
      
      document.getElementById("chatUserName").addEventListener("click", () => showUserInfo(userId));
      document.getElementById("chatUserImage").addEventListener("click", () => showUserInfo(userId));
      
      await markMessagesAsRead();
      
      const userItem = document.querySelector(`li[data-user-id="${userId}"] .unread`);
      if (userItem) {
        userItem.style.display = "none";
      }
      
      loadMessages();
      hideLoader();
    };

    // Marcar mensajes como leídos
    const markMessagesAsRead = async () => {
      if (!activeChatId) return;
      
      const messagesRef = collection(db, `chats/${activeChatId}/messages`);
      const q = query(messagesRef, where("sender", "==", activeUserId), where("read", "==", false));
      
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach(async (doc) => {
        await updateDoc(doc.ref, {
          read: true,
          readTime: serverTimestamp()
        });
      });
    };

    // Verificar mensajes no leídos
    const checkUnreadMessages = (userId, unreadIndicator) => {
      const chatId = getChatId(activeUser, userId);
      const messagesRef = collection(db, `chats/${chatId}/messages`);
      const q = query(messagesRef, where("sender", "==", userId), where("read", "==", false));
      
      onSnapshot(q, (snapshot) => {
        unreadIndicator.style.display = snapshot.size > 0 ? "block" : "none";
      });
    };

    // Escuchar cambios de estado de escritura
    const listenForTyping = (userId, typingIndicator) => {
      const typingRef = doc(db, `typing/${getChatId(activeUser, userId)}`);
      
      onSnapshot(typingRef, (doc) => {
        const typingData = doc.data();
        if (typingData && typingData[userId] && typingData[userId].typing) {
          typingIndicator.style.display = "block";
        } else {
          typingIndicator.style.display = "none";
        }
      });
    };

    // Cargar mensajes del chat
    const loadMessages = () => {
      if (!activeChatId) return;
      
      const messagesQuery = query(
        collection(db, `chats/${activeChatId}/messages`), 
        orderBy("timestamp")
      );
      
      onSnapshot(messagesQuery, (snapshot) => {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = "";
        
        snapshot.forEach((doc) => {
          const message = doc.data();
          addMessageToChat(message, doc.id);
        });
        
        scrollToBottom();
      });
    };

    // Añadir mensaje al chat
    const addMessageToChat = (message, messageId) => {
      const chatMessages = document.getElementById("chatMessages");
      const isSent = message.sender === activeUser;
      
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
      messageDiv.dataset.messageId = messageId;
      
      const avatar = document.createElement("img");
      avatar.className = "message-avatar";
      avatar.src = isSent ? 
        (users[activeUser]?.photoURL || "https://via.placeholder.com/40") : 
        (users[activeUserId]?.photoURL || "https://via.placeholder.com/40");
      messageDiv.appendChild(avatar);
      
      const contentDiv = document.createElement("div");
      contentDiv.className = "message-content";
      
      if (message.text) {
        const textDiv = document.createElement("div");
        textDiv.className = "message-text";
        textDiv.textContent = message.text;
        contentDiv.appendChild(textDiv);
      }
      
      if (message.imageUrl) {
        const imgDiv = document.createElement("img");
        imgDiv.className = "message-image";
        imgDiv.src = message.imageUrl;
        imgDiv.alt = "Imagen enviada";
        
        imgDiv.addEventListener("click", () => {
          Swal.fire({
            imageUrl: message.imageUrl,
            imageAlt: 'Imagen del chat',
            background: '#1a1a2e',
            showConfirmButton: false,
            showCloseButton: true
          });
        });
        
        contentDiv.appendChild(imgDiv);
      }
      
      if (message.audioUrl) {
        const audioContainer = document.createElement("div");
        audioContainer.className = "audio-player-container";
        
        const audioIcon = document.createElement("i");
        audioIcon.className = "fas fa-music audio-icon";
        audioContainer.appendChild(audioIcon);
        
        const audioPlayer = document.createElement("input");
        audioPlayer.type = "range";
        audioPlayer.className = "audio-player";
        audioPlayer.min = "0";
        audioPlayer.max = "100";
        audioPlayer.value = "0";
        audioContainer.appendChild(audioPlayer);
        
        const audioTime = document.createElement("div");
        audioTime.className = "audio-time";
        audioTime.textContent = "0:00";
        audioContainer.appendChild(audioTime);
        
        const realAudio = document.createElement("audio");
        realAudio.src = message.audioUrl;
        realAudio.setAttribute("controlsList", "nodownload");
        realAudio.style.display = "none";
        
        realAudio.addEventListener("loadedmetadata", () => {
          const duration = Math.floor(realAudio.duration);
          audioTime.textContent = `${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`;
        });
        
        audioPlayer.addEventListener("input", () => {
          const percent = audioPlayer.value / 100;
          realAudio.currentTime = percent * realAudio.duration;
        });
        
        realAudio.addEventListener("timeupdate", () => {
          const percent = (realAudio.currentTime / realAudio.duration) * 100;
          audioPlayer.value = percent;
        });
        
        audioIcon.addEventListener("click", () => {
          if (realAudio.paused) {
            realAudio.play();
            audioIcon.className = "fas fa-pause audio-icon";
          } else {
            realAudio.pause();
            audioIcon.className = "fas fa-music audio-icon";
          }
        });
        
        contentDiv.appendChild(audioContainer);
        contentDiv.appendChild(realAudio);
      }
      
      if (message.videoUrl) {
        const videoContainer = document.createElement("div");
        videoContainer.className = "video-player-container";
        
        const videoPlayer = document.createElement("video");
        videoPlayer.className = "video-player";
        videoPlayer.src = message.videoUrl;
        videoPlayer.setAttribute("controlsList", "nodownload");
        videoContainer.appendChild(videoPlayer);
        
        const videoControls = document.createElement("div");
        videoControls.className = "video-controls";
        
        const playBtn = document.createElement("button");
        playBtn.className = "video-control-btn";
        playBtn.innerHTML = '<i class="fas fa-play"></i>';
        playBtn.addEventListener("click", () => {
          if (videoPlayer.paused) {
            videoPlayer.play();
            playBtn.innerHTML = '<i class="fas fa-pause"></i>';
          } else {
            videoPlayer.pause();
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
          }
        });
        videoControls.appendChild(playBtn);
        
        const progressBar = document.createElement("div");
        progressBar.className = "video-progress";
        
        const progressFilled = document.createElement("div");
        progressFilled.className = "video-progress-filled";
        progressBar.appendChild(progressFilled);
        
        videoPlayer.addEventListener("timeupdate", () => {
          const percent = (videoPlayer.currentTime / videoPlayer.duration) * 100;
          progressFilled.style.width = `${percent}%`;
        });
        
        progressBar.addEventListener("click", (e) => {
          const percent = e.offsetX / progressBar.offsetWidth;
          videoPlayer.currentTime = percent * videoPlayer.duration;
        });
        
        videoControls.appendChild(progressBar);
        
        const timeDisplay = document.createElement("div");
        timeDisplay.className = "video-time";
        timeDisplay.textContent = "0:00 / 0:00";
        
        videoPlayer.addEventListener("loadedmetadata", () => {
          const duration = Math.floor(videoPlayer.duration);
          timeDisplay.textContent = `0:00 / ${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`;
        });
        
        videoPlayer.addEventListener("timeupdate", () => {
          const current = Math.floor(videoPlayer.currentTime);
          const duration = Math.floor(videoPlayer.duration);
          timeDisplay.textContent = `${Math.floor(current / 60)}:${(current % 60).toString().padStart(2, '0')} / ${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`;
        });
        
        videoControls.appendChild(timeDisplay);
        
        videoContainer.appendChild(videoControls);
        contentDiv.appendChild(videoContainer);
      }
      
      const timeDiv = document.createElement("div");
      timeDiv.className = "message-time";
      
      const timestamp = message.timestamp?.toDate ? message.timestamp.toDate() : new Date();
      timeDiv.textContent = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      if (isSent) {
        const readStatus = document.createElement("div");
        readStatus.className = "read-status";
        
        if (message.read) {
          const check1 = document.createElement("i");
          check1.className = "fas fa-check read-check";
          const check2 = document.createElement("i");
          check2.className = "fas fa-check read-check";
          
          readStatus.appendChild(check1);
          readStatus.appendChild(check2);
        } else {
          const check = document.createElement("i");
          check.className = "fas fa-check read-check";
          readStatus.appendChild(check);
        }
        
        timeDiv.appendChild(readStatus);
      }
      
      contentDiv.appendChild(timeDiv);
      
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "message-actions";
      
      if (message.text) {
        const copyButton = document.createElement("button");
        copyButton.className = "message-action";
        copyButton.title = "Copiar mensaje";
        copyButton.innerHTML = '<i class="far fa-copy"></i>';
        copyButton.addEventListener("click", () => {
          navigator.clipboard.writeText(message.text).then(() => {
            Swal.fire({
              title: 'Copiado',
              text: 'El mensaje ha sido copiado al portapapeles',
              icon: 'success',
              timer: 1500,
              showConfirmButton: false,
              background: '#1a1a2e',
              color: '#fff'
            });
          });
        });
        actionsDiv.appendChild(copyButton);
      }
      
      if (message.imageUrl) {
        const shareButton = document.createElement("button");
        shareButton.className = "message-action";
        shareButton.title = "Compartir imagen";
        shareButton.innerHTML = '<i class="fas fa-share-alt"></i>';
        shareButton.addEventListener("click", () => openShareModal(message.imageUrl, 'image'));
        actionsDiv.appendChild(shareButton);
        
        const downloadButton = document.createElement("button");
        downloadButton.className = "message-action";
        downloadButton.title = "Descargar imagen";
        downloadButton.innerHTML = '<i class="fas fa-download"></i>';
        downloadButton.addEventListener("click", () => downloadFile(message.imageUrl, `imagen-${Date.now()}.jpg`));
        actionsDiv.appendChild(downloadButton);
      }
      
      if (message.audioUrl) {
        const shareButton = document.createElement("button");
        shareButton.className = "message-action";
        shareButton.title = "Compartir audio";
        shareButton.innerHTML = '<i class="fas fa-share-alt"></i>';
        shareButton.addEventListener("click", () => openShareModal(message.audioUrl, 'audio'));
        actionsDiv.appendChild(shareButton);
        
        const downloadButton = document.createElement("button");
        downloadButton.className = "message-action";
        downloadButton.title = "Descargar audio";
        downloadButton.innerHTML = '<i class="fas fa-download"></i>';
        downloadButton.addEventListener("click", () => downloadFile(message.audioUrl, `audio-${Date.now()}.mp3`));
        actionsDiv.appendChild(downloadButton);
      }
      
      if (message.videoUrl) {
        const shareButton = document.createElement("button");
        shareButton.className = "message-action";
        shareButton.title = "Compartir video";
        shareButton.innerHTML = '<i class="fas fa-share-alt"></i>';
        shareButton.addEventListener("click", () => openShareModal(message.videoUrl, 'video'));
        actionsDiv.appendChild(shareButton);
        
        const downloadButton = document.createElement("button");
        downloadButton.className = "message-action";
        downloadButton.title = "Descargar video";
        downloadButton.innerHTML = '<i class="fas fa-download"></i>';
        downloadButton.addEventListener("click", () => downloadFile(message.videoUrl, `video-${Date.now()}.mp4`));
        actionsDiv.appendChild(downloadButton);
      }
      
      if (isSent) {
        const deleteButton = document.createElement("button");
        deleteButton.className = "message-action";
        deleteButton.title = "Eliminar mensaje";
        deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
        deleteButton.addEventListener("click", () => deleteMessage(messageId, message.imageUrl || message.audioUrl || message.videoUrl));
        actionsDiv.appendChild(deleteButton);
      }
      
      messageDiv.appendChild(contentDiv);
      messageDiv.appendChild(actionsDiv);
      chatMessages.appendChild(messageDiv);
      
      if (message.sender !== activeUser && !message.read) {
        messageDiv.style.animation = "pulse 2s";
        playNotificationSound();
      }
    };

    // Función para eliminar mensaje
    const deleteMessage = async (messageId, fileUrl) => {
      try {
        const result = await Swal.fire({
          title: '¿Eliminar mensaje?',
          text: 'Esta acción no se puede deshacer',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Sí, eliminar',
          cancelButtonText: 'Cancelar',
          background: '#1a1a2e',
          color: '#fff'
        });
        
        if (result.isConfirmed) {
          if (fileUrl) {
            const fileRef = ref(storage, fileUrl);
            await deleteObject(fileRef).catch(e => console.log("No se pudo eliminar el archivo:", e));
          }
          
          await deleteDoc(doc(db, `chats/${activeChatId}/messages/${messageId}`));
          
          Swal.fire({
            title: 'Eliminado',
            text: 'El mensaje ha sido eliminado',
            icon: 'success',
            timer: 1500,
            showConfirmButton: false,
            background: '#1a1a2e',
            color: '#fff'
          });
        }
      } catch (error) {
        console.error('Error al eliminar mensaje:', error);
        Swal.fire({
          title: 'Error',
          text: 'No se pudo eliminar el mensaje',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Función para compartir archivos
    const openShareModal = (fileUrl, fileType) => {
      fileToShare = fileUrl;
      fileTypeToShare = fileType;
      selectedUsersToShare = [];
      
      document.getElementById("shareModal").classList.add("active");
      document.getElementById("shareModal-title").textContent = `Compartir ${fileType === 'image' ? 'imagen' : fileType === 'video' ? 'video' : 'audio'}`;
      
      loadShareUsers();
    };

    // Cargar usuarios para compartir archivos
    const loadShareUsers = () => {
      const shareUserList = document.getElementById("shareUserList");
      shareUserList.innerHTML = "";
      
      const sortedUsers = Object.keys(users)
        .filter(userId => userId !== activeUser)
        .sort((a, b) => {
          return (userActivity[b]?.lastActivity || 0) - (userActivity[a]?.lastActivity || 0);
        });
      
      sortedUsers.forEach(userId => {
        const user = users[userId];
        
        const userDiv = document.createElement("div");
        userDiv.className = "share-modal-user";
        userDiv.dataset.userId = userId;
        
        const img = document.createElement("img");
        img.src = user.photoURL || "https://via.placeholder.com/40";
        img.alt = user.name;
        
        const userInfo = document.createElement("div");
        userInfo.className = "share-modal-user-info";
        
        const userName = document.createElement("div");
        userName.className = "share-modal-user-name";
        userName.textContent = user.name;
        
        const userStatus = document.createElement("div");
        userStatus.className = "share-modal-user-status";
        
        const statusDot = document.createElement("div");
        statusDot.className = "share-modal-user-status-dot";
        
        const statusText = document.createElement("span");
        statusText.textContent = "En línea";
        
        userStatus.appendChild(statusDot);
        userStatus.appendChild(statusText);
        
        userInfo.appendChild(userName);
        userInfo.appendChild(userStatus);
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "share-modal-checkbox";
        checkbox.dataset.userId = userId;
        
        userDiv.appendChild(img);
        userDiv.appendChild(userInfo);
        userDiv.appendChild(checkbox);
        
        checkbox.addEventListener("change", (e) => {
          if (e.target.checked) {
            selectedUsersToShare.push(userId);
            userDiv.classList.add("selected");
          } else {
            selectedUsersToShare = selectedUsersToShare.filter(id => id !== userId);
            userDiv.classList.remove("selected");
          }
        });
        
        shareUserList.appendChild(userDiv);
      });
      
      document.getElementById("shareSearchInput").addEventListener("input", (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const userElements = document.querySelectorAll(".share-modal-user");
        
        userElements.forEach(userElement => {
          const userName = userElement.querySelector(".share-modal-user-name").textContent.toLowerCase();
          if (userName.includes(searchTerm)) {
            userElement.style.display = "flex";
          } else {
            userElement.style.display = "none";
          }
        });
      });
    };

    // Función para compartir archivos con usuarios seleccionados
    const shareFileWithUsers = async () => {
      if (!fileToShare || selectedUsersToShare.length === 0) {
        Swal.fire({
          title: 'Error',
          text: 'Debes seleccionar al menos un usuario para compartir',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
        return;
      }
      
      try {
        showLoader();
        const response = await fetch(fileToShare);
        const blob = await response.blob();
        
        for (const userId of selectedUsersToShare) {
          const chatId = getChatId(activeUser, userId);
          let storagePath = '';
          let messageData = {
            sender: activeUser,
            timestamp: serverTimestamp(),
            read: false
          };
          
          if (fileTypeToShare === 'image') {
            storagePath = `chat_images/${chatId}/${Date.now()}_shared.jpg`;
            messageData.imageUrl = await uploadAndGetUrl(storagePath, blob);
          } else if (fileTypeToShare === 'audio') {
            storagePath = `chat_audios/${chatId}/${Date.now()}_shared.mp3`;
            messageData.audioUrl = await uploadAndGetUrl(storagePath, blob);
          } else if (fileTypeToShare === 'video') {
            storagePath = `chat_videos/${chatId}/${Date.now()}_shared.mp4`;
            messageData.videoUrl = await uploadAndGetUrl(storagePath, blob);
          }
          
          await addDoc(collection(db, `chats/${chatId}/messages`), messageData);
          
          userActivity[userId] = {
            lastActivity: Date.now(),
            lastMessage: `${fileTypeToShare === 'image' ? 'Imagen' : fileTypeToShare === 'audio' ? 'Audio' : 'Video'} compartido`
          };
        }
        
        document.getElementById("shareModal").classList.remove("active");
        
        Swal.fire({
          title: 'Archivo compartido',
          text: `El archivo ha sido compartido con ${selectedUsersToShare.length} usuario(s)`,
          icon: 'success',
          timer: 1500,
          showConfirmButton: false,
          background: '#1a1a2e',
          color: '#fff'
        });
        
        loadUsers();
        hideLoader();
        
      } catch (error) {
        console.error("Error al compartir archivo:", error);
        hideLoader();
        Swal.fire({
          title: 'Error',
          text: 'No se pudo compartir el archivo',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Función auxiliar para subir archivo y obtener URL
    const uploadAndGetUrl = async (storagePath, blob) => {
      const storageRef = ref(storage, storagePath);
      await uploadBytes(storageRef, blob);
      return await getDownloadURL(storageRef);
    };

    // Función para descargar archivos
    const downloadFile = (url, fileName) => {
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    // Función para generar un ID único de chat
    const getChatId = (user1Id, user2Id) => {
      return user1Id < user2Id ? user1Id + user2Id : user2Id + user1Id;
    };

    // Enviar mensaje de texto
    const sendMessage = async (messageText) => {
      if (!messageText.trim() || !activeChatId) return;
      
      const messageData = {
        sender: activeUser,
        text: messageText,
        timestamp: serverTimestamp(),
        read: false
      };
      
      await addDoc(collection(db, `chats/${activeChatId}/messages`), messageData);
      
      userActivity[activeUserId] = {
        lastActivity: Date.now(),
        lastMessage: messageText
      };
      
      updateTypingStatus(false);
      
      document.getElementById("messageInput").value = "";
      
      loadUsers();
    };

    // Enviar imagen
    const sendImage = async (imageFile) => {
      if (!imageFile || !activeChatId) return;
      
      try {
        showLoader();
        const storageRef = ref(storage, `chat_images/${activeChatId}/${Date.now()}_${imageFile.name}`);
        await uploadBytes(storageRef, imageFile);
        const downloadURL = await getDownloadURL(storageRef);
        
        await addDoc(collection(db, `chats/${activeChatId}/messages`), {
          sender: activeUser,
          imageUrl: downloadURL,
          timestamp: serverTimestamp(),
          read: false
        });
        
        userActivity[activeUserId] = {
          lastActivity: Date.now(),
          lastMessage: "Imagen enviada"
        };
        
        document.getElementById("imagePreviewModal").classList.remove("active");
        selectedFile = null;
        
        loadUsers();
        hideLoader();
        
      } catch (error) {
        console.error("Error al enviar imagen:", error);
        hideLoader();
        Swal.fire({
          title: 'Error',
          text: 'No se pudo enviar la imagen',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Enviar audio
    const sendAudio = async (audioFile) => {
      if (!audioFile || !activeChatId) return;
      
      try {
        showLoader();
        const storageRef = ref(storage, `chat_audios/${activeChatId}/${Date.now()}_${audioFile.name}`);
        await uploadBytes(storageRef, audioFile);
        const downloadURL = await getDownloadURL(storageRef);
        
        await addDoc(collection(db, `chats/${activeChatId}/messages`), {
          sender: activeUser,
          audioUrl: downloadURL,
          timestamp: serverTimestamp(),
          read: false
        });
        
        userActivity[activeUserId] = {
          lastActivity: Date.now(),
          lastMessage: "Audio enviado"
        };
        
        loadUsers();
        hideLoader();
        
      } catch (error) {
        console.error("Error al enviar audio:", error);
        hideLoader();
        Swal.fire({
          title: 'Error',
          text: 'No se pudo enviar el audio',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Enviar video
    const sendVideo = async (videoFile) => {
      if (!videoFile || !activeChatId) return;
      
      try {
        showLoader();
        const storageRef = ref(storage, `chat_videos/${activeChatId}/${Date.now()}_${videoFile.name}`);
        await uploadBytes(storageRef, videoFile);
        const downloadURL = await getDownloadURL(storageRef);
        
        await addDoc(collection(db, `chats/${activeChatId}/messages`), {
          sender: activeUser,
          videoUrl: downloadURL,
          timestamp: serverTimestamp(),
          read: false
        });
        
        userActivity[activeUserId] = {
          lastActivity: Date.now(),
          lastMessage: "Video enviado"
        };
        
        loadUsers();
        hideLoader();
        
      } catch (error) {
        console.error("Error al enviar video:", error);
        hideLoader();
        Swal.fire({
          title: 'Error',
          text: 'No se pudo enviar el video',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Actualizar estado de "escribiendo"
    const updateTypingStatus = (isTyping) => {
      if (!activeChatId) return;
      
      const typingRef = doc(db, `typing/${activeChatId}`);
      updateDoc(typingRef, {
        [activeUser]: {
          typing: isTyping,
          timestamp: serverTimestamp()
        }
      });
    };

    // Configurar notificaciones de nuevos mensajes
    const setupMessageNotifications = () => {
      const chatsQuery = query(collection(db, "chats"));
      
      onSnapshot(chatsQuery, (snapshot) => {
        snapshot.forEach((doc) => {
          const chatId = doc.id;
          
          if (chatId.includes(activeUser)) {
            const otherUserId = chatId.replace(activeUser, '');
            const messagesRef = collection(db, `chats/${chatId}/messages`);
            const q = query(messagesRef, orderBy("timestamp", "desc"), limit(1));
            
            onSnapshot(q, (messageSnapshot) => {
              messageSnapshot.forEach((messageDoc) => {
                const message = messageDoc.data();
                
                if (message.sender !== activeUser && 
                    (!message.read || message.read === undefined)) {
                  showMessageNotification(otherUserId, message);
                  
                  userActivity[otherUserId] = {
                    lastActivity: message.timestamp?.toMillis() || Date.now(),
                    lastMessage: message.text || "Archivo enviado"
                  };
                  
                  loadUsers();
                }
              });
            });
          }
        });
      });
    };

    // Mostrar notificación de nuevo mensaje
    const showMessageNotification = (userId, message) => {
      const user = users[userId];
      if (!user) return;
      
      const notification = document.getElementById("messageNotification");
      const notificationAvatar = document.getElementById("notificationAvatar");
      const notificationTitle = document.getElementById("notificationTitle");
      const notificationText = document.getElementById("notificationText");
      
      notificationAvatar.src = user.photoURL || "https://via.placeholder.com/40";
      notificationTitle.textContent = user.name;
      notificationText.textContent = message.text || "Nuevo archivo";
      
      notification.classList.add("show");
      playNotificationSound();
      
      setTimeout(() => {
        notification.classList.remove("show");
      }, 5000);
    };

    // Reproducir sonido de notificación
    const playNotificationSound = () => {
      const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
      audio.play().catch(e => console.log("No se pudo reproducir sonido:", e));
    };

    // Desplazar el chat hacia abajo
    const scrollToBottom = () => {
      const chatMessages = document.getElementById("chatMessages");
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // Event listeners
    document.getElementById("sendMessageButton").addEventListener("click", () => {
      const message = document.getElementById("messageInput").value;
      sendMessage(message);
    });

    document.getElementById("messageInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        const message = document.getElementById("messageInput").value;
        sendMessage(message);
      }
    });

    document.getElementById("messageInput").addEventListener("input", (e) => {
      if (e.target.value.length > 0) {
        updateTypingStatus(true);
      } else {
        updateTypingStatus(false);
      }
    });

    document.getElementById("closeNotification").addEventListener("click", () => {
      document.getElementById("messageNotification").classList.remove("show");
    });

    document.getElementById("backButton").addEventListener("click", () => {
      window.history.back();
    });

    document.getElementById("toggleUserList").addEventListener("click", () => {
      document.getElementById("userListContainer").classList.toggle("active");
    });

    document.getElementById("menuButton").addEventListener("click", () => {
      document.getElementById("userListContainer").classList.toggle("active");
    });

    // Adjuntar archivos
    document.getElementById("attachFileButton").addEventListener("click", () => {
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*,audio/*,video/*";
      
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.type.startsWith("image/")) {
          selectedFile = file;
          showImagePreview(file);
        } else if (file.type.startsWith("audio/")) {
          sendAudio(file);
        } else if (file.type.startsWith("video/")) {
          sendVideo(file);
        } else {
          Swal.fire({
            title: 'Formato no soportado',
            text: 'Por favor, selecciona una imagen, audio o video',
            icon: 'error',
            background: '#1a1a2e',
            color: '#fff'
          });
        }
      });
      
      fileInput.click();
    });

    // Mostrar vista previa de imagen
    const showImagePreview = (file) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById("imagePreview").src = e.target.result;
        document.getElementById("imagePreviewModal").classList.add("active");
      };
      reader.readAsDataURL(file);
    };

    // Enviar imagen desde vista previa
    document.getElementById("sendImageButton").addEventListener("click", () => {
      if (selectedFile) {
        sendImage(selectedFile);
      }
    });

    // Cancelar envío de imagen
    document.getElementById("cancelImageButton").addEventListener("click", () => {
      document.getElementById("imagePreviewModal").classList.remove("active");
      selectedFile = null;
    });

    // Compartir archivo
    document.getElementById("confirmShareButton").addEventListener("click", () => {
      shareFileWithUsers();
    });

    // Cancelar compartir archivo
    document.getElementById("cancelShareButton").addEventListener("click", () => {
      document.getElementById("shareModal").classList.remove("active");
      fileToShare = null;
      fileTypeToShare = null;
      selectedUsersToShare = [];
    });

    // Cerrar modal de compartir
    document.getElementById("closeShareModal").addEventListener("click", () => {
      document.getElementById("shareModal").classList.remove("active");
      fileToShare = null;
      fileTypeToShare = null;
      selectedUsersToShare = [];
    });

    // Cerrar modal de información de usuario
    document.getElementById("closeUserInfoModal").addEventListener("click", () => {
      document.getElementById("userInfoModal").classList.remove("active");
    });

    // Funcionalidad de cámara
    document.getElementById("openCameraButton").addEventListener("click", () => {
      openCamera();
    });

    // Abrir cámara
    const openCamera = async () => {
      try {
        const constraints = {
          video: {
            facingMode: currentCameraFacing,
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        };
        
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById("camera-video");
        video.srcObject = cameraStream;
        
        document.getElementById("cameraModal").classList.add("active");
        document.getElementById("cameraPreviewActions").style.display = "none";
        
      } catch (error) {
        console.error("Error al acceder a la cámara:", error);
        Swal.fire({
          title: 'Error',
          text: 'No se pudo acceder a la cámara. Asegúrate de haber concedido los permisos.',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Capturar foto
    document.getElementById("captureButton").addEventListener("click", () => {
      const video = document.getElementById("camera-video");
      const canvas = document.getElementById("camera-canvas");
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      document.getElementById("cameraPreviewActions").style.display = "flex";
      
      cameraStream.getTracks().forEach(track => track.stop());
    });

    // Volver a tomar foto
    document.getElementById("retakePhotoButton").addEventListener("click", () => {
      openCamera();
    });

    // Enviar foto capturada
    document.getElementById("sendPhotoButton").addEventListener("click", async () => {
      const canvas = document.getElementById("camera-canvas");
      
      canvas.toBlob(async (blob) => {
        try {
          const file = new File([blob], `foto-${Date.now()}.jpg`, { type: 'image/jpeg' });
          await sendImage(file);
          
          document.getElementById("cameraModal").classList.remove("active");
          capturedPhoto = null;
          
        } catch (error) {
          console.error("Error al enviar foto:", error);
          Swal.fire({
            title: 'Error',
            text: 'No se pudo enviar la foto',
            icon: 'error',
            background: '#1a1a2e',
            color: '#fff'
          });
        }
      }, 'image/jpeg', 0.9);
    });

    // Cambiar cámara
    document.getElementById("switchCameraButton").addEventListener("click", () => {
      currentCameraFacing = currentCameraFacing === 'user' ? 'environment' : 'user';
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      openCamera();
    });

    // Cerrar cámara
    document.getElementById("closeCameraButton").addEventListener("click", () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      document.getElementById("cameraModal").classList.remove("active");
    });

    // Limpieza al cerrar la página
    window.addEventListener('beforeunload', () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      
      updateTypingStatus(false);
    });
  </script>
</body>

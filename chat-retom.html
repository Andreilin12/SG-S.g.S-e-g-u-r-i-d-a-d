<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Chat Futurista</title>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <!-- SweetAlert2 para notificaciones -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <style>
    :root {
      --primary: #15a086;
      --secondary: #16e086;
      --dark: #2c3e50;
      --light: #fff;
      --accent: #15a086;
      --success: #fff;
      --info: #0095ff;
      --warning: #15a086;
      --danger: #15a086;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      display: flex;
      height: 100vh;
      background-color: var(--dark);
      font-family: 'Orbitron', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      color: var(--light);
    }

    /* Efectos de fondo */
    .glow-effect {
      position: fixed;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(123, 45, 255, 0.2) 0%, transparent 70%);
      filter: blur(50px);
      z-index: -1;
    }

    .glow-1 {
      top: -100px;
      left: -100px;
    }

    .glow-2 {
      bottom: -100px;
      right: -100px;
      background: radial-gradient(circle, rgba(0, 247, 255, 0.2) 0%, transparent 70%);
    }

    .container {
      display: flex;
      width: 100%;
      height: 100%;
      flex-direction: column;
    }

    /* Ventana de usuarios */
    .user-list {
      width: 100%;
      background-color: rgba(20, 20, 40, 0.8);
      border-right: 1px solid rgba(0, 247, 255, 0.1);
      overflow-y: auto;
      padding: 20px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      display: none;
    }

    .user-list.active {
      display: block;
    }

    .user-list h2 {
      margin-bottom: 20px;
      font-size: 24px;
      color: var(--primary);
      text-shadow: 0 0 10px var(--primary);
      letter-spacing: 1px;
    }

    /* Buscador de usuarios */
    .user-search {
      position: relative;
      margin-bottom: 20px;
    }

    .user-search input {
      width: 100%;
      padding: 10px 15px 10px 40px;
      background-color: rgba(30, 30, 60, 0.7);
      border: 1px solid rgba(0, 247, 255, 0.2);
      border-radius: 25px;
      color: var(--light);
      outline: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .user-search i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
    }

    .user-list ul {
      list-style: none;
      padding: 0;
    }

    .user-list li {
      display: flex;
      align-items: center;
      padding: 15px;
      border-radius: 12px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: all 0.3s ease;
      position: relative;
      background-color: rgba(30, 30, 60, 0.5);
      border: 1px solid rgba(0, 247, 255, 0.1);
    }

    .user-list li:hover {
      background-color: rgba(0, 247, 255, 0.2);
      transform: translateX(5px);
    }

    .user-list li.active {
      background-color: rgba(0, 247, 255, 0.3);
      border-left: 4px solid var(--primary);
    }

    .user-list img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
      border: 2px solid var(--primary);
      box-shadow: 0 0 10px var(--primary);
    }

    .user-list .unread {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 12px;
      height: 12px;
      background-color: var(--danger);
      border-radius: 50%;
      box-shadow: 0 0 5px var(--danger);
    }

    .user-list .user-info {
      flex: 1;
    }

    .user-list .user-name {
      font-weight: bold;
      margin-bottom: 3px;
    }

    .user-list .user-status {
      font-size: 12px;
      color: var(--primary);
      display: flex;
      align-items: center;
    }

    .user-list .typing-indicator {
      font-size: 12px;
      color: var(--success);
      font-style: italic;
    }

    .user-list .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--success);
      margin-right: 5px;
    }

    .user-list .last-activity {
      font-size: 10px;
      color: rgba(224, 224, 255, 0.6);
      margin-top: 3px;
    }

    /* Ventana de chat */
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: rgba(10, 10, 30, 0.7);
      backdrop-filter: blur(10px);
      position: relative;
    }

    /* Cabecera del chat */
    .chat-header {
      background-color: rgba(20, 20, 50, 0.8);
      color: var(--light);
      padding: 15px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid rgba(0, 247, 255, 0.1);
      position: relative;
      z-index: 10;
    }

    .chat-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 15px;
      border: 2px solid var(--primary);
      box-shadow: 0 0 15px var(--primary);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .chat-header img:hover {
      transform: scale(1.1);
    }

    .chat-header span {
      font-size: 18px;
      font-weight: bold;
      color: var(--primary);
      cursor: pointer;
      flex: 1;
    }

    .chat-header .online-status {
      position: absolute;
      bottom: 10px;
      left: 55px;
      width: 12px;
      height: 12px;
      background-color: var(--success);
      border-radius: 50%;
      border: 2px solid var(--dark);
    }

    .chat-header .menu-button {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 1.5em;
      cursor: pointer;
      margin-left: 10px;
    }

    /* Mensajes del chat */
    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background-color: rgba(10, 10, 20, 0.5);
      display: flex;
      flex-direction: column;
      padding-bottom: 80px;
    }

    .message {
      margin: 10px 0;
      max-width: 80%;
      padding: 12px;
      border-radius: 15px;
      position: relative;
      display: flex;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease-out;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message:hover {
      transform: scale(1.02);
    }

    .message.received {
      background: linear-gradient(135deg, rgba(0, 150, 136, 0.8), rgba(0, 100, 136, 0.8));
      text-align: left;
      margin-right: auto;
      color: white;
      border-top-left-radius: 5px;
    }

    .message.sent {
      background: linear-gradient(135deg, rgba(0, 200, 136, 0.8), rgba(0, 150, 200, 0.8));
      text-align: right;
      margin-left: auto;
      color: white;
      border-top-right-radius: 5px;
    }

    .message-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 10px;
      margin-top: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .message-image:hover {
      transform: scale(1.05);
    }

    .message-audio {
      width: 100%;
      margin-top: 5px;
      border-radius: 10px;
      background-color: rgba(0, 0, 0, 0.3);
    }

    .message-video {
      max-width: 100%;
      max-height: 300px;
      border-radius: 10px;
      margin-top: 5px;
      cursor: pointer;
    }

    .message-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
      border: 2px solid var(--primary);
      align-self: flex-start;
    }

    .message-content {
      flex: 1;
    }

    .message-text {
      margin-bottom: 5px;
      line-height: 1.4;
    }

    .message-time {
      font-size: 0.7em;
      opacity: 0.8;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-top: 5px;
    }

    .message-actions {
      position: absolute;
      top: 5px;
      right: 5px;
      display: none;
    }

    .message:hover .message-actions {
      display: flex;
      gap: 5px;
    }

    .message-action {
      background-color: rgba(255, 255, 255, 0.2);
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .message-action:hover {
      background-color: var(--primary);
      transform: scale(1.1);
    }

    .seen-indicator {
      color: var(--info);
      margin-left: 5px;
    }

    /* Barra de entrada de mensaje */
    .chat-input-container {
      padding: 10px;
      background-color: rgba(20, 20, 50, 0.9);
      border-top: 1px solid rgba(0, 247, 255, 0.1);
      display: flex;
      align-items: center;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);
    }

    .chat-input-tools {
      display: flex;
      gap: 8px;
      margin-right: 8px;
    }

    .chat-input-tools button {
      background-color: transparent;
      border: none;
      font-size: 1.3em;
      cursor: pointer;
      color: var(--primary);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .chat-input-tools button:hover {
      background-color: rgba(0, 247, 255, 0.2);
      transform: scale(1.1);
    }

    .chat-input {
      flex: 1;
      display: flex;
      align-items: center;
      background-color: rgba(30, 30, 60, 0.7);
      border-radius: 25px;
      padding: 5px 12px;
      border: 1px solid rgba(0, 247, 255, 0.2);
    }

    .chat-input textarea {
      flex: 1;
      resize: none;
      padding: 8px;
      border: none;
      background: transparent;
      color: var(--light);
      font-size: 0.9em;
      max-height: 100px;
      min-height: 36px;
      outline: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .chat-input textarea::placeholder {
      color: rgba(224, 224, 255, 0.5);
    }

    .chat-input button {
      background-color: var(--primary);
      color: var(--dark);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-left: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-input button:hover {
      background-color: var(--success);
      transform: scale(1.1);
    }

    /* Modal de vista previa de imagen */
    .image-preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .image-preview-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .image-preview-container {
      position: relative;
      max-width: 90%;
      max-height: 80%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .image-preview {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0, 247, 255, 0.3);
    }

    .image-preview-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .image-preview-btn {
      padding: 10px 20px;
      border-radius: 25px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
    }

    .image-preview-btn.send {
      background-color: var(--success);
      color: var(--dark);
    }

    .image-preview-btn.cancel {
      background-color: var(--danger);
      color: white;
    }

    .image-preview-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    /* Notificaci√≥n de nuevo mensaje */
    .message-notification {
      position: fixed;
      bottom: 70px;
      right: 10px;
      background-color: rgba(20, 20, 50, 0.9);
      border: 1px solid var(--primary);
      border-radius: 15px;
      padding: 12px;
      max-width: 280px;
      display: flex;
      align-items: center;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      transform: translateX(150%);
      transition: transform 0.3s ease;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .message-notification.show {
      transform: translateX(0);
    }

    .notification-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 12px;
      border: 2px solid var(--primary);
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--primary);
      font-size: 14px;
    }

    .notification-text {
      font-size: 12px;
      opacity: 0.9;
    }

    .notification-close {
      background: none;
      border: none;
      color: var(--light);
      font-size: 16px;
      cursor: pointer;
      margin-left: 8px;
    }

    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(10, 10, 30, 0.5);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--success);
    }

    /* Animaciones */
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    .pulse {
      animation: pulse 2s infinite ease-in-out;
    }

    /* Efecto de ne√≥n para t√≠tulos */
    .neon-text {
      text-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary), 0 0 20px var(--primary);
    }

    /* Modal de c√°mara */
    .camera-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .camera-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .camera-container {
      position: relative;
      width: 95%;
      max-width: 500px;
      height: 60vh;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(0, 247, 255, 0.3);
    }

    #camera-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      padding-bottom: 20px;
    }

    .camera-actions {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }

    .camera-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.2);
      border: 2px solid var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .camera-btn.capture {
      background-color: var(--danger);
      border-color: var(--danger);
      width: 60px;
      height: 60px;
    }

    .camera-btn:hover {
      transform: scale(1.1);
      background-color: var(--primary);
    }

    .camera-preview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }

    .camera-preview.active {
      display: block;
    }

    .camera-preview-actions {
      position: absolute;
      bottom: 15px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    /* Loading futurista */
    .futuristic-loader {
      display: flex;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(10, 10, 30, 0.8);
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .loader-content {
      text-align: center;
    }

    .loader-spinner {
      width: 80px;
      height: 80px;
      border: 5px solid rgba(0, 247, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
      box-shadow: 0 0 20px var(--primary);
    }

    .loader-text {
      color: var(--primary);
      font-size: 18px;
      text-shadow: 0 0 10px var(--primary);
      letter-spacing: 2px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Iconos para tipos de archivo */
    .file-type-icon {
      font-size: 24px;
      margin-right: 10px;
      color: var(--primary);
    }

    .back-button {
      position: fixed;
      top: 15px;
      left: 15px;
      background-color: var(--primary);
      color: var(--dark);
      border: none;
      border-radius: 50px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      z-index: 1000;
      box-shadow: 0 0 15px var(--primary);
    }

    .back-button:hover {
      background-color: var(--success);
      transform: translateY(-3px);
    }

    /* Modal para compartir imagen */
    .share-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .share-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .share-modal-container {
      background-color: rgba(20, 20, 50, 0.9);
      border-radius: 15px;
      padding: 15px;
      width: 95%;
      max-width: 500px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 30px rgba(0, 247, 255, 0.3);
    }

    .share-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0, 247, 255, 0.2);
    }

    .share-modal-title {
      font-size: 1.3em;
      color: var(--primary);
    }

    .share-modal-close {
      background: none;
      border: none;
      color: var(--light);
      font-size: 1.3em;
      cursor: pointer;
    }

    .share-modal-search {
      position: relative;
      margin-bottom: 15px;
    }

    .share-modal-search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
      cursor: pointer;
    }

    .share-modal-search-input {
      width: 100%;
      padding: 8px 8px 8px 35px;
      background-color: rgba(30, 30, 60, 0.7);
      border: 1px solid rgba(0, 247, 255, 0.2);
      border-radius: 25px;
      color: var(--light);
      outline: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .share-modal-users {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    .share-modal-user {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 10px;
      cursor: pointer;
      margin-bottom: 8px;
      transition: all 0.3s ease;
      background-color: rgba(30, 30, 60, 0.5);
      border: 1px solid rgba(0, 247, 255, 0.1);
    }

    .share-modal-user:hover {
      background-color: rgba(0, 247, 255, 0.2);
    }

    .share-modal-user.selected {
      background-color: rgba(0, 247, 255, 0.3);
      border-left: 4px solid var(--primary);
    }

    .share-modal-user img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      margin-right: 12px;
      object-fit: cover;
      border: 2px solid var(--primary);
    }

    .share-modal-user-info {
      flex: 1;
    }

    .share-modal-user-name {
      font-weight: bold;
      font-size: 14px;
    }

    .share-modal-user-status {
      font-size: 11px;
      color: var(--primary);
      display: flex;
      align-items: center;
    }

    .share-modal-user-status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background-color: var(--success);
      margin-right: 5px;
    }

    .share-modal-checkbox {
      margin-left: 12px;
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
      cursor: pointer;
    }

    .share-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .share-modal-btn {
      padding: 10px 20px;
      border-radius: 25px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: bold;
    }

    .share-modal-btn.send {
      background-color: var(--success);
      color: var(--dark);
    }

    .share-modal-btn.cancel {
      background-color: var(--danger);
      color: white;
    }

    .share-modal-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    /* Modal de informaci√≥n de usuario */
    .user-info-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .user-info-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .user-info-container {
      background-color: rgba(20, 20, 50, 0.9);
      border-radius: 15px;
      padding: 20px;
      width: 95%;
      max-width: 500px;
      box-shadow: 0 0 30px rgba(0, 247, 255, 0.3);
    }

    .user-info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(0, 247, 255, 0.2);
    }

    .user-info-title {
      font-size: 1.3em;
      color: var(--primary);
    }

    .user-info-close {
      background: none;
      border: none;
      color: var(--light);
      font-size: 1.3em;
      cursor: pointer;
    }

    .user-info-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .user-info-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 12px;
      object-fit: cover;
      border: 3px solid var(--primary);
      box-shadow: 0 0 20px var(--primary);
    }

    .user-info-field {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(0, 247, 255, 0.1);
      font-size: 14px;
    }

    .user-info-label {
      font-weight: bold;
      color: var(--primary);
      min-width: 100px;
    }

    .user-info-value {
      flex: 1;
      text-align: right;
      word-break: break-word;
    }

    /* Estilo para el bot√≥n de copiar */
    .copy-btn {
      background-color: rgba(0, 247, 255, 0.2);
      border: none;
      color: var(--primary);
      padding: 4px 8px;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 8px;
      font-size: 11px;
      transition: all 0.2s;
    }

    .copy-btn:hover {
      background-color: rgba(0, 247, 255, 0.4);
    }

    /* Estilo para los checks de mensaje le√≠do */
    .read-status {
      display: flex;
      align-items: center;
      margin-left: 5px;
    }

    .read-check {
      color: var(--info);
      font-size: 11px;
      margin-left: 2px;
    }

    /* Reproductor de audio personalizado futurista */
    .audio-player-container {
      position: relative;
      width: 100%;
      margin-top: 5px;
      background: linear-gradient(135deg, rgba(30, 30, 60, 0.8), rgba(20, 20, 50, 0.8));
      border-radius: 15px;
      padding: 10px;
      box-shadow: 0 0 15px rgba(0, 247, 255, 0.2);
      display: flex;
      align-items: center;
    }

    .audio-icon {
      font-size: 24px;
      color: var(--primary);
      margin-right: 10px;
      text-shadow: 0 0 10px var(--primary);
    }

    .audio-player {
      flex: 1;
      height: 30px;
      -webkit-appearance: none;
      background: transparent;
    }

    .audio-player::-webkit-slider-runnable-track {
      height: 4px;
      background: rgba(0, 247, 255, 0.3);
      border-radius: 2px;
    }

    .audio-player::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: var(--primary);
      margin-top: -5px;
      cursor: pointer;
      box-shadow: 0 0 5px var(--primary);
    }

    .audio-time {
      font-size: 12px;
      color: var(--primary);
      margin-left: 10px;
      min-width: 50px;
      text-align: right;
    }

    /* Reproductor de video personalizado futurista */
    .video-player-container {
      position: relative;
      width: 100%;
      max-height: 300px;
      margin-top: 5px;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0, 247, 255, 0.3);
    }

    .video-player {
      width: 100%;
      height: 100%;
      background-color: #000;
    }

    .video-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
      padding: 10px;
      display: flex;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .video-player-container:hover .video-controls {
      opacity: 1;
    }

    .video-control-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 16px;
      margin: 0 5px;
      cursor: pointer;
      text-shadow: 0 0 5px var(--primary);
    }

    .video-progress {
      flex: 1;
      height: 4px;
      background: rgba(0, 247, 255, 0.3);
      border-radius: 2px;
      margin: 0 10px;
      position: relative;
    }

    .video-progress-filled {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--primary);
      border-radius: 2px;
    }

    .video-time {
      font-size: 12px;
      color: var(--primary);
      margin-left: 5px;
      min-width: 80px;
      text-align: center;
    }

    /* Media queries para dispositivos m√≥viles */
    @media (min-width: 768px) {
      .container {
        flex-direction: row;
      }
      
      .user-list {
        width: 30%;
        display: block;
      }
      
      .chat-header .menu-button {
        display: none;
      }
      
      .chat-messages {
        padding-bottom: 15px;
      }
      
      .chat-input-container {
        position: relative;
        bottom: auto;
      }
    }

    @media (max-width: 767px) {
      .chat-header {
        padding: 10px;
      }
      
      .chat-header img {
        width: 35px;
        height: 35px;
      }
      
      .chat-header span {
        font-size: 16px;
      }
      
      .message {
        max-width: 85%;
        padding: 10px;
      }
      
      .message-avatar {
        width: 30px;
        height: 30px;
      }
      
      .image-preview-btn, .share-modal-btn {
        padding: 8px 15px;
        font-size: 13px;
      }
    }

    /* Bot√≥n para alternar lista de usuarios en m√≥vil */
    .toggle-user-list {
      display: none;
      position: fixed;
      bottom: 70px;
      right: 15px;
      background-color: var(--primary);
      color: var(--dark);
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      z-index: 90;
      box-shadow: 0 0 15px var(--primary);
    }

    @media (max-width: 767px) {
      .toggle-user-list {
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
    
    /* Estilos para el modal de emojis */
    .emoji-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .emoji-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .emoji-modal-container {
      background-color: #2c3e50;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      max-height: 60vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      border: 1px solid #15a086;
      overflow: hidden;
    }

    .emoji-categories {
      display: flex;
      padding: 10px;
      background-color: # 15a086;
      overflow-x: auto;
      border-bottom: 1px solid #15a086;
    }

    .emoji-category-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .emoji-category-btn:hover {
      background-color: rgba(0, 255, 255, 0.2);
    }

    .emoji-category-btn.active {
      background-color: #15a086;
      color: #fff;
    }

    .emoji-container {
      flex: 1;
      padding: 10px;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 5px;
      overflow-y: auto;
    }

    .emoji-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      padding: 5px;
      cursor: pointer;
      border-radius: 5px;
      transition: transform 0.2s, background-color 0.2s;
    }

    .emoji-btn:hover {
      background-color: rgba(0, 255, 255, 0.2);
      transform: scale(1.2);
    }

    .emoji-close-btn {
      padding: 10px;
      background-color: #15a086;
      color: #fff;
      border: none;
      border-radius: 0 0 10px 10px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: background-color 0.3s;
    }

    .emoji-close-btn:hover {
      background-color: #2c3e50;
    }

    /* Estilos para el bot√≥n de emojis en el chat */
    #emojiButton {
      background: none;
      border: none;
      color: #15a086;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.3s;
    }

    #emojiButton:hover {
      background-color: rgba(0, 255, 255, 0.2);
    }

    /* Estilos para el input de mensaje */
    .chat-input {
      position: relative;
    }

    /* Estilos para las im√°genes en los mensajes */
    .message-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 10px;
      margin-top: 5px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .message-image:hover {
      transform: scale(1.02);
    }

    /* Animaci√≥n para mensajes no le√≠dos */
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 255, 255, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(0, 255, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 255, 255, 0); }
    }
  </style>
</head>
<body>
  <!-- Efectos de fondo -->
  <div class="glow-effect glow-1"></div>
  <div class="glow-effect glow-2"></div>

  <!-- Loading futurista -->
  <div class="futuristic-loader" id="loader">
    <div class="loader-content">
      <div class="loader-spinner"></div>
      <div class="loader-text">Cargando...</div>
    </div>
  </div>

  <!-- Bot√≥n para alternar lista de usuarios en m√≥vil -->
  <button class="toggle-user-list" id="toggleUserList">
    <i class="fas fa-users"></i>
  </button>

  <div class="container">
    <!-- Ventana Izquierda: Lista de Usuarios -->
    <div class="user-list" id="userListContainer">  
      <h2 class="neon-text">Contactos</h2>
      <div class="user-search">
        <i class="fas fa-search"></i>
        <input type="text" id="userSearchInput" placeholder="Buscar contactos...">
      </div>
      <ul id="userList"></ul>
    </div>

    <!-- Ventana Derecha: Chat -->
    <div class="chat-window">
      <div class="chat-header">
        <img id="chatUserImage" src="https://firebasestorage.googleapis.com/v0/b/inventario-35d6b.appspot.com/o/RETOM%20COMPLETO%20(1).png?alt=media&token=55cc155d-a70b-463d-a723-6fb646cde75c" alt="Usuario">
        <span id="chatUserName">Chat Futurista</span>
        <div class="online-status"></div>
        <button class="menu-button" id="menuButton">
          <i class="fas fa-ellipsis-v"></i>
        </button>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-container">
        <div class="chat-input-tools">
          <button id="attachFileButton" title="Adjuntar archivo">
            <i class="fas fa-paperclip"></i>
          </button>
          <button id="openCameraButton" title="Abrir c√°mara">
            <i class="fas fa-camera"></i>
          </button>
          <button id="emojiButton" title="Insertar emoji">
            <i class="far fa-smile"></i>
          </button>
        </div>
        <div class="chat-input">
          <textarea id="messageInput" placeholder="Escribe un mensaje..."></textarea>
          <button id="sendMessageButton">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de vista previa de imagen -->
  <div class="image-preview-modal" id="imagePreviewModal">
    <div class="image-preview-container">
      <img class="image-preview" id="imagePreview" src="" alt="Vista previa">
      <div class="image-preview-actions">
        <button class="image-preview-btn send" id="sendImageButton">
          <i class="fas fa-paper-plane"></i> Enviar
        </button>
        <button class="image-preview-btn cancel" id="cancelImageButton">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de emojis -->
  <div class="emoji-modal" id="emojiModal">
    <div class="emoji-modal-container">
      <div class="emoji-categories">
        <button class="emoji-category-btn active" data-category="smileys">üòÄ</button>
        <button class="emoji-category-btn" data-category="animals">üêª</button>
        <button class="emoji-category-btn" data-category="food">üçé</button>
        <button class="emoji-category-btn" data-category="activities">‚öΩ</button>
        <button class="emoji-category-btn" data-category="travel">üöó</button>
        <button class="emoji-category-btn" data-category="objects">üí°</button>
        <button class="emoji-category-btn" data-category="symbols">‚ù§Ô∏è</button>
        <button class="emoji-category-btn" data-category="flags">üá∫üá∏</button>
      </div>
      <div class="emoji-container" id="emojiContainer"></div>
      <button class="emoji-close-btn" id="closeEmojiModal">
        <i class="fas fa-times"></i> Cerrar
      </button>
    </div>
  </div>

  <!-- Modal de informaci√≥n de usuario -->
  <div class="user-info-modal" id="userInfoModal">
    <div class="user-info-container">
      <div class="user-info-header">
        <div class="user-info-title">Informaci√≥n del Usuario</div>
        <button class="user-info-close" id="closeUserInfoModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="user-info-content">
        <img class="user-info-avatar" id="userInfoAvatar" src="" alt="Avatar">
        <div class="user-info-field">
          <span class="user-info-label">Nombre:</span>
          <span class="user-info-value" id="userInfoName"></span>
        </div>
        <div class="user-info-field">
          <span class="user-info-label">Departamento:</span>
          <span class="user-info-value" id="userInfoDepartment"></span>
        </div>
        <div class="user-info-field">
          <span class="user-info-label">√Årea de trabajo:</span>
          <span class="user-info-value" id="userInfoWorkArea"></span>
        </div>
        <div class="user-info-field">
          <span class="user-info-label">Posici√≥n:</span>
          <span class="user-info-value" id="userInfoPosition"></span>
        </div>
        <div class="user-info-field">
          <span class="user-info-label">Fecha de nacimiento:</span>
          <span class="user-info-value" id="userInfoBirthDate"></span>
        </div>
        <div class="user-info-field">
          <span class="user-info-label">Correo:</span>
          <span class="user-info-value" id="userInfoEmail"></span>
        </div>
        <div class="user-info-field">
          <span class="user-info-label">C√≥digo de trabajo:</span>
          <span class="user-info-value" id="userInfoWorkCode"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de c√°mara -->
  <div class="camera-modal" id="cameraModal">
    <div class="camera-container">
      <video id="camera-video" autoplay playsinline></video>
      <canvas id="camera-canvas" class="camera-preview"></canvas>
      <div class="camera-overlay">
        <div class="camera-actions">
          <button class="camera-btn" id="switchCameraButton">
            <i class="fas fa-sync-alt"></i>
          </button>
          <button class="camera-btn capture" id="captureButton">
            <i class="fas fa-camera"></i>
          </button>
          <button class="camera-btn" id="closeCameraButton">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="camera-preview-actions" id="cameraPreviewActions" style="display: none;">
        <button class="image-preview-btn send" id="sendPhotoButton">
          <i class="fas fa-check"></i> Enviar
        </button>
        <button class="image-preview-btn cancel" id="retakePhotoButton">
          <i class="fas fa-redo"></i> Volver a tomar
        </button>
      </div>
    </div>
  </div>

  <!-- Notificaci√≥n de nuevo mensaje -->
  <div class="message-notification" id="messageNotification">
    <img class="notification-avatar" id="notificationAvatar" src="" alt="Usuario">
    <div class="notification-content">
      <div class="notification-title" id="notificationTitle"></div>
      <div class="notification-text" id="notificationText"></div>
    </div>
    <button class="notification-close" id="closeNotification">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      addDoc, 
      onSnapshot, 
      query, 
      orderBy, 
      doc, 
      updateDoc,
      deleteDoc,
      serverTimestamp,
      where,
      limit
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { 
      getAuth, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { 
      getStorage, 
      ref, 
      uploadBytes, 
      getDownloadURL,
      deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
      authDomain: "inventario-35d6b.firebaseapp.com",
      projectId: "inventario-35d6b",
      storageBucket: "inventario-35d6b.appspot.com",
      messagingSenderId: "266100399659",
      appId: "1:266100399659:web:92358d28cbd803c8a7d46e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // Variables de estado
    let activeUser = null;
    let activeUserId = null;
    let activeChatId = null;
    let users = {};
    let cameraStream = null;
    let currentCameraFacing = 'environment';
    let selectedFile = null;
    let capturedPhoto = null;
    let userActivity = {};

    // Mostrar loader
    const showLoader = () => {
      document.getElementById("loader").style.display = "flex";
    };

    // Ocultar loader
    const hideLoader = () => {
      document.getElementById("loader").style.display = "none";
    };

    // Inicializar la aplicaci√≥n cuando el usuario est√© autenticado
    onAuthStateChanged(auth, (user) => {
      if (user) {
        activeUser = user.uid;
        loadUsers();
        setupMessageNotifications();
        hideLoader();
      } else {
        Swal.fire({
          title: 'Acceso requerido',
          text: 'Por favor, inicia sesi√≥n para usar el chat',
          icon: 'warning',
          confirmButtonText: 'Ir a login',
          background: '#1a1a2e',
          color: '#fff'
        }).then(() => {
          window.location.href = "index.html";
        });
      }
    });

    // Cargar lista de usuarios con informaci√≥n adicional
    const loadUsers = async () => {
      showLoader();
      const usersSnapshot = await getDocs(collection(db, "users"));
      const userList = document.getElementById("userList");
      userList.innerHTML = "";

      let usersArray = [];

      usersSnapshot.forEach((doc) => {
        const user = doc.data();
        const userId = doc.id;
        users[userId] = user;
        userActivity[userId] = { lastActivity: 0 };

        if (userId !== activeUser) {
          usersArray.push({ userId, ...user });
        }
      });

      await loadUserActivities(usersArray);
      hideLoader();
    };

    // Cargar la √∫ltima actividad de cada usuario
    const loadUserActivities = async (usersArray) => {
      const userList = document.getElementById("userList");
      
      for (const userData of usersArray) {
        const userId = userData.userId;
        const chatId = getChatId(activeUser, userId);
        
        const messagesRef = collection(db, `chats/${chatId}/messages`);
        const q = query(messagesRef, orderBy("timestamp", "desc"), limit(1));
        
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach((doc) => {
          const message = doc.data();
          userActivity[userId] = {
            lastActivity: message.timestamp?.toMillis() || 0,
            lastMessage: message.text || "Archivo enviado"
          };
        });
      }

      usersArray.sort((a, b) => {
        return (userActivity[b.userId]?.lastActivity || 0) - (userActivity[a.userId]?.lastActivity || 0);
      });

      displaySortedUsers(usersArray);
    };

    // Mostrar usuarios ordenados por actividad
    const displaySortedUsers = (usersArray) => {
      const userList = document.getElementById("userList");
      userList.innerHTML = "";

      usersArray.forEach(userData => {
        const userId = userData.userId;
        const user = users[userId];
        
        const li = document.createElement("li");
        li.dataset.userId = userId;
        
        const img = document.createElement("img");
        img.src = user.photoURL || "https://via.placeholder.com/40";
        img.alt = user.name;
        
        const userInfo = document.createElement("div");
        userInfo.className = "user-info";
        
        const userName = document.createElement("div");
        userName.className = "user-name";
        userName.textContent = user.name;
        
        const userStatus = document.createElement("div");
        userStatus.className = "user-status";
        
        const statusDot = document.createElement("div");
        statusDot.className = "status-dot";
        
        const statusText = document.createElement("span");
        statusText.textContent = "En l√≠nea";
        
        userStatus.appendChild(statusDot);
        userStatus.appendChild(statusText);
        
        const typingIndicator = document.createElement("div");
        typingIndicator.className = "typing-indicator";
        typingIndicator.style.display = "none";
        typingIndicator.textContent = "escribiendo...";
        
        const lastActivity = document.createElement("div");
        lastActivity.className = "last-activity";
        if (userActivity[userId]?.lastActivity) {
          const lastDate = new Date(userActivity[userId].lastActivity);
          lastActivity.textContent = `√öltima actividad: ${lastDate.toLocaleString()}`;
        } else {
          lastActivity.textContent = "Sin actividad reciente";
        }
        
        userInfo.appendChild(userName);
        userInfo.appendChild(userStatus);
        userInfo.appendChild(typingIndicator);
        userInfo.appendChild(lastActivity);
        
        li.appendChild(img);
        li.appendChild(userInfo);
        
        const unreadIndicator = document.createElement("div");
        unreadIndicator.className = "unread";
        unreadIndicator.style.display = "none";
        li.appendChild(unreadIndicator);
        
        li.addEventListener("click", () => {
          openChat(userId);
          if (window.innerWidth <= 767) {
            document.getElementById("userListContainer").classList.remove("active");
          }
        });
        
        userName.addEventListener("click", (e) => {
          e.stopPropagation();
          showUserInfo(userId);
        });
        
        img.addEventListener("click", (e) => {
          e.stopPropagation();
          showUserInfo(userId);
        });
        
        userList.appendChild(li);
        
        listenForTyping(userId, typingIndicator);
        checkUnreadMessages(userId, unreadIndicator);
      });

      document.getElementById("userSearchInput").addEventListener("input", (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const userElements = document.querySelectorAll("#userList li");
        
        userElements.forEach(userElement => {
          const userName = userElement.querySelector(".user-name").textContent.toLowerCase();
          if (userName.includes(searchTerm)) {
            userElement.style.display = "flex";
          } else {
            userElement.style.display = "none";
          }
        });
      });
    };

    // Mostrar informaci√≥n detallada del usuario
    const showUserInfo = (userId) => {
      const user = users[userId];
      if (!user) return;
      
      document.getElementById("userInfoAvatar").src = user.photoURL || "https://via.placeholder.com/100";
      document.getElementById("userInfoName").textContent = user.name || "No disponible";
      document.getElementById("userInfoDepartment").textContent = user.department || "No disponible";
      document.getElementById("userInfoWorkArea").textContent = user.workArea || "No disponible";
      document.getElementById("userInfoPosition").textContent = user.position || "No disponible";
      document.getElementById("userInfoBirthDate").textContent = user.birthDate || "No disponible";
      document.getElementById("userInfoEmail").textContent = user.email || "No disponible";
      document.getElementById("userInfoWorkCode").textContent = user.workCode || "No disponible";
      
      const copyButtons = document.querySelectorAll('.copy-btn');
      copyButtons.forEach(btn => btn.remove());
      
      const fields = ['userInfoName', 'userInfoDepartment', 'userInfoWorkArea', 
                     'userInfoPosition', 'userInfoBirthDate', 'userInfoEmail', 'userInfoWorkCode'];
      
      fields.forEach(fieldId => {
        const fieldElement = document.getElementById(fieldId);
        const value = fieldElement.textContent;
        
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.innerHTML = '<i class="far fa-copy"></i>';
        copyBtn.title = 'Copiar';
        copyBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(value).then(() => {
            Swal.fire({
              title: 'Copiado',
              text: 'El texto ha sido copiado al portapapeles',
              icon: 'success',
              timer: 1500,
              showConfirmButton: false,
              background: '#1a1a2e',
              color: '#fff'
            });
          });
        });
        
        fieldElement.parentNode.insertBefore(copyBtn, fieldElement.nextSibling);
      });
      
      document.getElementById("userInfoModal").classList.add("active");
    };

    // Abrir chat con un usuario
    const openChat = async (userId) => {
      showLoader();
      activeUserId = userId;
      activeChatId = getChatId(activeUser, userId);
      
      const user = users[userId];
      document.getElementById("chatUserName").textContent = user.name;
      document.getElementById("chatUserImage").src = user.photoURL || "https://via.placeholder.com/40";
      
      document.getElementById("chatUserName").addEventListener("click", () => showUserInfo(userId));
      document.getElementById("chatUserImage").addEventListener("click", () => showUserInfo(userId));
      
      await markMessagesAsRead();
      
      const userItem = document.querySelector(`li[data-user-id="${userId}"] .unread`);
      if (userItem) {
        userItem.style.display = "none";
      }
      
      loadMessages();
      hideLoader();
    };

    // Marcar mensajes como le√≠dos
    const markMessagesAsRead = async () => {
      if (!activeChatId) return;
      
      const messagesRef = collection(db, `chats/${activeChatId}/messages`);
      const q = query(messagesRef, where("sender", "==", activeUserId), where("read", "==", false));
      
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach(async (doc) => {
        await updateDoc(doc.ref, {
          read: true,
          readTime: serverTimestamp()
        });
      });
    };

    // Verificar mensajes no le√≠dos
    const checkUnreadMessages = (userId, unreadIndicator) => {
      const chatId = getChatId(activeUser, userId);
      const messagesRef = collection(db, `chats/${chatId}/messages`);
      const q = query(messagesRef, where("sender", "==", userId), where("read", "==", false));
      
      onSnapshot(q, (snapshot) => {
        unreadIndicator.style.display = snapshot.size > 0 ? "block" : "none";
      });
    };

    // Escuchar cambios de estado de escritura
    const listenForTyping = (userId, typingIndicator) => {
      const typingRef = doc(db, `typing/${getChatId(activeUser, userId)}`);
      
      onSnapshot(typingRef, (doc) => {
        const typingData = doc.data();
        if (typingData && typingData[userId] && typingData[userId].typing) {
          typingIndicator.style.display = "block";
        } else {
          typingIndicator.style.display = "none";
        }
      });
    };

    // Cargar mensajes del chat
    const loadMessages = () => {
      if (!activeChatId) return;
      
      const messagesQuery = query(
        collection(db, `chats/${activeChatId}/messages`), 
        orderBy("timestamp")
      );
      
      onSnapshot(messagesQuery, (snapshot) => {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = "";
        
        snapshot.forEach((doc) => {
          const message = doc.data();
          addMessageToChat(message, doc.id);
        });
        
        scrollToBottom();
      });
    };

    // A√±adir mensaje al chat
    const addMessageToChat = (message, messageId) => {
      const chatMessages = document.getElementById("chatMessages");
      const isSent = message.sender === activeUser;
      
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
      messageDiv.dataset.messageId = messageId;
      
      const avatar = document.createElement("img");
      avatar.className = "message-avatar";
      avatar.src = isSent ? 
        (users[activeUser]?.photoURL || "https://via.placeholder.com/40") : 
        (users[activeUserId]?.photoURL || "https://via.placeholder.com/40");
      messageDiv.appendChild(avatar);
      
      const contentDiv = document.createElement("div");
      contentDiv.className = "message-content";
      
      if (message.text) {
        const textDiv = document.createElement("div");
        textDiv.className = "message-text";
        textDiv.textContent = message.text;
        contentDiv.appendChild(textDiv);
      }
      
      if (message.imageUrl) {
        const imgDiv = document.createElement("img");
        imgDiv.className = "message-image";
        imgDiv.src = message.imageUrl;
        imgDiv.alt = "Imagen enviada";
        
        imgDiv.addEventListener("click", () => {
          Swal.fire({
            imageUrl: message.imageUrl,
            imageAlt: 'Imagen del chat',
            background: '#1a1a2e',
            showConfirmButton: false,
            showCloseButton: true
          });
        });
        
        contentDiv.appendChild(imgDiv);
      }
      
      if (message.audioUrl) {
        const audioContainer = document.createElement("div");
        audioContainer.className = "audio-player-container";
        
        const audioIcon = document.createElement("i");
        audioIcon.className = "fas fa-music audio-icon";
        audioContainer.appendChild(audioIcon);
        
        const audioPlayer = document.createElement("input");
        audioPlayer.type = "range";
        audioPlayer.className = "audio-player";
        audioPlayer.min = "0";
        audioPlayer.max = "100";
        audioPlayer.value = "0";
        audioContainer.appendChild(audioPlayer);
        
        const audioTime = document.createElement("div");
        audioTime.className = "audio-time";
        audioTime.textContent = "0:00";
        audioContainer.appendChild(audioTime);
        
        const realAudio = document.createElement("audio");
        realAudio.src = message.audioUrl;
        realAudio.setAttribute("controlsList", "nodownload");
        realAudio.style.display = "none";
        
        realAudio.addEventListener("loadedmetadata", () => {
          const duration = Math.floor(realAudio.duration);
          audioTime.textContent = `${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`;
        });
        
        audioPlayer.addEventListener("input", () => {
          const percent = audioPlayer.value / 100;
          realAudio.currentTime = percent * realAudio.duration;
        });
        
        realAudio.addEventListener("timeupdate", () => {
          const percent = (realAudio.currentTime / realAudio.duration) * 100;
          audioPlayer.value = percent;
        });
        
        audioIcon.addEventListener("click", () => {
          if (realAudio.paused) {
            realAudio.play();
            audioIcon.className = "fas fa-pause audio-icon";
          } else {
            realAudio.pause();
            audioIcon.className = "fas fa-music audio-icon";
          }
        });
        
        contentDiv.appendChild(audioContainer);
        contentDiv.appendChild(realAudio);
      }
      
      if (message.videoUrl) {
        const videoContainer = document.createElement("div");
        videoContainer.className = "video-player-container";
        
        const videoPlayer = document.createElement("video");
        videoPlayer.className = "video-player";
        videoPlayer.src = message.videoUrl;
        videoPlayer.setAttribute("controlsList", "nodownload");
        videoContainer.appendChild(videoPlayer);
        
        const videoControls = document.createElement("div");
        videoControls.className = "video-controls";
        
        const playBtn = document.createElement("button");
        playBtn.className = "video-control-btn";
        playBtn.innerHTML = '<i class="fas fa-play"></i>';
        playBtn.addEventListener("click", () => {
          if (videoPlayer.paused) {
            videoPlayer.play();
            playBtn.innerHTML = '<i class="fas fa-pause"></i>';
          } else {
            videoPlayer.pause();
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
          }
        });
        videoControls.appendChild(playBtn);
        
        const progressBar = document.createElement("div");
        progressBar.className = "video-progress";
        
        const progressFilled = document.createElement("div");
        progressFilled.className = "video-progress-filled";
        progressBar.appendChild(progressFilled);
        
        videoPlayer.addEventListener("timeupdate", () => {
          const percent = (videoPlayer.currentTime / videoPlayer.duration) * 100;
          progressFilled.style.width = `${percent}%`;
        });
        
        progressBar.addEventListener("click", (e) => {
          const percent = e.offsetX / progressBar.offsetWidth;
          videoPlayer.currentTime = percent * videoPlayer.duration;
        });
        
        videoControls.appendChild(progressBar);
        
        const timeDisplay = document.createElement("div");
        timeDisplay.className = "video-time";
        timeDisplay.textContent = "0:00 / 0:00";
        
        videoPlayer.addEventListener("loadedmetadata", () => {
          const duration = Math.floor(videoPlayer.duration);
          timeDisplay.textContent = `0:00 / ${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`;
        });
        
        videoPlayer.addEventListener("timeupdate", () => {
          const current = Math.floor(videoPlayer.currentTime);
          const duration = Math.floor(videoPlayer.duration);
          timeDisplay.textContent = `${Math.floor(current / 60)}:${(current % 60).toString().padStart(2, '0')} / ${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`;
        });
        
        videoControls.appendChild(timeDisplay);
        
        videoContainer.appendChild(videoControls);
        contentDiv.appendChild(videoContainer);
      }
      
      const timeDiv = document.createElement("div");
      timeDiv.className = "message-time";
      
      const timestamp = message.timestamp?.toDate ? message.timestamp.toDate() : new Date();
      timeDiv.textContent = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      if (isSent) {
        const readStatus = document.createElement("div");
        readStatus.className = "read-status";
        
        if (message.read) {
          const check1 = document.createElement("i");
          check1.className = "fas fa-check read-check";
          const check2 = document.createElement("i");
          check2.className = "fas fa-check read-check";
          
          readStatus.appendChild(check1);
          readStatus.appendChild(check2);
        } else {
          const check = document.createElement("i");
          check.className = "fas fa-check read-check";
          readStatus.appendChild(check);
        }
        
        timeDiv.appendChild(readStatus);
      }
      
      contentDiv.appendChild(timeDiv);
      
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "message-actions";
      
      if (message.text) {
        const copyButton = document.createElement("button");
        copyButton.className = "message-action";
        copyButton.title = "Copiar mensaje";
        copyButton.innerHTML = '<i class="far fa-copy"></i>';
        copyButton.addEventListener("click", () => {
          navigator.clipboard.writeText(message.text).then(() => {
            Swal.fire({
              title: 'Copiado',
              text: 'El mensaje ha sido copiado al portapapeles',
              icon: 'success',
              timer: 1500,
              showConfirmButton: false,
              background: '#1a1a2e',
              color: '#fff'
            });
          });
        });
        actionsDiv.appendChild(copyButton);
      }
      
      if (message.imageUrl) {
        const downloadButton = document.createElement("button");
        downloadButton.className = "message-action";
        downloadButton.title = "Descargar imagen";
        downloadButton.innerHTML = '<i class="fas fa-download"></i>';
        downloadButton.addEventListener("click", () => downloadFile(message.imageUrl, `imagen-${Date.now()}.jpg`));
        actionsDiv.appendChild(downloadButton);
      }
      
      if (message.audioUrl) {
        const downloadButton = document.createElement("button");
        downloadButton.className = "message-action";
        downloadButton.title = "Descargar audio";
        downloadButton.innerHTML = '<i class="fas fa-download"></i>';
        downloadButton.addEventListener("click", () => downloadFile(message.audioUrl, `audio-${Date.now()}.mp3`));
        actionsDiv.appendChild(downloadButton);
      }
      
      if (message.videoUrl) {
        const downloadButton = document.createElement("button");
        downloadButton.className = "message-action";
        downloadButton.title = "Descargar video";
        downloadButton.innerHTML = '<i class="fas fa-download"></i>';
        downloadButton.addEventListener("click", () => downloadFile(message.videoUrl, `video-${Date.now()}.mp4`));
        actionsDiv.appendChild(downloadButton);
      }
      
      if (isSent) {
        const deleteButton = document.createElement("button");
        deleteButton.className = "message-action";
        deleteButton.title = "Eliminar mensaje";
        deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
        deleteButton.addEventListener("click", () => deleteMessage(messageId, message.imageUrl || message.audioUrl || message.videoUrl));
        actionsDiv.appendChild(deleteButton);
      }
      
      messageDiv.appendChild(contentDiv);
      messageDiv.appendChild(actionsDiv);
      chatMessages.appendChild(messageDiv);
      
      if (message.sender !== activeUser && !message.read) {
        messageDiv.style.animation = "pulse 2s";
        playNotificationSound();
      }
    };

    // Funci√≥n para eliminar mensaje
    const deleteMessage = async (messageId, fileUrl) => {
      try {
        const result = await Swal.fire({
          title: '¬øEliminar mensaje?',
          text: 'Esta acci√≥n no se puede deshacer',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'S√≠, eliminar',
          cancelButtonText: 'Cancelar',
          background: '#1a1a2e',
          color: '#fff'
        });
        
        if (result.isConfirmed) {
          if (fileUrl) {
            const fileRef = ref(storage, fileUrl);
            await deleteObject(fileRef).catch(e => console.log("No se pudo eliminar el archivo:", e));
          }
          
          await deleteDoc(doc(db, `chats/${activeChatId}/messages/${messageId}`));
          
          Swal.fire({
            title: 'Eliminado',
            text: 'El mensaje ha sido eliminado',
            icon: 'success',
            timer: 1500,
            showConfirmButton: false,
            background: '#1a1a2e',
            color: '#fff'
          });
        }
      } catch (error) {
        console.error('Error al eliminar mensaje:', error);
        Swal.fire({
          title: 'Error',
          text: 'No se pudo eliminar el mensaje',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Funci√≥n para descargar archivos
    const downloadFile = (url, fileName) => {
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    // Funci√≥n para generar un ID √∫nico de chat
    const getChatId = (user1Id, user2Id) => {
      return user1Id < user2Id ? user1Id + user2Id : user2Id + user1Id;
    };

    // Enviar mensaje de texto
    const sendMessage = async (messageText) => {
      if (!messageText.trim() || !activeChatId) return;
      
      const messageData = {
        sender: activeUser,
        text: messageText,
        timestamp: serverTimestamp(),
        read: false
      };
      
      await addDoc(collection(db, `chats/${activeChatId}/messages`), messageData);
      
      userActivity[activeUserId] = {
        lastActivity: Date.now(),
        lastMessage: messageText
      };
      
      updateTypingStatus(false);
      
      document.getElementById("messageInput").value = "";
      
      loadUsers();
    };

    // Enviar imagen
    const sendImage = async (imageFile) => {
      if (!imageFile || !activeChatId) return;
      
      try {
        showLoader();
        const storageRef = ref(storage, `chat_images/${activeChatId}/${Date.now()}_${imageFile.name}`);
        await uploadBytes(storageRef, imageFile);
        const downloadURL = await getDownloadURL(storageRef);
        
        await addDoc(collection(db, `chats/${activeChatId}/messages`), {
          sender: activeUser,
          imageUrl: downloadURL,
          timestamp: serverTimestamp(),
          read: false
        });
        
        userActivity[activeUserId] = {
          lastActivity: Date.now(),
          lastMessage: "Imagen enviada"
        };
        
        document.getElementById("imagePreviewModal").classList.remove("active");
        selectedFile = null;
        
        loadUsers();
        hideLoader();
        
      } catch (error) {
        console.error("Error al enviar imagen:", error);
        hideLoader();
        Swal.fire({
          title: 'Error',
          text: 'No se pudo enviar la imagen',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Enviar audio
    const sendAudio = async (audioFile) => {
      if (!audioFile || !activeChatId) return;
      
      try {
        showLoader();
        const storageRef = ref(storage, `chat_audios/${activeChatId}/${Date.now()}_${audioFile.name}`);
        await uploadBytes(storageRef, audioFile);
        const downloadURL = await getDownloadURL(storageRef);
        
        await addDoc(collection(db, `chats/${activeChatId}/messages`), {
          sender: activeUser,
          audioUrl: downloadURL,
          timestamp: serverTimestamp(),
          read: false
        });
        
        userActivity[activeUserId] = {
          lastActivity: Date.now(),
          lastMessage: "Audio enviado"
        };
        
        loadUsers();
        hideLoader();
        
      } catch (error) {
        console.error("Error al enviar audio:", error);
        hideLoader();
        Swal.fire({
          title: 'Error',
          text: 'No se pudo enviar el audio',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Enviar video
    const sendVideo = async (videoFile) => {
      if (!videoFile || !activeChatId) return;
      
      try {
        showLoader();
        const storageRef = ref(storage, `chat_videos/${activeChatId}/${Date.now()}_${videoFile.name}`);
        await uploadBytes(storageRef, videoFile);
        const downloadURL = await getDownloadURL(storageRef);
        
        await addDoc(collection(db, `chats/${activeChatId}/messages`), {
          sender: activeUser,
          videoUrl: downloadURL,
          timestamp: serverTimestamp(),
          read: false
        });
        
        userActivity[activeUserId] = {
          lastActivity: Date.now(),
          lastMessage: "Video enviado"
        };
        
        loadUsers();
        hideLoader();
        
      } catch (error) {
        console.error("Error al enviar video:", error);
        hideLoader();
        Swal.fire({
          title: 'Error',
          text: 'No se pudo enviar el video',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Actualizar estado de "escribiendo"
    const updateTypingStatus = (isTyping) => {
      if (!activeChatId) return;
      
      const typingRef = doc(db, `typing/${activeChatId}`);
      updateDoc(typingRef, {
        [activeUser]: {
          typing: isTyping,
          timestamp: serverTimestamp()
        }
      });
    };

    // Configurar notificaciones de nuevos mensajes
    const setupMessageNotifications = () => {
      const chatsQuery = query(collection(db, "chats"));
      
      onSnapshot(chatsQuery, (snapshot) => {
        snapshot.forEach((doc) => {
          const chatId = doc.id;
          
          if (chatId.includes(activeUser)) {
            const otherUserId = chatId.replace(activeUser, '');
            const messagesRef = collection(db, `chats/${chatId}/messages`);
            const q = query(messagesRef, orderBy("timestamp", "desc"), limit(1));
            
            onSnapshot(q, (messageSnapshot) => {
              messageSnapshot.forEach((messageDoc) => {
                const message = messageDoc.data();
                
                if (message.sender !== activeUser && 
                    (!message.read || message.read === undefined)) {
                  showMessageNotification(otherUserId, message);
                  
                  userActivity[otherUserId] = {
                    lastActivity: message.timestamp?.toMillis() || Date.now(),
                    lastMessage: message.text || "Archivo enviado"
                  };
                  
                  loadUsers();
                }
              });
            });
          }
        });
      });
    };

    // Mostrar notificaci√≥n de nuevo mensaje
    const showMessageNotification = (userId, message) => {
      const user = users[userId];
      if (!user) return;
      
      const notification = document.getElementById("messageNotification");
      const notificationAvatar = document.getElementById("notificationAvatar");
      const notificationTitle = document.getElementById("notificationTitle");
      const notificationText = document.getElementById("notificationText");
      
      notificationAvatar.src = user.photoURL || "https://via.placeholder.com/40";
      notificationTitle.textContent = user.name;
      notificationText.textContent = message.text || "Nuevo archivo";
      
      notification.classList.add("show");
      playNotificationSound();
      
      setTimeout(() => {
        notification.classList.remove("show");
      }, 5000);
    };

    // Reproducir sonido de notificaci√≥n
    const playNotificationSound = () => {
      const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
      audio.play().catch(e => console.log("No se pudo reproducir sonido:", e));
    };

    // Desplazar el chat hacia abajo
    const scrollToBottom = () => {
      const chatMessages = document.getElementById("chatMessages");
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // Cargar emojis en el modal
    const loadEmojis = () => {
      const emojiContainer = document.getElementById("emojiContainer");
      emojiContainer.innerHTML = "";
      
      // Categor√≠as de emojis
      const emojis = {
        smileys: ["üòÄ", "üòÉ", "üòÑ", "üòÅ", "üòÜ", "üòÖ", "üòÇ", "ü§£", "üòä", "üòá", "üôÇ", "üôÉ", "üòâ", "üòå", "üòç", "ü•∞", "üòò", "üòó", "üòô", "üòö", "üòã", "üòõ", "üòù", "üòú", "ü§™", "ü§®", "üßê", "ü§ì", "üòé", "ü§©", "ü•≥", "üòè", "üòí", "üòû", "üòî", "üòü", "üòï", "üôÅ", "‚òπÔ∏è", "üò£", "üòñ", "üò´", "üò©", "ü•∫", "üò¢", "üò≠", "üò§", "üò†", "üò°", "ü§¨", "ü§Ø", "üò≥", "ü•µ", "ü•∂", "üò±", "üò®", "üò∞", "üò•", "üòì", "ü§ó", "ü§î", "ü§≠", "ü§´", "ü§•", "üò∂", "üòê", "üòë", "üò¨", "üôÑ", "üòØ", "üò¶", "üòß", "üòÆ", "üò≤", "ü•±", "üò¥", "ü§§", "üò™", "üòµ", "ü§ê", "ü•¥", "ü§¢", "ü§Æ", "ü§ß", "üò∑", "ü§í", "ü§ï", "ü§ë", "ü§†", "üòà", "üëø", "üëπ", "üë∫", "ü§°", "üí©", "üëª", "üíÄ", "‚ò†Ô∏è", "üëΩ", "üëæ", "ü§ñ", "üéÉ", "üò∫", "üò∏", "üòπ", "üòª", "üòº", "üòΩ", "üôÄ", "üòø", "üòæ"],
        animals: ["üê∂", "üê±", "üê≠", "üêπ", "üê∞", "ü¶ä", "üêª", "üêº", "üê®", "üêØ", "ü¶Å", "üêÆ", "üê∑", "üêΩ", "üê∏", "üêµ", "üôà", "üôâ", "üôä", "üêí", "üêî", "üêß", "üê¶", "üê§", "üê£", "üê•", "ü¶Ü", "ü¶Ö", "ü¶â", "ü¶á", "üê∫", "üêó", "üê¥", "ü¶Ñ", "üêù", "üêõ", "ü¶ã", "üêå", "üêû", "üêú", "ü¶ü", "ü¶ó", "üï∑Ô∏è", "üï∏Ô∏è", "ü¶Ç", "üê¢", "üêç", "ü¶é", "ü¶ñ", "ü¶ï", "üêô", "ü¶ë", "ü¶ê", "ü¶û", "ü¶Ä", "üê°", "üê†", "üêü", "üê¨", "üê≥", "üêã", "ü¶à", "üêä", "üêÖ", "üêÜ", "ü¶ì", "ü¶ç", "ü¶ß", "ü¶£", "üêò", "ü¶õ", "ü¶è", "üê™", "üê´", "ü¶í", "ü¶ò", "ü¶¨", "üêÉ", "üêÇ", "üêÑ", "üêé", "üêñ", "üêè", "üêë", "ü¶ô", "üêê", "ü¶å", "üêï", "üê©", "ü¶Æ", "üêï‚Äçü¶∫", "üêà", "üêà‚Äç‚¨õ", "ü™∂", "üêì", "ü¶É", "ü¶§", "ü¶ö", "ü¶ú", "ü¶¢", "ü¶©", "üïäÔ∏è", "üêá", "ü¶ù", "ü¶®", "ü¶°", "ü¶´", "ü¶¶", "ü¶•", "üêÅ", "üêÄ", "üêøÔ∏è", "ü¶î"],
        food: ["üçè", "üçé", "üçê", "üçä", "üçã", "üçå", "üçâ", "üçá", "üçì", "ü´ê", "üçà", "üçí", "üçë", "ü•≠", "üçç", "ü••", "ü•ù", "üçÖ", "üçÜ", "ü•ë", "ü•¶", "ü•¨", "ü•í", "üå∂Ô∏è", "ü´ë", "üåΩ", "ü•ï", "ü´í", "üßÑ", "üßÖ", "ü•î", "üç†", "ü´ö", "ü´õ", "ü•ê", "ü•ñ", "ü´ì", "ü•®", "ü•Ø", "ü•û", "üßá", "üßÄ", "üçñ", "üçó", "ü•©", "ü•ì", "üçî", "üçü", "üçï", "üå≠", "ü•™", "üåÆ", "üåØ", "ü´î", "ü•ô", "üßÜ", "ü•ö", "üç≥", "ü•ò", "üç≤", "ü´ï", "ü•£", "ü•ó", "üçø", "üßà", "üßÇ", "ü•´", "üç±", "üçò", "üçô", "üçö", "üçõ", "üçú", "üçù", "üç†", "üç¢", "üç£", "üç§", "üç•", "ü•Æ", "üç°", "ü•ü", "ü•†", "ü•°", "ü¶Ä", "ü¶û", "ü¶ê", "ü¶ë", "ü¶™", "üç¶", "üçß", "üç®", "üç©", "üç™", "üéÇ", "üç∞", "üßÅ", "ü•ß", "üç´", "üç¨", "üç≠", "üçÆ", "üçØ", "üçº", "ü•õ", "‚òï", "ü´ñ", "üçµ", "üç∂", "üçæ", "üç∑", "üç∏", "üçπ", "üç∫", "üçª", "ü•Ç", "ü•É", "ü´ó", "ü•§", "üßã", "üßÉ", "üßâ", "üßä", "ü•¢", "üçΩÔ∏è", "üç¥", "ü•Ñ", "üî™", "ü´ô", "üè∫"],
        activities: ["‚öΩ", "üèÄ", "üèà", "‚öæ", "ü•é", "üéæ", "üèê", "üèâ", "ü•è", "üé±", "ü™Ä", "üèì", "üè∏", "üèí", "üèë", "ü•ç", "üèè", "ü™É", "ü•Ö", "‚õ≥", "ü™Å", "üèπ", "üé£", "ü§ø", "ü•ä", "ü•ã", "üéΩ", "üõπ", "üõº", "üõ∑", "‚õ∏Ô∏è", "ü•å", "üéØ", "ü™Ç", "üéø", "üèÇ", "ü™Å", "üèãÔ∏è", "ü§º", "ü§∏", "‚õπÔ∏è", "ü§∫", "ü§æ", "üèåÔ∏è", "üèá", "üßò", "üèÑ", "üèä", "ü§Ω", "üö£", "üßó", "üöµ", "üö¥", "üèÜ", "ü•á", "ü•à", "ü•â", "üèÖ", "üéñÔ∏è", "üèµÔ∏è", "üéóÔ∏è", "üé´", "üéüÔ∏è", "üé™", "ü§π", "üé≠", "ü©∞", "üé®", "üé¨", "üé§", "üéß", "üéº", "üéπ", "ü•Å", "ü™ò", "üé∑", "üé∫", "ü™ó", "üé∏", "ü™ï", "üéª", "üé≤", "‚ôüÔ∏è", "üÉè", "üÄÑ", "üé¥", "üéÆ", "üïπÔ∏è", "üé∞", "üé≥"],
        travel: ["üöó", "üöï", "üöô", "üöå", "üöé", "üèéÔ∏è", "üöì", "üöë", "üöí", "üöê", "üõª", "üöö", "üöõ", "üöú", "ü¶Ø", "ü¶Ω", "ü¶º", "üõ¥", "üö≤", "üõµ", "üèçÔ∏è", "üõ∫", "üö®", "üöî", "üöç", "üöò", "üöñ", "üö°", "üö†", "üöü", "üöÉ", "üöã", "üöû", "üöù", "üöÑ", "üöÖ", "üöà", "üöÇ", "üöÜ", "üöá", "üöä", "üöâ", "‚úàÔ∏è", "üõ´", "üõ¨", "üõ©Ô∏è", "üí∫", "üõ∞Ô∏è", "üöÄ", "üõ∏", "üöÅ", "üõ∂", "‚õµ", "üö§", "üõ•Ô∏è", "üõ≥Ô∏è", "‚õ¥Ô∏è", "üö¢", "‚öì", "ü™ù", "‚õΩ", "üöß", "üö¶", "üö•", "üöè", "üó∫Ô∏è", "üóø", "üóΩ", "üóº", "üè∞", "üèØ", "üèüÔ∏è", "üé°", "üé¢", "üé†", "‚õ≤", "‚õ±Ô∏è", "üèñÔ∏è", "üèùÔ∏è", "üèúÔ∏è", "üåã", "‚õ∞Ô∏è", "üèîÔ∏è", "üóª", "üèïÔ∏è", "‚õ∫", "üõñ", "üè†", "üè°", "üèòÔ∏è", "üèöÔ∏è", "üèóÔ∏è", "üè≠", "üè¢", "üè¨", "üè£", "üè§", "üè•", "üè¶", "üè®", "üè™", "üè´", "üè©", "üíí", "üèõÔ∏è", "‚õ™", "üïå", "üõï", "üïç", "‚õ©Ô∏è", "üïã", "‚õ≤", "‚õ∫", "üåÅ", "üåÉ", "üèôÔ∏è", "üåÑ", "üåÖ", "üåÜ", "üåá", "üåâ", "üé†", "üé°", "üé¢"],
        objects: ["‚åö", "üì±", "üì≤", "üíª", "‚å®Ô∏è", "üñ•Ô∏è", "üñ®Ô∏è", "üñ±Ô∏è", "üñ≤Ô∏è", "üïπÔ∏è", "üóúÔ∏è", "üíΩ", "üíæ", "üíø", "üìÄ", "üìº", "üì∑", "üì∏", "üìπ", "üé•", "üìΩÔ∏è", "üéûÔ∏è", "üìû", "‚òéÔ∏è", "üìü", "üì†", "üì∫", "üìª", "üéôÔ∏è", "üéöÔ∏è", "üéõÔ∏è", "üß≠", "‚è±Ô∏è", "‚è≤Ô∏è", "‚è∞", "üï∞Ô∏è", "‚åõ", "‚è≥", "üì°", "üîã", "üîå", "üí°", "üî¶", "üïØÔ∏è", "ü™î", "üßØ", "üõ¢Ô∏è", "üí∏", "üíµ", "üí¥", "üí∂", "üí∑", "üí∞", "üí≥", "üíé", "‚öñÔ∏è", "üß∞", "üîß", "üî®", "‚öíÔ∏è", "üõ†Ô∏è", "‚õèÔ∏è", "üî©", "‚öôÔ∏è", "üß±", "‚õìÔ∏è", "üß≤", "üî´", "üí£", "üß®", "ü™ì", "üî™", "üó°Ô∏è", "‚öîÔ∏è", "üõ°Ô∏è", "üö¨", "‚ö∞Ô∏è", "ü™¶", "‚ö±Ô∏è", "üè∫", "üîÆ", "üìø", "üßø", "üíà", "‚öóÔ∏è", "üî≠", "üî¨", "üï≥Ô∏è", "ü©π", "ü©∫", "üíä", "üíâ", "ü©∏", "üß¨", "ü¶†", "üß´", "üß™", "üå°Ô∏è", "üßπ", "üß∫", "üßª", "üöΩ", "ü™†", "üöø", "üõÅ", "ü™§", "ü™í", "üß¥", "üß∑", "üßπ", "üß∫", "üßª", "üßº", "üßΩ", "üßØ", "üõí", "üö¨", "‚ö±Ô∏è"],
        symbols: ["‚ù§Ô∏è", "üß°", "üíõ", "üíö", "üíô", "üíú", "üñ§", "ü§ç", "ü§é", "üíî", "‚ù£Ô∏è", "üíï", "üíû", "üíì", "üíó", "üíñ", "üíò", "üíù", "üíü", "‚òÆÔ∏è", "‚úùÔ∏è", "‚ò™Ô∏è", "üïâÔ∏è", "‚ò∏Ô∏è", "‚ú°Ô∏è", "üîØ", "üïé", "‚òØÔ∏è", "‚ò¶Ô∏è", "üõê", "‚õé", "‚ôà", "‚ôâ", "‚ôä", "‚ôã", "‚ôå", "‚ôç", "‚ôé", "‚ôè", "‚ôê", "‚ôë", "‚ôí", "‚ôì", "üÜî", "‚öõÔ∏è", "üâë", "‚ò¢Ô∏è", "‚ò£Ô∏è", "üì¥", "üì≥", "üà∂", "üàö", "üà∏", "üà∫", "üà∑Ô∏è", "‚ú¥Ô∏è", "üÜö", "üíÆ", "üâê", "„äôÔ∏è", "„äóÔ∏è", "üà¥", "üàµ", "üàπ", "üà≤", "üÖ∞Ô∏è", "üÖ±Ô∏è", "üÜé", "üÜë", "üÖæÔ∏è", "üÜò", "‚ùå", "‚≠ï", "üõë", "‚õî", "üìõ", "üö´", "üíØ", "üí¢", "‚ô®Ô∏è", "üö∑", "üöØ", "üö≥", "üö±", "üîû", "üìµ", "üö≠", "‚ùó", "‚ùï", "‚ùì", "‚ùî", "‚ÄºÔ∏è", "‚ÅâÔ∏è", "üîÖ", "üîÜ", "„ÄΩÔ∏è", "‚ö†Ô∏è", "üö∏", "üî±", "‚öúÔ∏è", "üî∞", "‚ôªÔ∏è", "‚úÖ", "üàØ", "üíπ", "‚ùáÔ∏è", "‚ú≥Ô∏è", "‚ùé", "üåê", "üí†", "‚ìÇÔ∏è", "üåÄ", "üí§", "üèß", "üöæ", "‚ôø", "üÖøÔ∏è", "üà≥", "üàÇÔ∏è", "üõÇ", "üõÉ", "üõÑ", "üõÖ", "üöπ", "üö∫", "üöº", "üöª", "üöÆ", "üé¶", "üì∂", "üàÅ", "üî£", "‚ÑπÔ∏è", "üî§", "üî°", "üî†", "üÜñ", "üÜó", "üÜô", "üÜí", "üÜï", "üÜì", "0Ô∏è‚É£", "1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£", "8Ô∏è‚É£", "9Ô∏è‚É£", "üîü", "üî¢", "#Ô∏è‚É£", "*Ô∏è‚É£", "‚èèÔ∏è", "‚ñ∂Ô∏è", "‚è∏Ô∏è", "‚èØÔ∏è", "‚èπÔ∏è", "‚è∫Ô∏è", "‚è≠Ô∏è", "‚èÆÔ∏è", "‚è©", "‚è™", "‚è´", "‚è¨", "‚óÄÔ∏è", "üîº", "üîΩ", "‚û°Ô∏è", "‚¨ÖÔ∏è", "‚¨ÜÔ∏è", "‚¨áÔ∏è", "‚ÜóÔ∏è", "‚ÜòÔ∏è", "‚ÜôÔ∏è", "‚ÜñÔ∏è", "‚ÜïÔ∏è", "‚ÜîÔ∏è", "‚Ü™Ô∏è", "‚Ü©Ô∏è", "‚§¥Ô∏è", "‚§µÔ∏è", "üîÄ", "üîÅ", "üîÇ", "üîÑ", "üîÉ", "üéµ", "üé∂", "‚ûï", "‚ûñ", "‚ûó", "‚úñÔ∏è", "‚ôæÔ∏è", "üí≤", "üí±", "‚Ñ¢Ô∏è", "¬©Ô∏è", "¬ÆÔ∏è", "„Ä∞Ô∏è", "‚û∞", "‚ûø", "üîö", "üîô", "üîõ", "üîù", "üîú"],
        flags: ["üè≥Ô∏è", "üè¥", "üèÅ", "üö©", "üè≥Ô∏è‚Äçüåà", "üè¥‚Äç‚ò†Ô∏è", "üá¶üá´", "üá¶üáΩ", "üá¶üá±", "üá©üáø", "üá¶üá∏", "üá¶üá©", "üá¶üá¥", "üá¶üáÆ", "üá¶üá∂", "üá¶üá¨", "üá¶üá∑", "üá¶üá≤", "ÔøΩÔøΩÔøΩüáº", "üá¶üá∫", "üá¶üáπ", "üá¶üáø", "üáßüá∏", "üáßüá≠", "üáßüá©", "üáßüáß", "üáßüáæ", "üáßüá™", "üáßüáø", "üáßüáØ", "üáßüá≤", "üáßüáπ", "üáßüá¥", "üáßüá¶", "üáßüáº", "üáßüá∑", "üáÆüá¥", "üáªüá¨", "üáßüá≥", "üáßüá¨", "üáßüá´", "üáßüáÆ", "üá®üáª", "üá∞üá≠", "üá®üá≤", "üá®üá¶", "üáÆüá®", "üá∞üáæ", "üá®üá´", "üáπüá©", "üá®üá±", "üá®üá≥", "üá®üáΩ", "üá®üá®", "üá®üá¥", "üá∞üá≤", "üá®üá¨", "üá®üá©", "üá®üá∞", "üá®üá∑", "üá®üáÆ", "üá≠üá∑", "üá®üá∫", "üá®üáº", "üá®üáæ", "üá®üáø", "üá©üá∞", "üá©üáØ", "üá©üá≤", "üá©üá¥", "üá™üá®", "üá™üá¨", "üá∏üáª", "üá¨üá∂", "üá™üá∑", "üá™üá™", "üá∏üáø", "üá™üáπ", "üá™üá∫", "üá´üá∞", "üá´üá¥", "üá´üáØ", "üá´üáÆ", "üá´üá∑", "üá¨üá´", "üáµüá´", "üáπüá´", "üá¨üá¶", "üá¨üá≤", "üá¨üá™", "üá©üá™", "üá¨üá≠", "üá¨üáÆ", "üá¨üá∑", "üá¨üá±", "üá¨üá©", "üá¨üáµ", "üá¨üá∫", "üá¨üáπ", "üá¨üá¨", "üá¨üá≥", "üá¨üáº", "üá¨üáæ", "üá≠üáπ", "üá≠üá≥", "üá≠üá∞", "üá≠üá∫", "üáÆüá∏", "üáÆüá≥", "üáÆüá©", "üáÆüá∑", "üáÆüá∂", "üáÆüá™", "üáÆüá≤", "üáÆüá±", "üáÆüáπ", "üáØüá≤", "üáØüáµ", "üéå", "üáØüá™", "üáØüá¥", "üá∞ÔøΩÔøΩÔøΩÔøΩ", "üá∞üá™", "üá∞üáÆ", "üáΩüá∞", "üá∞üáº", "üá∞üá¨", "üá±üá¶", "üá±üáª", "üá±üáß", "üá±üá∏", "üá±üá∑", "üá±üáæ", "üá±üáÆ", "üá±üáπ", "üá±üá∫", "üá≤üá¥", "üá≤üá¨", "üá≤üáº", "üá≤üáæ", "üá≤üáª", "üá≤üá±", "üá≤üáπ", "üá≤üá≠", "üá≤üá∂", "üá≤üá∑", "üá≤üá∫", "üáæüáπ", "üá≤üáΩ", "üá´üá≤", "üá≤üá©", "üá≤üá®", "üá≤üá≥", "üá≤üá™", "üá≤üá∏", "üá≤üá¶", "üá≤üáø", "üá≤üá≤", "üá≥üá¶", "üá≥üá∑", "üá≥üáµ", "üá≥üá±", "üá≥üá®", "üá≥üáø", "üá≥üáÆ", "üá≥üá™", "üá≥üá¨", "üá≥üá∫", "üá≥üá´", "üá∞üáµ", "üá≤üá∞", "üá≤üáµ", "üá≥üá¥", "üá¥üá≤", "üáµüá∞", "üáµüáº", "üáµüá∏", "üáµüá¶", "üáµüá¨", "üáµüáæ", "üáµüá™", "üáµüá≠", "üáµüá≥", "üáµüá±", "üáµüáπ", "üáµüá∑", "üá∂üá¶", "üá∑üá™", "üá∑üá¥", "üá∑üá∫", "üá∑üáº", "üáºüá∏", "üá∏üá≤", "üá∏üá¶", "üá∏üá≥", "üá∑üá∏", "üá∏üá®", "üá∏üá±", "üá∏üá¨", "üá∏üáΩ", "üá∏üá∞", "üá∏üáÆ", "üá¨üá∏", "üá∏üáß", "üá∏üá¥", "üáøüá¶", "üá∞üá∑", "üá∏üá∏", "üá™üá∏", "üá±üá∞", "üáßüá±", "üá∏üá≠", "üá∞üá≥", "üá±üá®", "üáµüá≤", "üáªüá®", "üá∏üá©", "üá∏üá∑", "üá∏üá™", "üá®üá≠", "üá∏üáæ", "üáπüáº", "üáπüáØ", "üáπüáø", "üáπüá≠", "üáπüá±", "üáπüá¨", "üáπüá∞", "üáπüá¥", "üáπüáπ", "üáπüá≥", "üáπüá∑", "üáπüá≤", "üáπüá®", "üáπüáª", "üáªüáÆ", "üá∫üá¨", "üá∫üá¶", "üá¶üá™", "üá¨üáß", "üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø", "üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø", "üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø", "üá∫üá∏", "üá∫üáæ", "üá∫üáø", "üáªüá∫", "üáªüá¶", "üáªüá™", "üáªüá≥", "üáºüá´", "üá™üá≠", "üáæüá™", "üáøüá≤", "üáøüáº"]
      };
      
      // Mostrar emojis por categor√≠a
      const showEmojisByCategory = (category) => {
        emojiContainer.innerHTML = "";
        
        emojis[category].forEach(emoji => {
          const emojiBtn = document.createElement("button");
          emojiBtn.className = "emoji-btn";
          emojiBtn.textContent = emoji;
          emojiBtn.addEventListener("click", () => {
            const messageInput = document.getElementById("messageInput");
            messageInput.value += emoji;
            messageInput.focus();
          });
          emojiContainer.appendChild(emojiBtn);
        });
      };
      
      // Mostrar primera categor√≠a por defecto
      showEmojisByCategory("smileys");
      
      // Manejar clic en categor√≠as
      document.querySelectorAll(".emoji-category-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".emoji-category-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          showEmojisByCategory(btn.dataset.category);
        });
      });
    };

    // Event listeners
    document.getElementById("sendMessageButton").addEventListener("click", () => {
      const message = document.getElementById("messageInput").value;
      sendMessage(message);
    });

    document.getElementById("messageInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        const message = document.getElementById("messageInput").value;
        sendMessage(message);
      }
    });

    document.getElementById("messageInput").addEventListener("input", (e) => {
      if (e.target.value.length > 0) {
        updateTypingStatus(true);
      } else {
        updateTypingStatus(false);
      }
    });

    // Manejar pegado de im√°genes
    document.getElementById("messageInput").addEventListener("paste", async (e) => {
      const items = (e.clipboardData || window.clipboardData).items;
      
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") !== -1) {
          e.preventDefault();
          
          const blob = items[i].getAsFile();
          const reader = new FileReader();
          
          reader.onload = (event) => {
            // Mostrar vista previa de la imagen pegada
            document.getElementById("imagePreview").src = event.target.result;
            document.getElementById("imagePreviewModal").classList.add("active");
            selectedFile = blob;
          };
          
          reader.readAsDataURL(blob);
          break;
        }
      }
    });

    document.getElementById("closeNotification").addEventListener("click", () => {
      document.getElementById("messageNotification").classList.remove("show");
    });

    document.getElementById("toggleUserList").addEventListener("click", () => {
      document.getElementById("userListContainer").classList.toggle("active");
    });

    document.getElementById("menuButton").addEventListener("click", () => {
      document.getElementById("userListContainer").classList.toggle("active");
    });

    // Adjuntar archivos
    document.getElementById("attachFileButton").addEventListener("click", () => {
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*,audio/*,video/*";
      
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.type.startsWith("image/")) {
          selectedFile = file;
          showImagePreview(file);
        } else if (file.type.startsWith("audio/")) {
          sendAudio(file);
        } else if (file.type.startsWith("video/")) {
          sendVideo(file);
        } else {
          Swal.fire({
            title: 'Formato no soportado',
            text: 'Por favor, selecciona una imagen, audio o video',
            icon: 'error',
            background: '#1a1a2e',
            color: '#fff'
          });
        }
      });
      
      fileInput.click();
    });

    // Mostrar vista previa de imagen
    const showImagePreview = (file) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById("imagePreview").src = e.target.result;
        document.getElementById("imagePreviewModal").classList.add("active");
      };
      reader.readAsDataURL(file);
    };

    // Enviar imagen desde vista previa
    document.getElementById("sendImageButton").addEventListener("click", () => {
      if (selectedFile) {
        sendImage(selectedFile);
      }
    });

    // Cancelar env√≠o de imagen
    document.getElementById("cancelImageButton").addEventListener("click", () => {
      document.getElementById("imagePreviewModal").classList.remove("active");
      selectedFile = null;
    });

    // Cerrar modal de informaci√≥n de usuario
    document.getElementById("closeUserInfoModal").addEventListener("click", () => {
      document.getElementById("userInfoModal").classList.remove("active");
    });

    // Funcionalidad de c√°mara
    document.getElementById("openCameraButton").addEventListener("click", () => {
      openCamera();
    });

    // Abrir c√°mara
    const openCamera = async () => {
      try {
        const constraints = {
          video: {
            facingMode: currentCameraFacing,
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        };
        
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById("camera-video");
        video.srcObject = cameraStream;
        
        document.getElementById("cameraModal").classList.add("active");
        document.getElementById("cameraPreviewActions").style.display = "none";
        
      } catch (error) {
        console.error("Error al acceder a la c√°mara:", error);
        Swal.fire({
          title: 'Error',
          text: 'No se pudo acceder a la c√°mara. Aseg√∫rate de haber concedido los permisos.',
          icon: 'error',
          background: '#1a1a2e',
          color: '#fff'
        });
      }
    };

    // Capturar foto
    document.getElementById("captureButton").addEventListener("click", () => {
      const video = document.getElementById("camera-video");
      const canvas = document.getElementById("camera-canvas");
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      document.getElementById("cameraPreviewActions").style.display = "flex";
      
      cameraStream.getTracks().forEach(track => track.stop());
    });

    // Volver a tomar foto
    document.getElementById("retakePhotoButton").addEventListener("click", () => {
      openCamera();
    });

    // Enviar foto capturada
    document.getElementById("sendPhotoButton").addEventListener("click", async () => {
      const canvas = document.getElementById("camera-canvas");
      
      canvas.toBlob(async (blob) => {
        try {
          const file = new File([blob], `foto-${Date.now()}.jpg`, { type: 'image/jpeg' });
          await sendImage(file);
          
          document.getElementById("cameraModal").classList.remove("active");
          capturedPhoto = null;
          
        } catch (error) {
          console.error("Error al enviar foto:", error);
          Swal.fire({
            title: 'Error',
            text: 'No se pudo enviar la foto',
            icon: 'error',
            background: '#1a1a2e',
            color: '#fff'
          });
        }
      }, 'image/jpeg', 0.9);
    });

    // Cambiar c√°mara
    document.getElementById("switchCameraButton").addEventListener("click", () => {
      currentCameraFacing = currentCameraFacing === 'user' ? 'environment' : 'user';
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      openCamera();
    });

    // Cerrar c√°mara
    document.getElementById("closeCameraButton").addEventListener("click", () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      document.getElementById("cameraModal").classList.remove("active");
    });

    // Funcionalidad de emojis
    document.getElementById("emojiButton").addEventListener("click", () => {
      document.getElementById("emojiModal").classList.add("active");
      loadEmojis();
    });

    document.getElementById("closeEmojiModal").addEventListener("click", () => {
      document.getElementById("emojiModal").classList.remove("active");
    });

    // Limpieza al cerrar la p√°gina
    window.addEventListener('beforeunload', () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      
      updateTypingStatus(false);
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación Diaria de Desempeño: Seguridad y CCTV</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3, h4 {
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        .info-field {
            margin-bottom: 15px;
        }
        .info-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .info-field input[type="text"],
        .info-field input[type="date"],
        .info-field select,
        .info-field textarea {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .date-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background-color: #eaf2f8;
            padding: 10px 15px;
            border-radius: 5px;
        }
        .date-navigation button {
            background-color: #3498db;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        .date-navigation button:hover {
            background-color: #2980b9;
        }
        .date-navigation #current-date-display {
            font-size: 1.2em;
            font-weight: bold;
        }
        .daily-form-section {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            background-color: #fdfdfd;
        }
        .question {
            margin-bottom: 20px;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 6px;
            background-color: #fcfcfc;
        }
        .question label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .rating input[type="radio"] {
            margin-right: 5px;
        }
        .rating label {
            display: inline-block;
            margin-right: 15px;
            font-weight: normal;
        }
        .comments textarea {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 60px;
            margin-top: 5px;
        }
        .button-group {
            text-align: center;
            margin-top: 30px;
        }
        .button-group button {
            background-color: #2ecc71;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 0 10px;
        }
        .button-group button.evaluate-btn {
            background-color: #e67e22; /* Orange for evaluation */
        }
        .button-group button:hover {
            background-color: #27ae60;
        }
        .button-group button.evaluate-btn:hover {
            background-color: #d35400;
        }
        #final-evaluation-result {
            margin-top: 40px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #eaf2f8;
            font-size: 1.1em;
        }
        #final-evaluation-result h3 {
            color: #2c3e50;
            border-bottom: none;
            margin-top: 0;
            text-align: center;
        }
        #final-result-text {
            font-weight: bold;
            text-align: center;
            font-size: 1.3em;
            margin-top: 15px;
        }
        .signature-fields {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
        }
        .signature-field {
            flex-basis: 48%;
            border-top: 1px solid #ccc;
            padding-top: 10px;
            text-align: center;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Evaluación Diaria de Desempeño: Seguridad y CCTV</h1>
        <h2>Período de Prueba de 3 Meses</h2>

        <div class="info-field">
            <label for="colaborador-nombre">Nombre del Colaborador:</label>
            <input type="text" id="colaborador-nombre" name="colaborador-nombre" required>
        </div>
        <div class="info-field">
            <label for="fecha-inicio-prueba">Fecha de Inicio de Prueba (Primera Evaluación):</label>
            <input type="date" id="fecha-inicio-prueba" name="fecha-inicio-prueba" required>
        </div>
        <div class="info-field">
            <label for="evaluador">Evaluador:</label>
            <input type="text" id="evaluador" name="evaluador" required>
        </div>
        <div class="info-field">
            <label for="puesto">Puesto a Evaluar:</label>
            <select id="puesto" name="puesto" required>
                <option value="">Seleccione un puesto</option>
                <option value="Agente de Seguridad">Agente de Seguridad</option>
                <option value="Operador de CCTV">Operador de CCTV</option>
            </select>
        </div>

        <hr>

        <h3>Evaluación Diaria</h3>
        <div class="date-navigation">
            <button id="prevDay">&lt; Día Anterior</button>
            <span id="current-date-display"></span>
            <button id="nextDay">Día Siguiente &gt;</button>
        </div>

        <div class="daily-form-section">
            <p><strong>Instrucciones:</strong> Evalúa al colaborador en cada uno de los siguientes puntos para el día actual, utilizando la siguiente escala:</p>
            <ul>
                <li><strong>1 - Necesita Mejorar:</strong> No cumple las expectativas mínimas.</li>
                <li><strong>2 - Regular:</strong> Cumple parcialmente las expectativas, requiere supervisión constante.</li>
                <li><strong>3 - Bueno:</strong> Cumple las expectativas de forma consistente.</li>
                <li><strong>4 - Muy Bueno:</strong> Supera las expectativas regularmente.</li>
                <li><strong>5 - Excelente:</strong> Supera consistentemente todas las expectativas, es un modelo a seguir.</li>
            </ul>

            <form id="dailyEvaluationForm">
                <div class="section" id="dynamic-questions-container">
                    </div>

                <div class="button-group">
                    <button type="submit">Guardar Evaluación Diaria</button>
                    <button type="button" class="evaluate-btn" id="triggerFinalEvaluation">Evaluar 3 Meses</button>
                </div>
            </form>
        </div>

        <div id="final-evaluation-result" class="hidden">
            <h3>V. Conclusión de la Evaluación de 3 Meses</h3>
            <p><strong>Promedio General de Evaluación Diaria:</strong> <span id="final-average-score"></span></p>
            <p id="final-result-text"></p>
            <p><strong>Comentarios Consolidado de la Evaluación:</strong> <span id="final-additional-comments"></span></p>
            <p><strong>Días Evaluados:</strong> <span id="days-evaluated-count"></span> de <span id="total-expected-days"></span></p>
        </div>

        <div class="signature-fields hidden" id="signature-section">
            <div class="signature-field">
                <p>___________________________________</p>
                <p>Firma del Evaluador</p>
                <p><span id="final-evaluator-name-display"></span></p>
            </div>
            <div class="signature-field">
                <p>___________________________________</p>
                <p>Firma del Colaborador</p>
                <p>(La firma del colaborador indica que ha revisado esta evaluación y ha tenido la oportunidad de discutirla, no necesariamente implica acuerdo con el contenido.)</p>
            </div>
        </div>
    </div>

    <script>
        // --- Data Storage (In-memory for this example - NOT PERSISTENT) ---
        const dailyEvaluations = {}; // Stores evaluations like: { 'YYYY-MM-DD': { puesto: 'Agente de Seguridad', q1: 4, q2: 5, comments: {...} }, ... }
        let currentDate = new Date(); // Current date being displayed/evaluated

        // --- Question Definitions for each Role ---
        const questions = {
            "Agente de Seguridad": [
                { id: "q1", text: "1. Cumplimiento de rondas de seguridad y patrullaje.", critical: true },
                { id: "q2", text: "2. Habilidad para detectar y reportar situaciones sospechosas o inseguras.", critical: true },
                { id: "q3", text: "3. Adherencia a los protocolos de control de acceso y salida.", critical: false },
                { id: "q4", text: "4. Capacidad de reacción y respuesta ante incidentes menores (primeros auxilios, conatos).", critical: false },
                { id: "q5", text: "5. Comunicación efectiva con personal interno y visitantes.", critical: false },
                { id: "q6", text: "6. Mantenimiento del equipo de seguridad asignado (radio, linterna, etc.).", critical: false }
            ],
            "Operador de CCTV": [
                { id: "q1", text: "1. Eficacia en el monitoreo activo de cámaras de seguridad (visión panorámica y detalle).", critical: true },
                { id: "q2", text: "2. Rapidez en la identificación y reporte de eventos o actividades inusuales.", critical: true },
                { id: "q3", text: "3. Habilidad para operar software y sistemas de CCTV (búsqueda, grabación, exportación).", critical: false },
                { id: "q4", text: "4. Registro preciso y detallado de incidentes observados (bitácoras, informes).", critical: false },
                { id: "q5", text: "5. Coordinación efectiva con personal en campo o autoridades relevantes.", critical: false },
                { id: "q6", text: "6. Mantenimiento y reporte de fallas de los equipos de CCTV.", critical: false }
            ]
        };

        // --- DOM Elements ---
        const colaboradorNombreInput = document.getElementById('colaborador-nombre');
        const fechaInicioPruebaInput = document.getElementById('fecha-inicio-prueba');
        const evaluadorInput = document.getElementById('evaluador');
        const puestoSelect = document.getElementById('puesto');
        const currentDateDisplay = document.getElementById('current-date-display');
        const prevDayBtn = document.getElementById('prevDay');
        const nextDayBtn = document.getElementById('nextDay');
        const dailyEvaluationForm = document.getElementById('dailyEvaluationForm');
        const dynamicQuestionsContainer = document.getElementById('dynamic-questions-container');
        const finalEvaluationResultDiv = document.getElementById('final-evaluation-result');
        const signatureSection = document.getElementById('signature-section');
        const triggerFinalEvaluationBtn = document.getElementById('triggerFinalEvaluation');

        // --- Helper Functions ---
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function updateDateDisplay() {
            currentDateDisplay.textContent = formatDate(currentDate);
        }

        function renderDailyQuestions(puesto) {
            dynamicQuestionsContainer.innerHTML = ''; // Clear previous questions
            const currentQuestions = questions[puesto];
            if (!currentQuestions) {
                dynamicQuestionsContainer.innerHTML = '<p>Por favor, seleccione un puesto para cargar las preguntas de evaluación.</p>';
                return;
            }

            currentQuestions.forEach(q => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('question');
                if (q.critical) {
                    questionDiv.setAttribute('data-critical', 'true');
                }

                questionDiv.innerHTML = `
                    <label>${q.text}</label>
                    <div class="rating">
                        <input type="radio" id="${q.id}-r1" name="${q.id}" value="1" required><label for="${q.id}-r1">1</label>
                        <input type="radio" id="${q.id}-r2" name="${q.id}" value="2"><label for="${q.id}-r2">2</label>
                        <input type="radio" id="${q.id}-r3" name="${q.id}" value="3"><label for="${q.id}-r3">3</label>
                        <input type="radio" id="${q.id}-r4" name="${q.id}" value="4"><label for="${q.id}-r4">4</label>
                        <input type="radio" id="${q.id}-r5" name="${q.id}" value="5"><label for="${q.id}-r5">5</label>
                    </div>
                    <div class="comments">
                        <textarea name="${q.id}-comments" placeholder="Comentarios específicos del día"></textarea>
                    </div>
                `;
                dynamicQuestionsContainer.appendChild(questionDiv);
            });
        }

        function loadDailyForm() {
            const todayKey = formatDate(currentDate);
            const evaluationForToday = dailyEvaluations[todayKey];
            const selectedPuesto = puestoSelect.value;

            // Render questions based on selected puesto first
            renderDailyQuestions(selectedPuesto);

            // If a puesto isn't selected, stop here.
            if (!selectedPuesto) {
                return;
            }

            // Reset form (specifically radio buttons and textareas)
            dailyEvaluationForm.reset();
            document.querySelectorAll('textarea[name$="-comments"]').forEach(textarea => textarea.value = '');

            if (evaluationForToday && evaluationForToday.puesto === selectedPuesto) {
                // Populate form if data exists for this day AND matches the current selected puesto
                questions[selectedPuesto].forEach(q => {
                    const score = evaluationForToday[q.id];
                    if (score) {
                        const radioBtn = document.querySelector(`input[name="${q.id}"][value="${score}"]`);
                        if (radioBtn) radioBtn.checked = true;
                    }
                    const comments = evaluationForToday[`${q.id}-comments`];
                    if (comments) {
                        const textarea = document.querySelector(`textarea[name="${q.id}-comments"]`);
                        if (textarea) textarea.value = comments;
                    }
                });
            }
        }

        function saveDailyEvaluation() {
            const selectedPuesto = puestoSelect.value;
            if (!selectedPuesto) {
                alert("Por favor, seleccione un puesto antes de guardar la evaluación diaria.");
                return false;
            }

            const todayKey = formatDate(currentDate);
            const dailyData = {
                puesto: selectedPuesto // Store the puesto with the daily evaluation
            };
            let allAnswered = true;

            const currentQuestions = questions[selectedPuesto];
            currentQuestions.forEach(q => {
                const selectedOption = document.querySelector(`input[name="${q.id}"]:checked`);
                if (!selectedOption) {
                    allAnswered = false;
                    return; // Exit forEach early
                }
                dailyData[q.id] = parseInt(selectedOption.value);
                dailyData[`${q.id}-comments`] = document.querySelector(`textarea[name="${q.id}-comments"]`).value;
            });

            if (!allAnswered) {
                alert('Por favor, califica todas las preguntas diarias antes de guardar.');
                return false;
            }

            dailyEvaluations[todayKey] = dailyData;
            alert(`Evaluación para el día ${todayKey} (${selectedPuesto}) guardada.`);
            return true;
        }

        function calculateFinalEvaluation() {
            const startDateString = fechaInicioPruebaInput.value;
            const selectedPuesto = puestoSelect.value;
            if (!startDateString || !selectedPuesto) {
                alert("Por favor, ingresa la 'Fecha de Inicio de Prueba' y selecciona el 'Puesto a Evaluar' del colaborador primero.");
                return;
            }

            const startDate = parseDate(startDateString);
            let totalScoreSum = 0;
            let criticalLowScoreCount = 0; // Number of days with critical low scores
            let daysWithEvaluations = 0;
            let consolidatedComments = [];

            const MAX_DAYS_FOR_EVALUATION = 90; // Fixed 90 days for evaluation
            const currentPuestoQuestions = questions[selectedPuesto];
            const numDailyQuestions = currentPuestoQuestions.length;
            const numCriticalQuestions = currentPuestoQuestions.filter(q => q.critical).length;


            let tempDate = new Date(startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day

            const allPossibleEvaluationDates = [];
            let dayCounter = 0;
            while (dayCounter < MAX_DAYS_FOR_EVALUATION) {
                // Skip weekends (Saturday = 6, Sunday = 0)
                if (tempDate.getDay() !== 0 && tempDate.getDay() !== 6) {
                    allPossibleEvaluationDates.push(formatDate(tempDate));
                    dayCounter++;
                }
                tempDate.setDate(tempDate.getDate() + 1);
            }

            allPossibleEvaluationDates.forEach(dateKey => {
                const dailyData = dailyEvaluations[dateKey];
                if (dailyData && dailyData.puesto === selectedPuesto) { // Ensure evaluation is for the correct puesto
                    daysWithEvaluations++;
                    let dailyScore = 0;
                    let dailyCriticalLow = false;

                    currentPuestoQuestions.forEach(q => {
                        const score = dailyData[q.id];
                        if (score !== undefined) {
                            dailyScore += score;
                            if (q.critical && (score === 1 || score === 2)) {
                                dailyCriticalLow = true;
                            }
                            const comment = dailyData[`${q.id}-comments`];
                            if (comment) {
                                consolidatedComments.push(`Día ${dateKey} - ${q.text.split('.')[0]}: ${comment}`);
                            }
                        }
                    });
                    totalScoreSum += dailyScore;
                    if (dailyCriticalLow) {
                        criticalLowScoreCount++;
                    }
                }
            });

            // Calculate overall averages
            const averageOverallScore = daysWithEvaluations > 0 ? (totalScoreSum / (daysWithEvaluations * numDailyQuestions)).toFixed(2) : 'N/A';

            let finalResultText = "";
            let finalAdditionalComments = "";

            // --- Logic for final qualification ---
            const minDaysRequired = Math.ceil(MAX_DAYS_FOR_EVALUATION * 0.85); // Require at least 85% of days evaluated
            const maxCriticalFailuresAllowed = Math.ceil(MAX_DAYS_FOR_EVALUATION * 0.05); // Max 5% of days can have critical failures
            const passingAverageScore = 3.5; // Average score needed to pass
            const conditionalPassingAverageScore = 2.8; // Average score for "with reservations"

            if (daysWithEvaluations < minDaysRequired) {
                finalResultText = "Evaluación Incompleta: Se necesita más información.";
                finalAdditionalComments = `Se han evaluado ${daysWithEvaluations} días de ${MAX_DAYS_FOR_EVALUATION} posibles. Se requiere al menos el ${minDaysRequired} (${minDaysRequired} días) de evaluaciones completas para este puesto.`;
            } else if (criticalLowScoreCount > maxCriticalFailuresAllowed) {
                finalResultText = "No Califica para la Posición / No se Recomienda Contratación Fija.";
                finalAdditionalComments = `Justificación: El colaborador ha presentado deficiencias críticas en el desempeño diario (${criticalLowScoreCount} días con fallas críticas), superando el límite permitido de ${maxCriticalFailuresAllowed} días.`;
            } else if (averageOverallScore >= passingAverageScore) {
                finalResultText = "Califica para la Posición y se Recomienda Contratación Fija.";
                finalAdditionalComments = `Justificación: El colaborador ha demostrado consistentemente un alto desempeño para el puesto de ${selectedPuesto}, con un promedio diario de ${averageOverallScore} y excelente cumplimiento de los criterios críticos.`;
            } else if (averageOverallScore >= conditionalPassingAverageScore) {
                finalResultText = "Califica con Reservas / Requiere Monitoreo Continuo.";
                finalAdditionalComments = `Justificación: El colaborador cumple con la mayoría de los requisitos para el puesto de ${selectedPuesto}, pero su promedio de ${averageOverallScore} indica áreas de oportunidad. Se recomienda un plan de mejora y monitoreo constante.`;
            } else {
                finalResultText = "No Califica para la Posición / No se Recomienda Contratación Fija.";
                finalAdditionalComments = `Justificación: El desempeño general del colaborador (${averageOverallScore} de promedio) y/o la frecuencia de problemas críticos no cumplen con los estándares para el puesto de ${selectedPuesto}.`;
            }

            // Display results
            document.getElementById('final-average-score').textContent = averageOverallScore;
            document.getElementById('final-result-text').textContent = finalResultText;
            document.getElementById('final-additional-comments').textContent = consolidatedComments.join('\n') || finalAdditionalComments; // Show consolidated comments if available, otherwise general justification
            document.getElementById('days-evaluated-count').textContent = daysWithEvaluations;
            document.getElementById('total-expected-days').textContent = MAX_DAYS_FOR_EVALUATION;
            document.getElementById('final-evaluator-name-display').textContent = evaluadorInput.value;

            finalEvaluationResultDiv.classList.remove('hidden');
            signatureSection.classList.remove('hidden');
        }


        // --- Event Listeners ---
        prevDayBtn.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() - 1);
            updateDateDisplay();
            loadDailyForm();
        });

        nextDayBtn.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() + 1);
            updateDateDisplay();
            loadDailyForm();
        });

        puestoSelect.addEventListener('change', () => {
            // When the puesto changes, re-render questions and load any existing data for the current date and new puesto
            loadDailyForm();
        });

        dailyEvaluationForm.addEventListener('submit', function(event) {
            event.preventDefault();
            saveDailyEvaluation();
        });

        triggerFinalEvaluationBtn.addEventListener('click', calculateFinalEvaluation);


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            currentDate = new Date(); // Start with today's date
            currentDate.setHours(0, 0, 0, 0); // Normalize to start of the day
            updateDateDisplay();
            // Initial load won't have a puesto selected, so it will show blank.
            // User must select a puesto to see questions.
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RTM Data Importer | Carga Avanzada</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #15a086;
      --primary-dark: #12816d;
      --primary-light: rgba(21, 160, 134, 0.1);
      --primary-glow: rgba(21, 160, 134, 0.4);
      --background: #2c3e50;
      --surface: #1a2a3a;
      --surface-dark: #14202e;
      --surface-light: #243447;
      --text: #ffffff;
      --text-secondary: #b0bec5;
      --error: #ff3860;
      --error-dark: #e74c3c;
      --error-glow: rgba(231, 76, 60, 0.4);
      --warning: #ffdd57;
      --warning-dark: #f39c12;
      --warning-glow: rgba(241, 196, 15, 0.4);
      --success: #2ecc71;
      --success-dark: #27ae60;
      --success-glow: rgba(46, 204, 113, 0.4);
      --info: #3498db;
      --info-dark: #2980b9;
      --info-glow: rgba(52, 152, 219, 0.4);
      --border-radius: 12px;
      --border-radius-lg: 16px;
      --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      --box-shadow-lg: 0 12px 28px rgba(0, 0, 0, 0.4);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      --transition-fast: all 0.15s ease-out;
      --spacing-unit: 16px;
      --neon-glow: 0 0 10px currentColor, 0 0 20px currentColor;
      --neon-glow-sm: 0 0 5px currentColor, 0 0 10px currentColor;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--background);
      color: var(--text);
      line-height: 1.6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: var(--spacing-unit);
      background-image: 
        radial-gradient(circle at 20% 30%, var(--primary-glow) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, var(--info-glow) 0%, transparent 40%);
      background-attachment: fixed;
    }

    .container {
      width: 100%;
      max-width: 900px;
      background-color: var(--surface);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--box-shadow-lg);
      padding: calc(var(--spacing-unit) * 2);
      position: relative;
      overflow: hidden;
      z-index: 1;
      margin: var(--spacing-unit) 0;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--info));
      z-index: 2;
    }

    h1 {
      text-align: center;
      margin-bottom: calc(var(--spacing-unit) * 1.5);
      font-weight: 600;
      font-size: 28px;
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      text-shadow: var(--neon-glow-sm);
    }

    .upload-section {
      border: 2px dashed var(--primary);
      border-radius: var(--border-radius-lg);
      padding: calc(var(--spacing-unit) * 2) var(--spacing-unit);
      text-align: center;
      margin-bottom: calc(var(--spacing-unit) * 1.5);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      background-color: var(--surface-dark);
      overflow: hidden;
    }

    .upload-section:hover {
      background-color: var(--primary-light);
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      border-color: var(--success);
    }

    .upload-section i {
      font-size: 48px;
      color: var(--primary);
      margin-bottom: var(--spacing-unit);
      transition: var(--transition);
      text-shadow: var(--neon-glow-sm);
    }

    .upload-section:hover i {
      transform: scale(1.1);
      color: var(--success);
    }

    .upload-section p {
      margin: var(--spacing-unit) 0;
      color: var(--text-secondary);
    }

    .upload-section .subtext {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: calc(var(--spacing-unit) / 2);
    }

    #fileInput {
      display: none;
    }

    .btn {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: calc(var(--spacing-unit) * 0.75) calc(var(--spacing-unit) * 1.5);
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
      margin: calc(var(--spacing-unit) / 2) 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        to bottom right,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0) 30%,
        rgba(255, 255, 255, 0.3) 45%,
        rgba(255, 255, 255, 0) 60%,
        rgba(255, 255, 255, 0) 100%
      );
      transform: rotate(30deg);
      transition: all 0.7s cubic-bezier(0.19, 1, 0.22, 1);
    }

    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(21, 160, 134, 0.3);
    }

    .btn:hover::before {
      left: 100%;
      top: 100%;
    }

    .btn-secondary {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .btn-secondary:hover {
      background-color: var(--primary-light);
      text-shadow: var(--neon-glow-sm);
    }

    .btn-danger {
      background-color: var(--error);
    }

    .btn-danger:hover {
      background-color: var(--error-dark);
      box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3);
    }

    .btn-success {
      background-color: var(--success);
    }

    .btn-success:hover {
      background-color: var(--success-dark);
      box-shadow: 0 6px 12px rgba(46, 204, 113, 0.3);
    }

    .btn-info {
      background-color: var(--info);
    }

    .btn-info:hover {
      background-color: var(--info-dark);
      box-shadow: 0 6px 12px rgba(52, 152, 219, 0.3);
    }

    .btn-sm {
      padding: calc(var(--spacing-unit) / 2) var(--spacing-unit);
      font-size: 14px;
    }

    .options-section {
      margin-top: calc(var(--spacing-unit) * 1.5);
      padding-top: calc(var(--spacing-unit) * 1.5);
      border-top: 1px solid var(--surface-light);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: var(--spacing-unit);
      color: var(--primary);
      font-weight: 500;
      font-size: 18px;
    }

    .section-title i {
      text-shadow: var(--neon-glow-sm);
    }

    .option-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--spacing-unit);
      margin-bottom: var(--spacing-unit);
    }

    .option-group {
      margin-bottom: 0;
    }

    .option-group label {
      display: block;
      margin-bottom: calc(var(--spacing-unit) / 2);
      color: var(--primary);
      font-weight: 500;
      font-size: 14px;
    }

    .option-group select, 
    .option-group input {
      width: 100%;
      padding: calc(var(--spacing-unit) * 0.75);
      border-radius: var(--border-radius);
      border: 1px solid var(--surface-light);
      background-color: var(--surface-dark);
      color: var(--text);
      transition: var(--transition);
      font-family: 'Poppins', sans-serif;
      margin-bottom: calc(var(--spacing-unit) / 2);
    }

    .option-group select:focus, 
    .option-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(21, 160, 134, 0.2);
    }

    .preview-section {
      margin-top: calc(var(--spacing-unit) * 2);
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid var(--surface-light);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-unit);
      background-color: var(--surface-dark);
      transition: var(--transition);
    }

    .preview-section:hover {
      border-color: var(--primary);
      box-shadow: var(--box-shadow);
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-unit);
      padding-bottom: var(--spacing-unit);
      border-bottom: 1px solid var(--surface-light);
    }

    .preview-content {
      font-family: 'Roboto Mono', monospace;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.7;
    }

    /* Sistema de alertas futurista */
    .alert-container {
      position: fixed;
      top: var(--spacing-unit);
      right: var(--spacing-unit);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-unit);
      max-width: 350px;
      width: 100%;
    }

    .alert {
      padding: calc(var(--spacing-unit) * 0.75) var(--spacing-unit);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--box-shadow-lg);
      display: flex;
      align-items: flex-start;
      gap: calc(var(--spacing-unit) / 2);
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-height: 0;
      margin: 0;
      padding: 0;
    }

    .alert::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: currentColor;
      opacity: 0.6;
    }

    .alert::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.05) 0%,
        rgba(255, 255, 255, 0.01) 100%
      );
      z-index: -1;
    }

    .alert.show {
      opacity: 1;
      transform: translateX(0);
      max-height: 200px;
      padding: calc(var(--spacing-unit) * 0.75) var(--spacing-unit);
      margin: 0;
    }

    .alert.hide {
      opacity: 0;
      transform: translateX(100%);
      max-height: 0;
      padding: 0;
      margin: 0;
    }

    /* Alertas de confirmación especiales */
    .alert-confirm {
      background-color: rgba(46, 204, 113, 0.15);
      border: 1px solid var(--success);
      color: white;
      animation: pulse-glow 2s infinite;
    }

    @keyframes pulse-glow {
      0% { box-shadow: 0 0 5px var(--success-glow); }
      50% { box-shadow: 0 0 20px var(--success-glow); }
      100% { box-shadow: 0 0 5px var(--success-glow); }
    }

    .alert-success {
      background-color: rgba(46, 204, 113, 0.15);
      border: 1px solid var(--success);
      color: white;
    }

    .alert-error {
      background-color: rgba(231, 76, 60, 0.15);
      border: 1px solid var(--error);
      color: white;
    }

    .alert-warning {
      background-color: rgba(241, 196, 15, 0.15);
      border: 1px solid var(--warning);
      color: white;
    }

    .alert-info {
      background-color: rgba(52, 152, 219, 0.15);
      border: 1px solid var(--info);
      color: white;
    }

    .alert-icon {
      font-size: 20px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .alert-success .alert-icon {
      color: var(--success);
      text-shadow: 0 0 8px var(--success-glow);
    }

    .alert-error .alert-icon {
      color: var(--error);
      text-shadow: 0 0 8px var(--error-glow);
    }

    .alert-warning .alert-icon {
      color: var(--warning);
      text-shadow: 0 0 8px var(--warning-glow);
    }

    .alert-info .alert-icon {
      color: var(--info);
      text-shadow: 0 0 8px var(--info-glow);
    }

    .alert-confirm .alert-icon {
      color: var(--success);
      text-shadow: 0 0 8px var(--success-glow);
      animation: pulse-icon 2s infinite;
    }

    @keyframes pulse-icon {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .alert-content {
      flex-grow: 1;
      font-size: 14px;
    }

    .alert-title {
      font-weight: 600;
      margin-bottom: calc(var(--spacing-unit) / 4);
      display: flex;
      align-items: center;
      gap: calc(var(--spacing-unit) / 2);
    }

    .alert-close {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 0;
      margin-left: calc(var(--spacing-unit) / 2);
      opacity: 0.7;
      transition: var(--transition-fast);
      align-self: flex-start;
    }

    .alert-close:hover {
      opacity: 1;
      transform: rotate(90deg);
    }

    .alert-progress {
      height: 3px;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      margin-top: calc(var(--spacing-unit) / 2);
      overflow: hidden;
    }

    .alert-progress-bar {
      height: 100%;
      background-color: currentColor;
      width: 100%;
      transition: width 0.1s linear;
    }

    .loading {
      display: none;
      text-align: center;
      margin: calc(var(--spacing-unit) * 1.5) 0;
      padding: var(--spacing-unit);
      border-radius: var(--border-radius);
      background-color: var(--surface-dark);
    }

    .loading i {
      font-size: 36px;
      color: var(--primary);
      animation: spin 1.5s linear infinite;
      margin-bottom: var(--spacing-unit);
      text-shadow: var(--neon-glow-sm);
    }

    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    .file-info {
      margin-top: var(--spacing-unit);
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 0 calc(var(--spacing-unit) / 2);
    }

    .reporte-item {
      margin-bottom: var(--spacing-unit);
      padding: var(--spacing-unit);
      background-color: var(--surface-dark);
      border-radius: var(--border-radius-lg);
      border-left: 4px solid var(--primary);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .reporte-item:hover {
      transform: translateY(-3px);
      box-shadow: var(--box-shadow);
    }

    .reporte-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background-color: var(--primary);
    }

    .reporte-item h3 {
      margin-top: 0;
      color: var(--primary);
      padding-bottom: calc(var(--spacing-unit) / 2);
      margin-bottom: var(--spacing-unit);
      border-bottom: 1px solid var(--surface-light);
      display: flex;
      align-items: center;
      gap: 10px;
      text-shadow: var(--neon-glow-sm);
    }

    .reporte-field {
      margin-bottom: var(--spacing-unit);
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: var(--spacing-unit);
      align-items: center;
    }

    .reporte-field label {
      font-weight: 500;
      color: var(--primary);
      font-size: 14px;
    }

    .reporte-field p {
      margin: 0;
      padding: calc(var(--spacing-unit) / 2);
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      word-break: break-word;
    }

    .reporte-imagen {
      max-width: 100%;
      border-radius: var(--border-radius);
      margin-top: calc(var(--spacing-unit) / 2);
      border: 1px solid var(--surface-light);
      transition: var(--transition);
    }

    .reporte-imagen:hover {
      transform: scale(1.02);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .acciones-reporte {
      display: flex;
      gap: calc(var(--spacing-unit) / 2);
      margin-top: var(--spacing-unit);
      justify-content: flex-end;
    }

    .progress-container {
      width: 100%;
      margin: var(--spacing-unit) 0;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: calc(var(--spacing-unit) / 2);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: var(--surface-dark);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: var(--progress, 0%);
      background: linear-gradient(90deg, var(--primary), var(--info));
      border-radius: 4px;
      transition: width 0.4s ease;
    }

    .progress-text {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: calc(var(--spacing-unit) / 2);
    }

    .tech-badge {
      position: absolute;
      top: var(--spacing-unit);
      right: var(--spacing-unit);
      background-color: var(--surface-light);
      color: var(--primary);
      padding: calc(var(--spacing-unit) / 2) var(--spacing-unit);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 5px;
      border: 1px solid rgba(21, 160, 134, 0.3);
      text-shadow: var(--neon-glow-sm);
    }

    .glow {
      position: absolute;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, var(--primary-glow) 0%, transparent 70%);
      filter: blur(20px);
      z-index: -1;
    }

    .glow-1 {
      top: -50px;
      right: -50px;
    }

    .glow-2 {
      bottom: -50px;
      left: -50px;
      background: radial-gradient(circle, var(--info-glow) 0%, transparent 70%);
    }

    /* Efectos de neón para elementos importantes */
    .neon-effect {
      position: relative;
    }

    .neon-effect::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: inherit;
      box-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .neon-effect:hover::after {
      opacity: 0.7;
    }

    @media (max-width: 768px) {
      .container {
        padding: var(--spacing-unit);
      }
      
      .option-grid {
        grid-template-columns: 1fr;
      }
      
      .reporte-field {
        grid-template-columns: 1fr;
        gap: calc(var(--spacing-unit) / 2);
      }
      
      .acciones-reporte {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }

      .alert-container {
        max-width: calc(100% - (var(--spacing-unit) * 2));
        top: auto;
        bottom: var(--spacing-unit);
        right: var(--spacing-unit);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="glow glow-1"></div>
    <div class="glow glow-2"></div>
    
    <span class="tech-badge neon-effect">
      <i class="fas fa-bolt"></i> RTMDAYLI v2.0
    </span>
    
    <h1>
      <i class="fas fa-cloud-upload-alt"></i> RTM Data Importer
    </h1>
    
    <div class="upload-section" id="uploadArea">
      <i class="fas fa-file-import"></i>
      <p>Arrastra y suelta tu archivo .rtmdayli aquí</p>
      <p class="subtext">Formatos compatibles: RTMDAYLI v1.0+</p>
      <button class="btn neon-effect" id="selectFileBtn">
        <i class="fas fa-folder-open"></i> Seleccionar Archivo
      </button>
      <input type="file" id="fileInput" accept=".rtmdayli">
      <div class="file-info" id="fileInfo">
        <i class="fas fa-info-circle"></i> Ningún archivo seleccionado
      </div>
    </div>
    
    <div class="options-section">
      <div class="section-title">
        <i class="fas fa-sliders-h"></i>
        <span>Opciones de Importación</span>
      </div>
      
      <div class="option-grid">
        <div class="option-group">
          <label for="importMode">
            <i class="fas fa-exchange-alt"></i> Modo de Importación
          </label>
          <select id="importMode">
            <option value="new">Agregar como nuevos registros</option>
            <option value="replace">Reemplazar registros existentes</option>
            <option value="merge">Combinar con registros existentes</option>
          </select>
        </div>
        
        <div class="option-group">
          <label for="collectionName">
            <i class="fas fa-database"></i> Colección de destino
          </label>
          <input type="text" id="collectionName" value="Reportes" readonly>
        </div>
        
        <div class="option-group">
          <label for="verifyHash">
            <i class="fas fa-shield-alt"></i> Verificación de integridad
          </label>
          <select id="verifyHash">
            <option value="yes">Sí (recomendado)</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>
      
      <div class="acciones-reporte">
        <button class="btn btn-secondary neon-effect" id="previewBtn" disabled>
          <i class="fas fa-eye"></i> Vista Previa
        </button>
        <button class="btn neon-effect" id="importBtn" disabled>
          <i class="fas fa-file-import"></i> Importar Archivo
        </button>
      </div>
    </div>
    
    <div class="loading" id="loadingIndicator">
      <i class="fas fa-spinner"></i>
      <p>Procesando archivo, por favor espere...</p>
      
      <div class="progress-container">
        <div class="progress-header">
          <span id="progressStatus">Validando archivo...</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar" id="progressBar"></div>
        <div class="progress-text" id="progressText"></div>
      </div>
    </div>
    
    <div class="preview-section" id="previewSection" style="display: none;">
      <div class="preview-header">
        <h3>
          <i class="fas fa-file-alt"></i> Vista Previa del Archivo
        </h3>
        <button class="btn btn-secondary btn-sm neon-effect" id="closePreviewBtn">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>
      <div id="filePreviewContent"></div>
    </div>
    
    <div id="reportesPreview" style="display: none; margin-top: calc(var(--spacing-unit) * 2);">
      <div class="section-title">
        <i class="fas fa-clipboard-list"></i>
        <span>Reportes a Importar</span>
      </div>
      
      <div id="reportesList"></div>
      
      <div class="acciones-reporte">
        <button class="btn btn-secondary neon-effect" id="cancelImportBtn">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button class="btn neon-effect" id="confirmImportBtn">
          <i class="fas fa-check"></i> Confirmar Importación
        </button>
      </div>
    </div>
  </div>
  
  <div class="alert-container" id="alertContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
      authDomain: "inventario-35d6b.firebaseapp.com",
      databaseURL: "https://inventario-35d6b-default-rtdb.firebaseio.com",
      projectId: "inventario-35d6b",
      storageBucket: "inventario-35d6b.appspot.com",
      messagingSenderId: "266100399659",
      appId: "1:266100399659:web:92358d28cbd803c8a7d46e"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // Variables globales
    let currentUser = null;
    let fileContent = null;
    let fileData = null;
    let selectedFile = null;

    // Verificar si el usuario está logueado
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
      } else {
        window.location.href = "login.html";
      }
    });

    // Función para mostrar alerta
    function mostrarAlerta(mensaje, tipo = 'success', tiempo = 3000, titulo = '', progress = false) {
      const alertContainer = document.getElementById('alertContainer');
      const alertId = 'alert-' + Date.now();
      
      const iconos = {
        success: 'check-circle',
        error: 'exclamation-circle',
        warning: 'exclamation-triangle',
        info: 'info-circle',
        confirm: 'sync-alt'
      };
      
      const alert = document.createElement('div');
      alert.className = `alert ${tipo === 'confirm' ? 'alert-confirm' : `alert-${tipo}`}`;
      alert.id = alertId;
      
      let progressBar = '';
      if (progress) {
        progressBar = `
          <div class="alert-progress">
            <div class="alert-progress-bar" id="${alertId}-progress" style="width: 100%"></div>
          </div>
        `;
      }
      
      alert.innerHTML = `
        <i class="fas fa-${iconos[tipo]} alert-icon"></i>
        <div class="alert-content">
          ${titulo ? `<div class="alert-title">${titulo}</div>` : ''}
          <div>${mensaje}</div>
          ${progressBar}
        </div>
        ${tiempo > 0 ? `
        <button class="alert-close" onclick="document.getElementById('${alertId}').classList.add('hide')">
          <i class="fas fa-times"></i>
        </button>
        ` : ''}
      `;
      
      alertContainer.appendChild(alert);
      
      // Forzar reflow para activar la animación
      void alert.offsetWidth;
      
      alert.classList.add('show');
      
      // Animación de progreso si es necesario
      if (progress && tiempo > 0) {
        const progressBar = document.getElementById(`${alertId}-progress`);
        const interval = 50;
        const steps = tiempo / interval;
        let step = 0;
        
        const progressInterval = setInterval(() => {
          step++;
          const newWidth = 100 - (step * 100 / steps);
          progressBar.style.width = `${newWidth}%`;
          
          if (step >= steps) {
            clearInterval(progressInterval);
          }
        }, interval);
      }
      
      if (tiempo > 0) {
        setTimeout(() => {
          const alertElement = document.getElementById(alertId);
          if (alertElement) {
            alertElement.classList.add('hide');
            setTimeout(() => {
              if (alertElement.parentNode) {
                alertElement.parentNode.removeChild(alertElement);
              }
            }, 500);
          }
        }, tiempo);
      }
      
      return alertId;
    }

    // Función para actualizar progreso
    function actualizarProgreso(porcentaje, mensaje, textoAdicional = '') {
      const progressBar = document.getElementById('progressBar');
      const progressPercent = document.getElementById('progressPercent');
      const progressStatus = document.getElementById('progressStatus');
      const progressText = document.getElementById('progressText');
      
      progressBar.style.setProperty('--progress', `${porcentaje}%`);
      progressPercent.textContent = `${porcentaje}%`;
      progressStatus.textContent = mensaje;
      progressText.textContent = textoAdicional;
    }

    // Función para generar hash (debe coincidir con el usado en la exportación)
    function generarHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash.toString(16);
    }

    // Función para validar el formato .rtmdayli
    function validarFormatoRtmdayli(contenido) {
      try {
        // Verificar el prefijo RTMDAyLI
        if (!contenido.startsWith('RTMDAyLI')) {
          return { valido: false, error: "El archivo no tiene el formato .rtmdayli válido" };
        }
        
        // Extraer la parte codificada
        const partes = contenido.split('|');
        const dataCodificada = partes[0].substring(8); // Eliminar el prefijo RTMDAyLI
        
        // Decodificar los datos
        const dataJSON = atob(dataCodificada);
        const data = JSON.parse(dataJSON);
        
        // Verificar la estructura básica
        if (!data.metadata || !data.contenido || !data.seguridad) {
          return { valido: false, error: "Estructura del archivo inválida" };
        }
        
        // Verificar el hash si está habilitado
        const verificarHash = document.getElementById('verifyHash').value === 'yes';
        if (verificarHash) {
          const hashCalculado = generarHash(JSON.stringify(data.contenido.datos));
          if (hashCalculado !== data.seguridad.hashVerificacion) {
            return { valido: false, error: "La integridad del archivo no puede verificarse (hash no coincide)" };
          }
        }
        
        return { valido: true, data: data };
      } catch (error) {
        return { valido: false, error: "Error al procesar el archivo: " + error.message };
      }
    }

    // Función para cargar y procesar el archivo
    async function procesarArchivo(file) {
      const reader = new FileReader();
      
      return new Promise((resolve, reject) => {
        reader.onload = (event) => {
          try {
            const contenido = event.target.result;
            const validacion = validarFormatoRtmdayli(contenido);
            
            if (!validacion.valido) {
              reject(validacion.error);
              return;
            }
            
            resolve(validacion.data);
          } catch (error) {
            reject(error.message);
          }
        };
        
        reader.onerror = () => {
          reject("Error al leer el archivo");
        };
        
        reader.readAsText(file);
      });
    }

    // Función para subir imágenes a Storage si es necesario
    async function subirImagenes(reporte) {
      if (!reporte.fotoURL) return reporte;
      
      try {
        // Verificar si la URL ya es de Firebase Storage
        if (reporte.fotoURL.includes('firebasestorage.googleapis.com')) {
          return reporte;
        }
        
        // Si es una URL base64 o de otro tipo, subirla a Storage
        if (reporte.fotoURL.startsWith('data:image')) {
          actualizarProgreso(30, "Subiendo imagen adjunta...", "Esto puede tomar unos momentos...");
          
          // Mostrar alerta de progreso
          const alertId = mostrarAlerta(
            "Subiendo imagen adjunta al servidor...",
            "info",
            0, // Sin tiempo de expiración
            "Procesando archivos",
            false
          );
          
          const response = await fetch(reporte.fotoURL);
          const blob = await response.blob();
          const storageRef = ref(storage, `reportes/${currentUser.uid}/${Date.now()}.jpg`);
          await uploadBytes(storageRef, blob);
          const nuevaUrl = await getDownloadURL(storageRef);
          reporte.fotoURL = nuevaUrl;
          
          // Cerrar alerta de progreso
          const alertElement = document.getElementById(alertId);
          if (alertElement) {
            alertElement.classList.add('hide');
            setTimeout(() => {
              if (alertElement.parentNode) {
                alertElement.parentNode.removeChild(alertElement);
              }
            }, 500);
          }
          
          actualizarProgreso(50, "Imagen subida correctamente", "Procesando datos...");
          
          // Mostrar alerta de éxito
          mostrarAlerta(
            "Imagen adjunta subida correctamente al servidor",
            "success",
            3000,
            "Operación exitosa"
          );
        }
        
        return reporte;
      } catch (error) {
        console.error("Error al subir imagen:", error);
        // Mostrar alerta de error
        mostrarAlerta(
          "Error al subir la imagen adjunta. Se mantendrá la referencia original.",
          "error",
          4000,
          "Error en archivo"
        );
        return reporte; // Devolver el reporte original si hay error
      }
    }

    // Función para importar los datos a Firestore
    async function importarDatos() {
      const importMode = document.getElementById('importMode').value;
      const collectionName = document.getElementById('collectionName').value;
      
      if (!fileData) {
        mostrarAlerta(
          "No hay datos válidos para importar",
          "error",
          3000,
          "Error de importación"
        );
        return;
      }
      
      document.getElementById('loadingIndicator').style.display = 'block';
      document.getElementById('importBtn').disabled = true;
      document.getElementById('previewBtn').disabled = true;
      
      try {
        let datosAImportar = [];
        
        // Determinar la estructura del archivo
        if (fileData.metadata.tipo === 'reporte') {
          datosAImportar = [fileData.contenido.datos];
        } else if (fileData.metadata.tipo === 'paquete_reportes' || fileData.metadata.tipo === 'vista_reportes') {
          datosAImportar = fileData.contenido.datos.reportes;
        } else if (fileData.metadata.tipo === 'configuracion_completa') {
          datosAImportar = fileData.contenido.datos.reportes;
        }
        
        let contador = 0;
        let errores = 0;
        const total = datosAImportar.length;
        
        // Mostrar alerta de confirmación especial
        const confirmacionId = mostrarAlerta(
          `Importando ${total} reportes a la colección "${collectionName}"...`,
          "confirm",
          0, // Sin tiempo de expiración
          "Importación en progreso",
          false
        );
        
        for (const dato of datosAImportar) {
          try {
            // Actualizar progreso
            const porcentaje = Math.round((contador + errores) / total * 100);
            actualizarProgreso(
              porcentaje, 
              `Procesando reporte ${contador + errores + 1} de ${total}...`,
              `Registros exitosos: ${contador} | Errores: ${errores}`
            );
            
            // Procesar imágenes si existen
            const reporteProcesado = await subirImagenes(dato);
            
            // Asegurarnos de que la fecha del incidente esté correctamente formateada
            if (reporteProcesado.fechaHoraIncidente) {
              // Convertir a objeto Date si es una cadena
              if (typeof reporteProcesado.fechaHoraIncidente === 'string') {
                reporteProcesado.fechaHoraIncidente = new Date(reporteProcesado.fechaHoraIncidente);
              }
              // Si es un timestamp de Firebase, convertirlo
              if (reporteProcesado.fechaHoraIncidente.seconds) {
                reporteProcesado.fechaHoraIncidente = new Date(reporteProcesado.fechaHoraIncidente.seconds * 1000);
              }
            }
            
            // Determinar el ID del documento
            const docId = dato.id || doc(collection(db, collectionName)).id;
            
            // Aplicar el modo de importación seleccionado
            if (importMode === 'replace') {
              await setDoc(doc(db, collectionName, docId), reporteProcesado);
              contador++;
            } else if (importMode === 'merge') {
              await setDoc(doc(db, collectionName, docId), reporteProcesado, { merge: true });
              contador++;
            } else if (importMode === 'new') {
              // Para nuevo, siempre generamos un nuevo ID
              await setDoc(doc(collection(db, collectionName)), reporteProcesado);
              contador++;
            }
          } catch (error) {
            console.error(`Error importando documento: ${error}`);
            errores++;
          }
        }
        
        // Eliminar alerta de confirmación
        const confirmacionElement = document.getElementById(confirmacionId);
        if (confirmacionElement) {
          confirmacionElement.classList.add('hide');
          setTimeout(() => {
            if (confirmacionElement.parentNode) {
              confirmacionElement.parentNode.removeChild(confirmacionElement);
            }
          }, 500);
        }
        
        actualizarProgreso(100, "Importación completada", `Proceso finalizado: ${contador} registros importados`);
        
        // Mostrar alerta de resultado final
        if (errores > 0) {
          mostrarAlerta(
            `Importación completada con ${errores} errores. ${contador} registros procesados correctamente.`,
            errores === total ? "error" : "warning",
            5000,
            errores === total ? "Importación fallida" : "Importación parcial"
          );
        } else {
          mostrarAlerta(
            `✅ Importación completada exitosamente. ${contador} registros procesados.`,
            "success",
            5000,
            "Operación exitosa"
          );
        }
        
        setTimeout(() => {
          document.getElementById('loadingIndicator').style.display = 'none';
          document.getElementById('importBtn').disabled = false;
          document.getElementById('previewBtn').disabled = false;
        }, 1000);
      } catch (error) {
        console.error("Error en la importación:", error);
        mostrarAlerta(
          `❌ Error durante la importación: ${error.message}`,
          "error",
          5000,
          "Error crítico"
        );
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('importBtn').disabled = false;
        document.getElementById('previewBtn').disabled = false;
      }
    }

    // Función para mostrar vista previa del archivo
    function mostrarVistaPrevia() {
      if (!fileData) return;
      
      const previewContent = document.getElementById('filePreviewContent');
      previewContent.innerHTML = '';
      
      // Mostrar metadatos
      const metadataDiv = document.createElement('div');
      metadataDiv.innerHTML = `
        <h4><i class="fas fa-info-circle"></i> Metadatos</h4>
        <div class="reporte-field">
          <label>Tipo:</label>
          <p>${fileData.metadata.tipo}</p>
        </div>
        <div class="reporte-field">
          <label>Versión:</label>
          <p>${fileData.metadata.version}</p>
        </div>
        <div class="reporte-field">
          <label>Fecha creación:</label>
          <p>${new Date(fileData.metadata.fechaCreacion).toLocaleString()}</p>
        </div>
        <div class="reporte-field">
          <label>Creador:</label>
          <p>${fileData.metadata.creador}</p>
        </div>
        <div class="reporte-field">
          <label>Colección origen:</label>
          <p>${fileData.metadata.coleccionOrigen}</p>
        </div>
      `;
      previewContent.appendChild(metadataDiv);
      
      // Mostrar información de seguridad
      const seguridadDiv = document.createElement('div');
      seguridadDiv.innerHTML = `
        <h4><i class="fas fa-shield-alt"></i> Seguridad</h4>
        <div class="reporte-field">
          <label>Hash verificación:</label>
          <p>${fileData.seguridad.hashVerificacion}</p>
        </div>
        <div class="reporte-field">
          <label>Marca agua:</label>
          <p>${fileData.seguridad.marcaAgua}</p>
        </div>
      `;
      previewContent.appendChild(seguridadDiv);
      
      // Mostrar resumen de contenido
      const contenidoDiv = document.createElement('div');
      let contenidoResumen = '';
      
      if (fileData.metadata.tipo === 'reporte') {
        contenidoResumen = `
          <h4><i class="fas fa-file-alt"></i> Contenido del Reporte</h4>
          <div class="reporte-field">
            <label>Nombre caso:</label>
            <p>${fileData.contenido.datos.nombreCaso || 'No especificado'}</p>
          </div>
          <div class="reporte-field">
            <label>Tipo caso:</label>
            <p>${fileData.contenido.datos.tipoCaso || 'No especificado'}</p>
          </div>
          <div class="reporte-field">
            <label>Fecha reporte:</label>
            <p>${fileData.contenido.datos.fechaReporte || 'No especificada'}</p>
          </div>
        `;
      } else if (fileData.metadata.tipo === 'paquete_reportes') {
        contenidoResumen = `
          <h4><i class="fas fa-boxes"></i> Paquete de Reportes</h4>
          <div class="reporte-field">
            <label>Cantidad reportes:</label>
            <p>${fileData.contenido.datos.reportes.length}</p>
          </div>
          <div class="reporte-field">
            <label>Primer reporte:</label>
            <p>${fileData.contenido.datos.reportes[0].nombreCaso || 'No especificado'}</p>
          </div>
        `;
      } else if (fileData.metadata.tipo === 'configuracion_completa') {
        contenidoResumen = `
          <h4><i class="fas fa-cogs"></i> Configuración Completa</h4>
          <div class="reporte-field">
            <label>Reportes:</label>
            <p>${fileData.contenido.datos.reportes.length}</p>
          </div>
          <div class="reporte-field">
            <label>Vista preferida:</label>
            <p>${fileData.contenido.datos.configuracion.vistaActual || 'No especificada'}</p>
          </div>
        `;
      }
      
      contenidoDiv.innerHTML = contenidoResumen;
      previewContent.appendChild(contenidoDiv);
      
      document.getElementById('previewSection').style.display = 'block';
    }

    // Función para mostrar vista previa de los reportes
    function mostrarReportesPreview() {
      if (!fileData) return;
      
      const reportesList = document.getElementById('reportesList');
      reportesList.innerHTML = '';
      
      let reportes = [];
      
      // Determinar la estructura del archivo
      if (fileData.metadata.tipo === 'reporte') {
        reportes = [fileData.contenido.datos];
      } else if (['paquete_reportes', 'vista_reportes', 'configuracion_completa'].includes(fileData.metadata.tipo)) {
        reportes = fileData.contenido.datos.reportes;
      }
      
      reportes.forEach((reporte, index) => {
        const reporteDiv = document.createElement('div');
        reporteDiv.className = 'reporte-item';
        
        // Formatear fechas correctamente
        const fechaIncidente = reporte.fechaHoraIncidente ? 
          (reporte.fechaHoraIncidente.toDate ? reporte.fechaHoraIncidente.toDate() : new Date(reporte.fechaHoraIncidente)) : 
          null;
        
        const fechaReporte = reporte.fechaReporte ? 
          (reporte.fechaReporte.toDate ? reporte.fechaReporte.toDate() : new Date(reporte.fechaReporte)) : 
          null;
        
        const horaReporte = reporte.horaReporte || 'No especificada';
        
        reporteDiv.innerHTML = `
          <h3>
            <i class="fas fa-file-alt"></i> 
            Reporte ${index + 1}: ${reporte.nombreCaso || 'Sin nombre'}
          </h3>
          
          <div class="reporte-field">
            <label><i class="fas fa-tag"></i> Tipo de Caso:</label>
            <p>${reporte.tipoCaso || 'No especificado'}</p>
          </div>
          
          <div class="reporte-field">
            <label><i class="fas fa-calendar-alt"></i> Fecha y Hora del Incidente:</label>
            <p>${fechaIncidente ? fechaIncidente.toLocaleString() : 'No especificada'}</p>
          </div>
          
          <div class="reporte-field">
            <label><i class="fas fa-user"></i> Reportado Por:</label>
            <p>${reporte.reportadoPor || 'No especificado'}</p>
          </div>
          
          <div class="reporte-field">
            <label><i class="fas fa-calendar-day"></i> Fecha del Reporte:</label>
            <p>${fechaReporte ? fechaReporte.toLocaleDateString() : 'No especificada'}</p>
          </div>
          
          <div class="reporte-field">
            <label><i class="fas fa-clock"></i> Hora del Reporte:</label>
            <p>${horaReporte}</p>
          </div>
          
          <div class="reporte-field">
            <label><i class="fas fa-align-left"></i> Descripción:</label>
            <p>${reporte.descripcion || 'No hay descripción'}</p>
          </div>
          
          ${reporte.fotoURL ? `
          <div class="reporte-field">
            <label><i class="fas fa-image"></i> Imagen:</label>
            <img src="${reporte.fotoURL}" alt="Foto del reporte" class="reporte-imagen">
          </div>
          ` : ''}
        `;
        
        reportesList.appendChild(reporteDiv);
      });
      
      document.getElementById('reportesPreview').style.display = 'block';
    }

    // Event Listeners
    document.getElementById('selectFileBtn').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });
    
    document.getElementById('fileInput').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      
      selectedFile = file;
      document.getElementById('fileInfo').innerHTML = `
        <i class="fas fa-check-circle"></i> Archivo seleccionado: 
        <strong>${file.name}</strong> (${(file.size / 1024).toFixed(2)} KB)
      `;
      
      try {
        document.getElementById('loadingIndicator').style.display = 'block';
        actualizarProgreso(20, "Validando archivo...", "Verificando formato RTMDAYLI");
        
        // Mostrar alerta de carga
        const cargaId = mostrarAlerta(
          "Validando archivo RTMDAYLI...",
          "info",
          0,
          "Procesando archivo"
        );
        
        fileData = await procesarArchivo(file);
        
        // Cerrar alerta de carga
        const cargaElement = document.getElementById(cargaId);
        if (cargaElement) {
          cargaElement.classList.add('hide');
          setTimeout(() => {
            if (cargaElement.parentNode) {
              cargaElement.parentNode.removeChild(cargaElement);
            }
          }, 500);
        }
        
        // Actualizar el nombre de colección si viene en el archivo
        if (fileData.metadata.coleccionOrigen) {
          document.getElementById('collectionName').value = fileData.metadata.coleccionOrigen;
        }
        
        mostrarAlerta(
          "Archivo cargado y validado correctamente",
          "success",
          3000,
          "Validación exitosa"
        );
        
        document.getElementById('importBtn').disabled = false;
        document.getElementById('previewBtn').disabled = false;
        actualizarProgreso(100, "Archivo listo para importar", "Puede previsualizar o importar ahora");
        setTimeout(() => {
          document.getElementById('loadingIndicator').style.display = 'none';
        }, 1000);
      } catch (error) {
        mostrarAlerta(
          `Error al procesar el archivo: ${error}`,
          "error",
          4000,
          "Error de validación"
        );
        document.getElementById('fileInfo').innerHTML = `
          <i class="fas fa-exclamation-circle"></i> Error en el archivo: ${error}
        `;
        document.getElementById('importBtn').disabled = true;
        document.getElementById('previewBtn').disabled = true;
        document.getElementById('loadingIndicator').style.display = 'none';
      }
    });
    
    document.getElementById('uploadArea').addEventListener('dragover', (event) => {
      event.preventDefault();
      event.stopPropagation();
      event.currentTarget.style.backgroundColor = 'var(--primary-light)';
      event.currentTarget.style.transform = 'translateY(-3px)';
    });
    
    document.getElementById('uploadArea').addEventListener('dragleave', (event) => {
      event.preventDefault();
      event.stopPropagation();
      event.currentTarget.style.backgroundColor = '';
      event.currentTarget.style.transform = '';
    });
    
    document.getElementById('uploadArea').addEventListener('drop', async (event) => {
      event.preventDefault();
      event.stopPropagation();
      event.currentTarget.style.backgroundColor = '';
      event.currentTarget.style.transform = '';
      
      const file = event.dataTransfer.files[0];
      if (!file || !file.name.endsWith('.rtmdayli')) {
        mostrarAlerta(
          "Por favor, suelta solo archivos .rtmdayli",
          "error",
          3000,
          "Formato incorrecto"
        );
        return;
      }
      
      selectedFile = file;
      document.getElementById('fileInput').files = event.dataTransfer.files;
      document.getElementById('fileInfo').innerHTML = `
        <i class="fas fa-check-circle"></i> Archivo seleccionado: 
        <strong>${file.name}</strong> (${(file.size / 1024).toFixed(2)} KB)
      `;
      
      try {
        document.getElementById('loadingIndicator').style.display = 'block';
        actualizarProgreso(20, "Validando archivo...", "Verificando formato RTMDAYLI");
        
        // Mostrar alerta de carga
        const cargaId = mostrarAlerta(
          "Validando archivo RTMDAYLI...",
          "info",
          0,
          "Procesando archivo"
        );
        
        fileData = await procesarArchivo(file);
        
        // Cerrar alerta de carga
        const cargaElement = document.getElementById(cargaId);
        if (cargaElement) {
          cargaElement.classList.add('hide');
          setTimeout(() => {
            if (cargaElement.parentNode) {
              cargaElement.parentNode.removeChild(cargaElement);
            }
          }, 500);
        }
        
        // Actualizar el nombre de colección si viene en el archivo
        if (fileData.metadata.coleccionOrigen) {
          document.getElementById('collectionName').value = fileData.metadata.coleccionOrigen;
        }
        
        mostrarAlerta(
          "Archivo cargado y validado correctamente",
          "success",
          3000,
          "Validación exitosa"
        );
        
        document.getElementById('importBtn').disabled = false;
        document.getElementById('previewBtn').disabled = false;
        actualizarProgreso(100, "Archivo listo para importar", "Puede previsualizar o importar ahora");
        setTimeout(() => {
          document.getElementById('loadingIndicator').style.display = 'none';
        }, 1000);
      } catch (error) {
        mostrarAlerta(
          `Error al procesar el archivo: ${error}`,
          "error",
          4000,
          "Error de validación"
        );
        document.getElementById('fileInfo').innerHTML = `
          <i class="fas fa-exclamation-circle"></i> Error en el archivo: ${error}
        `;
        document.getElementById('importBtn').disabled = true;
        document.getElementById('previewBtn').disabled = true;
        document.getElementById('loadingIndicator').style.display = 'none';
      }
    });
    
    document.getElementById('previewBtn').addEventListener('click', () => {
      mostrarVistaPrevia();
      mostrarReportesPreview();
    });
    
    document.getElementById('closePreviewBtn').addEventListener('click', () => {
      document.getElementById('previewSection').style.display = 'none';
    });
    
    document.getElementById('importBtn').addEventListener('click', () => {
      mostrarReportesPreview();
    });
    
    document.getElementById('confirmImportBtn').addEventListener('click', () => {
      const importMode = document.getElementById('importMode').value;
      let message = '';
      let titulo = '';
      
      if (fileData.metadata.tipo === 'reporte') {
        message = `¿Confirmas la importación de este reporte en modo ${importMode === 'new' ? 'nuevo' : importMode === 'replace' ? 'reemplazo' : 'combinación'}?`;
        titulo = "Confirmar importación";
      } else {
        const count = fileData.contenido.datos.reportes ? fileData.contenido.datos.reportes.length : 1;
        message = `¿Confirmas la importación de ${count} reportes en modo ${importMode === 'new' ? 'nuevo' : importMode === 'replace' ? 'reemplazo' : 'combinación'}?`;
        titulo = "Confirmar importación múltiple";
      }
      
      // Mostrar alerta de confirmación especial
      const confirmId = 'confirm-' + Date.now();
      const alertContainer = document.getElementById('alertContainer');
      
      const confirmAlert = document.createElement('div');
      confirmAlert.className = 'alert alert-confirm';
      confirmAlert.id = confirmId;
      confirmAlert.innerHTML = `
        <i class="fas fa-question-circle alert-icon"></i>
        <div class="alert-content">
          <div class="alert-title">${titulo}</div>
          <div>${message}</div>
          <div class="acciones-reporte" style="justify-content: center; margin-top: 10px;">
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('${confirmId}').classList.add('hide');" style="margin-right: 8px;">
              <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn btn-success btn-sm" onclick="document.getElementById('${confirmId}').classList.add('hide'); document.getElementById('reportesPreview').style.display = 'none'; importarDatos();">
              <i class="fas fa-check"></i> Confirmar
            </button>
          </div>
        </div>
      `;
      
      alertContainer.appendChild(confirmAlert);
      
      // Forzar reflow para activar la animación
      void confirmAlert.offsetWidth;
      
      confirmAlert.classList.add('show');
    });
    
    document.getElementById('cancelImportBtn').addEventListener('click', () => {
      document.getElementById('reportesPreview').style.display = 'none';
    });
  </script>
</body>
</html>

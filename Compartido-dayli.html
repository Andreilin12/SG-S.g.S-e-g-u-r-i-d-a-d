<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizador de Reportes</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #15a086;
      --secondary-color: #2c3e50;
      --background-color: #1a2a3a;
      --card-color: #34495e;
      --text-color: #ffffff;
      --highlight-color: #1abc9c;
      --danger-color: #e74c3c;
      --sidebar-width: 320px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--secondary-color);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      padding: 20px;
      overflow-y: auto;
      transition: transform 0.3s ease;
      z-index: 100;
      box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-header h2 {
      color: var(--highlight-color);
      font-size: 1.5rem;
      font-weight: 600;
    }

    .sidebar-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.5rem;
      cursor: pointer;
    }

    .search-container {
      margin-bottom: 20px;
      position: relative;
    }

    .search-container input {
      width: 100%;
      padding: 12px 15px 12px 40px;
      border-radius: 8px;
      border: none;
      background-color: var(--card-color);
      color: var(--text-color);
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .search-container input:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--highlight-color);
    }

    .search-container::before {
      content: '\f002';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #aaa;
    }

    .report-list {
      list-style: none;
    }

    .report-item {
      padding: 12px 15px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.05);
    }

    .report-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }

    .report-item.active {
      background-color: var(--primary-color);
      box-shadow: 0 5px 15px rgba(21, 160, 134, 0.3);
    }

    .report-item .report-title {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .report-item .report-date {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.7);
      margin-left: 10px;
      white-space: nowrap;
    }

    .report-item.active .report-date {
      color: rgba(255, 255, 255, 0.9);
    }

    /* Main Content Styles */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 30px;
      transition: margin-left 0.3s ease;
    }

    .report-container {
      background-color: var(--card-color);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      padding: 30px;
      min-height: calc(100vh - 60px);
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .report-header h1 {
      color: var(--highlight-color);
      font-weight: 700;
      font-size: 2rem;
      position: relative;
      display: inline-block;
    }

    .report-header h1::after {
      content: '';
      display: block;
      width: 60px;
      height: 4px;
      background: var(--primary-color);
      margin-top: 10px;
      border-radius: 2px;
    }

    .report-badge {
      background-color: var(--primary-color);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 10px;
    }

    .shared-badge {
      background-color: var(--highlight-color);
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .btn-accion {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .btn-accion:hover {
      background-color: var(--highlight-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-accion.secondary {
      background-color: #7f8c8d;
    }

    .btn-accion.export {
      background-color: #9b59b6;
    }

    .reporte-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .reporte-item {
      margin-bottom: 15px;
    }

    .reporte-item label {
      font-weight: 600;
      display: block;
      margin-bottom: 5px;
      color: var(--highlight-color);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .reporte-item p {
      margin: 0;
      color: var(--text-color);
      font-size: 1rem;
      line-height: 1.5;
      padding: 8px 12px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
    }

    .reporte-item .date-time {
      display: flex;
      gap: 10px;
    }

    .reporte-item .date-time p {
      flex: 1;
    }

    .image-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .image-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      aspect-ratio: 1;
    }

    .image-item:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .image-item .zoom-icon {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
      cursor: pointer;
    }

    .image-item:hover .zoom-icon {
      opacity: 1;
    }

    .compartido-info {
      margin-top: 20px;
      padding: 15px;
      background-color: rgba(26, 188, 156, 0.1);
      border-radius: 8px;
      border-left: 4px solid var(--highlight-color);
    }

    .compartido-info p {
      margin: 5px 0;
      color: var(--highlight-color);
      background: none;
      padding: 0;
    }

    .info-registro {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px dashed rgba(255, 255, 255, 0.2);
      font-size: 0.85rem;
      color: #aaa;
    }

    .info-registro p {
      margin: 5px 0;
      background: none;
      padding: 0;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background-color: var(--card-color);
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      animation: modalFadeIn 0.4s ease-out;
    }

    .modal-content h3 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--highlight-color);
      font-size: 1.5rem;
    }

    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 25px;
    }

    .usuario-item {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .usuario-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .usuario-item img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
      border: 2px solid var(--primary-color);
    }

    .usuario-item .user-info {
      flex: 1;
    }

    .usuario-item .user-name {
      font-weight: 600;
      margin-bottom: 3px;
    }

    .usuario-item .user-position {
      font-size: 0.8rem;
      color: #aaa;
    }

    .usuario-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--primary-color);
      cursor: pointer;
    }

    /* Edit Modal Styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--highlight-color);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background-color: var(--secondary-color);
      color: var(--text-color);
      font-family: 'Poppins', sans-serif;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .image-preview-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .image-preview {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 1;
    }

    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-preview .remove-image {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: var(--danger-color);
      color: white;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .file-input-container {
      position: relative;
      margin-top: 15px;
    }

    .file-input-label {
      display: inline-block;
      padding: 10px 15px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .file-input-label:hover {
      background-color: var(--highlight-color);
    }

    .file-input {
      position: absolute;
      opacity: 0;
      width: 0.1px;
      height: 0.1px;
      overflow: hidden;
    }

    /* Export Modal */
    .modal-exportacion {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-exportacion .modal-content {
      background-color: var(--card-color);
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-exportacion .modal-content h3 {
      margin-bottom: 20px;
      color: var(--highlight-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .opciones-exportacion {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 20px 0;
    }

    .opcion-exportacion {
      display: flex;
      align-items: center;
      padding: 15px;
      background-color: var(--secondary-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .opcion-exportacion:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }

    .opcion-exportacion i {
      margin-right: 15px;
      font-size: 24px;
      color: var(--highlight-color);
    }

    .opcion-exportacion div {
      flex-grow: 1;
    }

    .opcion-exportacion strong {
      display: block;
      margin-bottom: 5px;
      color: var(--highlight-color);
    }

    .opcion-exportacion p {
      margin: 0;
      color: #aaa;
      font-size: 14px;
    }

    /* Notification Icon */
    .icono-notificacion {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background-color: var(--primary-color);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      z-index: 100;
      transition: all 0.3s ease;
    }

    .icono-notificacion:hover {
      background-color: var(--highlight-color);
      transform: scale(1.1);
    }

    .icono-notificacion .punto-rojo {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 12px;
      height: 12px;
      background-color: var(--danger-color);
      border-radius: 50%;
      border: 2px solid var(--primary-color);
    }

    /* Received Reports Modal */
    .modal-reportes-recibidos {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-reportes-recibidos .modal-content {
      background-color: var(--card-color);
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-reportes-recibidos .modal-content h3 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--highlight-color);
    }

    .reporte-recibido-item {
      padding: 15px;
      margin-bottom: 10px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
      border-left: 4px solid var(--primary-color);
    }

    .reporte-recibido-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }

    .reporte-recibido-item.unread {
      border-left: 4px solid var(--highlight-color);
      background-color: rgba(26, 188, 156, 0.1);
    }

    .reporte-recibido-item .reporte-title {
      font-weight: 600;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
    }

    .reporte-recibido-item .reporte-meta {
      font-size: 0.85rem;
      color: #aaa;
    }

    .reporte-recibido-item .reporte-date {
      font-size: 0.8rem;
      color: var(--highlight-color);
    }

    /* Alert Styles */
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: var(--primary-color);
      color: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.5s ease-out, fadeOut 0.5s 2.5s ease-out;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1100;
    }

    .alert.error {
      background-color: var(--danger-color);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #aaa;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--primary-color);
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 1.1rem;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Print Styles */
    @media print {
      body * {
        visibility: hidden;
      background: white;
        color: black;
      }
      .print-container, .print-container * {
        visibility: visible;
      }
      .print-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 20px;
        background-color: white;
        color: black;
      }
      .print-header {
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #15a086;
        padding-bottom: 10px;
      }
      .print-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        page-break-inside: avoid;
      }
      .print-field {
        flex: 1;
        margin: 0 10px;
      }
      .print-label {
        font-weight: bold;
        color: #15a086;
        margin-bottom: 5px;
      }
      .print-value {
        padding: 5px;
        border-bottom: 1px solid #eee;
      }
      .print-images {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 20px;
      }
      .print-image {
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .print-image img {
        width: 100%;
        height: auto;
        border: 1px solid #ddd;
      }
      .no-print {
        display: none !important;
      }
    }

    /* Responsive Styles */
    @media (max-width: 992px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.active {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
      .sidebar-toggle {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 20px;
      }
      .report-container {
        padding: 20px;
      }
      .report-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      .action-buttons {
        width: 100%;
        justify-content: flex-end;
      }
      .modal-content {
        padding: 15px;
      }
    }

    @media (max-width: 576px) {
      .reporte-grid {
        grid-template-columns: 1fr;
      }
      .action-buttons {
        flex-direction: column;
      }
      .btn-accion {
        width: 100%;
        justify-content: center;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>Reportes</h2>
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Buscar reportes...">
    </div>
    
    <ul class="report-list" id="reportList">
      <!-- Los reportes se cargarán aquí dinámicamente -->
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <button class="sidebar-toggle" id="mobileSidebarToggle" style="margin-bottom: 20px;">
      <i class="fas fa-bars"></i> Menú
    </button>
    
    <div class="report-container" id="reportContainer">
      <div class="empty-state">
        <i class="fas fa-file-alt"></i>
        <p>Selecciona un reporte para ver los detalles</p>
      </div>
    </div>
  </div>

  <!-- Notification Icon -->
  <div class="icono-notificacion" onclick="abrirModalReportesRecibidos()">
    <i class="fas fa-bell"></i>
    <div id="puntoRojo" class="punto-rojo" style="display: none;"></div>
  </div>

  <!-- Received Reports Modal -->
  <div class="modal-reportes-recibidos" id="modalReportesRecibidos" style="display: none;">
    <div class="modal-content">
      <h3>Reportes Recibidos</h3>
      <div id="listaReportesRecibidos"></div>
      <div class="modal-buttons">
        <button class="btn-accion" onclick="cerrarModalReportesRecibidos()">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div class="modal" id="modalCompartir">
    <div class="modal-content">
      <h3>Compartir Reporte</h3>
      <div id="usuariosLista"></div>
      <div class="modal-buttons">
        <button class="btn-accion" onclick="compartirReporte()">
          <i class="fas fa-share"></i> Compartir
        </button>
        <button class="btn-accion secondary" onclick="cerrarModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Report Modal -->
  <div class="modal" id="modalEditar">
    <div class="modal-content">
      <h3>Editar Reporte</h3>
      <form id="editarReporteForm">
        <div class="form-row">
          <div class="form-group">
            <label for="editNombreCaso">Nombre del Caso</label>
            <input type="text" id="editNombreCaso" required>
          </div>
          <div class="form-group">
            <label for="editTipoCaso">Tipo de Caso</label>
            <input type="text" id="editTipoCaso" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="editFechaHoraIncidente">Fecha y Hora del Incidente</label>
            <input type="datetime-local" id="editFechaHoraIncidente" required>
          </div>
          <div class="form-group">
            <label for="editReportadoPor">Reportado Por</label>
            <input type="text" id="editReportadoPor" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="editFechaReporte">Fecha del Reporte</label>
            <input type="date" id="editFechaReporte" required>
          </div>
          <div class="form-group">
            <label for="editHoraReporte">Hora del Reporte</label>
            <input type="time" id="editHoraReporte" required>
          </div>
        </div>
        
        <div class="form-group">
          <label for="editDescripcion">Descripción</label>
          <textarea id="editDescripcion" required></textarea>
        </div>
        
        <div class="form-group">
          <label>Imágenes Adjuntas</label>
          <div class="image-preview-container" id="imagePreviewContainer">
            <!-- Las imágenes existentes se mostrarán aquí -->
          </div>
          <div class="file-input-container">
            <label for="editImagenes" class="file-input-label">
              <i class="fas fa-plus"></i> Agregar Imágenes
            </label>
            <input type="file" id="editImagenes" class="file-input" multiple accept="image/*">
          </div>
        </div>
        
        <div class="modal-buttons">
          <button type="button" class="btn-accion" onclick="guardarCambiosReporte()">
            <i class="fas fa-save"></i> Guardar Cambios
          </button>
          <button type="button" class="btn-accion secondary" onclick="cerrarModalEditar()">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal modal-exportacion" id="modalExportacion" style="display: none;">
    <div class="modal-content">
      <h3><i class="fas fa-file-export"></i> Exportar Reportes</h3>
      <div class="opciones-exportacion">
        <div class="opcion-exportacion" onclick="exportarReporteActual('rtmdayli')">
          <i class="fas fa-file-code"></i>
          <div>
            <strong>Exportar reporte actual a .rtmdayli</strong>
            <p>Formato propietario con todos los datos del reporte</p>
          </div>
        </div>
        <div class="opcion-exportacion" onclick="exportarTodosReportes('rtmdayli')">
          <i class="fas fa-file-archive"></i>
          <div>
            <strong>Exportar TODOS los reportes a .rtmdayli</strong>
            <p>Paquete completo con todos los reportes en formato propietario</p>
          </div>
        </div>
        <div class="opcion-exportacion" onclick="exportarConfiguracionCompleta('rtmdayli')">
          <i class="fas fa-cogs"></i>
          <div>
            <strong>Exportar configuración completa</strong>
            <p>Todos los reportes + preferencias de vista + configuración</p>
          </div>
        </div>
      </div>
      <div class="modal-buttons">
        <button class="btn-accion secondary" onclick="cerrarModalExportacion()">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Alert Sound -->
  <audio id="alertSound" src="https://firebasestorage.googleapis.com/v0/b/inventario-35d6b.appspot.com/o/SD_ALERT_32.mp3?alt=media&token=6c8d7b14-ca44-44ad-95de-8e533cd9e948"></audio>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
      authDomain: "inventario-35d6b.firebaseapp.com",
      databaseURL: "https://inventario-35d6b-default-rtdb.firebaseio.com",
      projectId: "inventario-35d6b",
      storageBucket: "inventario-35d6b.appspot.com",
      messagingSenderId: "266100399659",
      appId: "1:266100399659:web:92358d28cbd803c8a7d46e"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // Global Variables
    let currentUser = null;
    let reportesRecibidos = [];
    let allReports = [];
    let imagenesParaSubir = [];
    let imagenesParaEliminar = [];
    let reporteEditando = null;
    let reporteSeleccionado = null;
    let configuracionUsuario = {};

    // Check if user is logged in
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        cargarPreferenciasUsuario();
        iniciarEscuchaEnTiempoReal();
        cargarReportesRecibidos();
        configurarBuscador();
      } else {
        window.location.href = "login.html";
      }
    });

    // Configurar buscador
    function configurarBuscador() {
      const searchInput = document.getElementById('searchInput');
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const reportItems = document.querySelectorAll('.report-item');
        
        reportItems.forEach(item => {
          const title = item.querySelector('.report-title').textContent.toLowerCase();
          const date = item.querySelector('.report-date').textContent.toLowerCase();
          
          if (title.includes(searchTerm) || date.includes(searchTerm)) {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });
      });
    }

    // Function to load user preferences
    async function cargarPreferenciasUsuario() {
      const userPrefsRef = doc(db, "userPrefs", currentUser.uid);
      try {
        const docSnap = await getDoc(userPrefsRef);
        if (docSnap.exists()) {
          configuracionUsuario = docSnap.data();
        }
      } catch (error) {
        console.error("Error al cargar preferencias:", error);
      }
    }

    // Function to save user preferences
    async function guardarPreferenciasUsuario() {
      const userPrefsRef = doc(db, "userPrefs", currentUser.uid);
      try {
        await setDoc(userPrefsRef, {
          ultimaActualizacion: new Date().toISOString(),
          usuario: currentUser.email,
          userId: currentUser.uid
        }, { merge: true });
      } catch (error) {
        console.error("Error al guardar preferencias:", error);
      }
    }

    // Toggle Sidebar
    document.getElementById('mobileSidebarToggle').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('active');
    });

    document.getElementById('sidebarToggle').addEventListener('click', () => {
      document.getElementById('sidebar').classList.remove('active');
    });

    // Function to format date and time
    function formatearFecha(fecha) {
      if (!fecha) return "No especificada";
      
      try {
        const fechaObj = new Date(fecha);
        if (isNaN(fechaObj.getTime())) return "Fecha inválida";
        
        const dia = String(fechaObj.getDate()).padStart(2, '0');
        const mes = String(fechaObj.getMonth() + 1).padStart(2, '0');
        const año = fechaObj.getFullYear();
        const horas = String(fechaObj.getHours()).padStart(2, '0');
        const minutos = String(fechaObj.getMinutes()).padStart(2, '0');
        return `${dia}/${mes}/${año} ${horas}:${minutos}`;
      } catch (e) {
        console.error("Error al formatear fecha:", e);
        return "Fecha inválida";
      }
    }

    // Function to format concatenated dates
    function formatearFechasConcatenadas(fechasStr) {
      if (!fechasStr) return "No especificada";
      
      if (Array.isArray(fechasStr)) {
        return fechasStr.map(f => formatearFecha(f)).join(', ');
      }
      
      if (typeof fechasStr === 'string' && fechasStr.includes(',')) {
        return fechasStr.split(',').map(f => f.trim()).join(', ');
      }
      
      return formatearFecha(fechasStr);
    }

    // Function to convert date to ISO string without timezone offset
    function toLocalISOString(date) {
      const offset = date.getTimezoneOffset();
      const adjustedDate = new Date(date.getTime() - (offset * 60 * 1000));
      return adjustedDate.toISOString().slice(0, -1);
    }

    // Function to generate unique hash
    function generarHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash.toString(16);
    }

    // Function to convert data to .rtmdayli format
    function convertirARtmdayli(datos, tipo = 'reporte') {
      // RTMDayli format structure
      const estructuraRtmdayli = {
        metadata: {
          version: "3.0",
          tipo: tipo,
          fechaCreacion: new Date().toISOString(),
          creador: currentUser.uid,
          aplicacion: "RTMDayli Web",
          coleccionOrigen: datos.coleccion || "Reportes"
        },
        contenido: {
          datos: datos,
          elementos: Object.keys(datos).length,
          relaciones: [],
          referencias: []
        },
        seguridad: {
          encriptado: false,
          hashVerificacion: generarHash(JSON.stringify(datos)),
          marcaAgua: `RTMDayli-${currentUser.uid}-${Date.now()}`,
          permisos: [currentUser.uid]
        },
        sistema: {
          firebaseConfig: {
            proyecto: firebaseConfig.projectId,
            coleccion: datos.coleccion || "Reportes",
            rutaStorage: datos.fotoURL ? new URL(datos.fotoURL).pathname : null
          }
        }
      };
      
      // Convert to special format string
      let rtmdayliString = `RTMDAyLI${btoa(JSON.stringify(estructuraRtmdayli))}`;
      
      // Add digital signature
      rtmdayliString += `|${currentUser.uid}|${Date.now()}|${generarHash(rtmdayliString)}`;
      
      return rtmdayliString;
    }

    // Function to download a file
    function descargarArchivo(contenido, nombreArchivo, tipo) {
      const blob = new Blob([contenido], { type: tipo });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = nombreArchivo;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Function to export current report
    window.exportarReporteActual = function(formato) {
      if (!reporteSeleccionado) {
        mostrarAlerta("Abre un reporte primero para exportarlo", 'error');
        return;
      }

      const reporte = allReports.find(r => r.id === reporteSeleccionado);
      
      if (reporte) {
        // Preparamos los datos del reporte incluyendo las imágenes
        const datosReporte = {
          ...reporte,
          coleccion: "Reportes",
          // Aseguramos que las imágenes se incluyan correctamente
          fotoURLs: reporte.fotoURLs || (reporte.fotoURL ? [reporte.fotoURL] : []),
          fotoURL: reporte.fotoURL || null
        };

        // Convertimos a formato RTMDAyLI
        const rtmdayliData = convertirARtmdayli(datosReporte);
        const nombreArchivo = `Reporte_${datosReporte.nombreCaso.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.rtmdayli`;
        
        // Descargamos el archivo
        descargarArchivo(rtmdayliData, nombreArchivo, 'application/octet-stream');
        mostrarAlerta(`Reporte exportado como ${nombreArchivo}`);
      } else {
        mostrarAlerta("No se pudo encontrar el reporte seleccionado", 'error');
      }
      
      cerrarModalExportacion();
    };

    // Function to export ALL reports
    window.exportarTodosReportes = function(formato) {
      if (allReports.length === 0) {
        mostrarAlerta("No hay reportes para exportar", 'error');
        return;
      }

      // Preparamos los datos de todos los reportes incluyendo imágenes
      const paqueteReportes = {
        coleccion: "Reportes",
        reportes: allReports.map(reporte => ({
          id: reporte.id,
          ...reporte,
          fotoURLs: reporte.fotoURLs || (reporte.fotoURL ? [reporte.fotoURL] : []),
          fotoURL: reporte.fotoURL || null
        })),
        metadata: {
          totalReportes: allReports.length,
          fechaExportacion: new Date().toISOString(),
          usuario: currentUser.email
        }
      };

      const rtmdayliData = convertirARtmdayli(paqueteReportes, 'paquete_reportes');
      const nombreArchivo = `Paquete_Reportes_${new Date().toISOString().slice(0,10)}.rtmdayli`;
      
      descargarArchivo(rtmdayliData, nombreArchivo, 'application/octet-stream');
      mostrarAlerta(`Paquete de ${allReports.length} reportes exportado como ${nombreArchivo}`);
      cerrarModalExportacion();
    };

    // Function to export current view
    window.exportarVistaActual = function(formato) {
      const reportesVisibles = Array.from(document.querySelectorAll('.report-item')).filter(el => {
        return window.getComputedStyle(el).display !== 'none';
      });
      
      if (reportesVisibles.length === 0) {
        mostrarAlerta("No hay reportes visibles en la vista actual", 'error');
        return;
      }

      const reportesData = reportesVisibles.map(el => {
        const reporteId = el.dataset.id;
        const reporte = allReports.find(r => r.id === reporteId);
        return {
          id: reporteId,
          ...reporte,
          fotoURLs: reporte.fotoURLs || (reporte.fotoURL ? [reporte.fotoURL] : []),
          fotoURL: reporte.fotoURL || null
        };
      });

      const paqueteVista = {
        coleccion: "Reportes",
        vista: "detallada",
        reportes: reportesData,
        metadata: {
          totalReportes: reportesData.length,
          fechaExportacion: new Date().toISOString(),
          usuario: currentUser.email
        }
      };

      const rtmdayliData = convertirARtmdayli(paqueteVista, 'vista_reportes');
      const nombreArchivo = `Vista_Reportes_${new Date().toISOString().slice(0,10)}.rtmdayli`;
      
      descargarArchivo(rtmdayliData, nombreArchivo, 'application/octet-stream');
      mostrarAlerta(`Vista actual con ${reportesData.length} reportes exportada como ${nombreArchivo}`);
      cerrarModalExportacion();
    };

    // Function to export complete configuration
    window.exportarConfiguracionCompleta = function(formato) {
      const configuracionCompleta = {
        coleccion: "Reportes",
        reportes: allReports.map(reporte => ({
          id: reporte.id,
          ...reporte,
          fotoURLs: reporte.fotoURLs || (reporte.fotoURL ? [reporte.fotoURL] : []),
          fotoURL: reporte.fotoURL || null
        })),
        configuracion: {
          usuario: configuracionUsuario,
          preferencias: {
            ultimaExportacion: new Date().toISOString()
          }
        },
        metadata: {
          totalReportes: allReports.length,
          fechaExportacion: new Date().toISOString(),
          usuario: currentUser.email,
          firebaseConfig: {
            proyecto: firebaseConfig.projectId,
            coleccion: "Reportes"
          }
        }
      };

      const rtmdayliData = convertirARtmdayli(configuracionCompleta, 'configuracion_completa');
      const nombreArchivo = `Configuracion_Completa_${new Date().toISOString().slice(0,10)}.rtmdayli`;
      
      descargarArchivo(rtmdayliData, nombreArchivo, 'application/octet-stream');
      mostrarAlerta(`Configuración completa exportada como ${nombreArchivo}`);
      cerrarModalExportacion();
    };

    // Function to open export modal
    window.abrirModalExportacion = function() {
      document.getElementById('modalExportacion').style.display = 'flex';
    };

    // Function to close export modal
    window.cerrarModalExportacion = function() {
      document.getElementById('modalExportacion').style.display = 'none';
    };

    // Function to load reports in real-time
    function iniciarEscuchaEnTiempoReal() {
      const reportesRef = collection(db, "Reportes");
      
      onSnapshot(reportesRef, (snapshot) => {
        allReports = [];
        const reportList = document.getElementById('reportList');
        reportList.innerHTML = "";
        
        snapshot.forEach((doc) => {
          const reporte = doc.data();
          if (reporte.userId === currentUser.uid || (reporte.compartidoCon && reporte.compartidoCon.includes(currentUser.uid))) {
            const reporteData = {
              id: doc.id,
              ...reporte,
              // Aseguramos que siempre tengamos un array de fotos
              fotoURLs: reporte.fotoURLs || (reporte.fotoURL ? [reporte.fotoURL] : [])
            };
            allReports.push(reporteData);

            const listItem = document.createElement('li');
            listItem.classList.add('report-item');
            listItem.dataset.id = doc.id;
            
            listItem.innerHTML = `
              <span class="report-title">${reporte.nombreCaso || 'Sin nombre'}</span>
              <span class="report-date">${formatearFecha(reporte.createdAt)}</span>
            `;
            
            listItem.addEventListener('click', () => {
              document.querySelectorAll('.report-item').forEach(item => {
                item.classList.remove('active');
              });
              listItem.classList.add('active');
              cargarDetallesReporte(reporteData);
              reporteSeleccionado = doc.id;
              
              if (reporte.compartidoCon && !reporte.leidoPor?.includes(currentUser.uid)) {
                marcarComoLeido(doc.id, reporte);
              }
              
              if (window.innerWidth < 992) {
                document.getElementById('sidebar').classList.remove('active');
              }
            });
            
            reportList.appendChild(listItem);
          }
        });

        if (allReports.length === 0) {
          reportList.innerHTML = '<li style="text-align: center; color: #aaa; padding: 20px;">No hay reportes disponibles</li>';
        }

        // Update current report if being edited
        const activeItem = document.querySelector('.report-item.active');
        if (activeItem) {
          const activeReport = allReports.find(r => r.id === activeItem.dataset.id);
          if (activeReport) {
            cargarDetallesReporte(activeReport);
            reporteSeleccionado = activeItem.dataset.id;
          }
        }
      });
    }

    // Function to load report details
    function cargarDetallesReporte(reporte) {
      reporteSeleccionado = reporte.id;
      const reportContainer = document.getElementById('reportContainer');
      
      // Create image gallery if exists
      let imagenesHTML = '';
      if (reporte.fotoURLs && reporte.fotoURLs.length > 0) {
        imagenesHTML = `
          <div class="reporte-item">
            <label>Imágenes Adjuntas:</label>
            <div class="image-gallery">
              ${reporte.fotoURLs.map(url => `
                <div class="image-item">
                  <img src="${url}" alt="Imagen del reporte">
                  <div class="zoom-icon" onclick="ampliarImagen('${url}')">
                    <i class="fas fa-search-plus"></i>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      } else if (reporte.fotoURL) {
        imagenesHTML = `
          <div class="reporte-item">
            <label>Imagen Adjunta:</label>
            <div class="image-gallery">
              <div class="image-item">
                <img src="${reporte.fotoURL}" alt="Imagen del reporte">
                <div class="zoom-icon" onclick="ampliarImagen('${reporte.fotoURL}')">
                  <i class="fas fa-search-plus"></i>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Format incident date
      const fechaIncidente = reporte.fechaHoraIncidente ? 
        (Array.isArray(reporte.fechaHoraIncidente) ? 
          reporte.fechaHoraIncidente.map(d => formatearFecha(d)).join('<br>') : 
          formatearFecha(reporte.fechaHoraIncidente)) : 
        'No especificada';

      reportContainer.innerHTML = `
        <div class="report-header">
          <h1>
            ${reporte.nombreCaso || 'Reporte sin nombre'}
            ${reporte.tipoCaso ? `<span class="report-badge">${reporte.tipoCaso}</span>` : ''}
            ${reporte.compartidoCon ? `<span class="report-badge shared-badge"><i class="fas fa-share-alt"></i> Compartido</span>` : ''}
          </h1>
          
          <div class="action-buttons">
            <button class="btn-accion" onclick="imprimirReporte('${reporte.id}')">
              <i class="fas fa-print"></i> Imprimir
            </button>
            <button class="btn-accion" onclick="abrirModalExportacion()">
              <i class="fas fa-file-export"></i> Exportar
            </button>
            ${reporte.userId === currentUser.uid ? `
              <button class="btn-accion" onclick="abrirModalCompartir('${reporte.id}')">
                <i class="fas fa-share"></i> Compartir
              </button>
              <button class="btn-accion" onclick="abrirModalEditar('${reporte.id}')">
                <i class="fas fa-edit"></i> Editar
              </button>
            ` : ''}
          </div>
        </div>
        
        <div class="reporte-grid">
          <div class="reporte-item">
            <label>Nombre del Caso:</label>
            <p>${reporte.nombreCaso || 'No especificado'}</p>
          </div>
          <div class="reporte-item">
            <label>Tipo de Caso:</label>
            <p>${reporte.tipoCaso || 'No especificado'}</p>
          </div>
          <div class="reporte-item">
            <label>Fecha y Hora del Incidente:</label>
            <p>${fechaIncidente}</p>
          </div>
          <div class="reporte-item">
            <label>Reportado Por:</label>
            <p>${reporte.reportadoPor || 'No especificado'}</p>
          </div>
          <div class="reporte-item">
            <label>Fecha del Reporte:</label>
            <p>${formatearFecha(reporte.fechaReporte)}</p>
          </div>
          <div class="reporte-item">
            <label>Hora del Reporte:</label>
            <p>${reporte.horaReporte || 'No especificada'}</p>
          </div>
        </div>
        
        <div class="reporte-item">
          <label>Descripción:</label>
          <p>${reporte.descripcion || 'No hay descripción proporcionada.'}</p>
        </div>
        
        ${imagenesHTML}
        
        <div class="info-registro">
          <p><i class="fas fa-user"></i> Reporte realizado por: ${reporte.usuario || 'Usuario desconocido'}</p>
          <p><i class="fas fa-calendar-alt"></i> Fecha de registro: ${formatearFecha(reporte.createdAt)}</p>
          <p><i class="fas fa-hashtag"></i> Número de registro: ${reporte.numeroRegistro || 'N/A'}</p>
        </div>
        
        ${reporte.compartidoCon ? `
          <div class="compartido-info">
            <p><i class="fas fa-share-alt"></i> Compartido por: ${reporte.compartidoPor || 'Usuario desconocido'}</p>
            <p><i class="fas fa-clock"></i> Fecha de recepción: ${formatearFecha(reporte.compartidoEl)}</p>
          </div>
        ` : ''}
      `;
    }

    // Function to mark a report as read
    async function marcarComoLeido(reporteId, reporte) {
      try {
        const reporteRef = doc(db, "Reportes", reporteId);
        await updateDoc(reporteRef, {
          leidoPor: [...(reporte.leidoPor || []), currentUser.uid]
        });
      } catch (error) {
        console.error("Error al marcar como leído:", error);
      }
    }

    // Function to print report
    window.imprimirReporte = function(reporteId) {
      const reporte = allReports.find(r => r.id === reporteId);
      if (!reporte) return;

      const fechaIncidente = reporte.fechaHoraIncidente ? 
        (Array.isArray(reporte.fechaHoraIncidente) ? 
          reporte.fechaHoraIncidente.map(d => formatearFecha(d)).join('<br>') : 
          formatearFecha(reporte.fechaHoraIncidente)) : 
        'No especificada';

      let imagenesHTML = '';
      if (reporte.fotoURLs && reporte.fotoURLs.length > 0) {
        imagenesHTML = `
          <div class="print-images">
            ${reporte.fotoURLs.map(url => `
              <div class="print-image">
                <img src="${url}" alt="Imagen del reporte">
              </div>
            `).join('')}
          </div>
        `;
      } else if (reporte.fotoURL) {
        imagenesHTML = `
          <div class="print-images">
            <div class="print-image">
              <img src="${reporte.fotoURL}" alt="Imagen del reporte">
            </div>
          </div>
        `;
      }

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Reporte: ${reporte.nombreCaso || 'Sin nombre'}</title>
          <style>
            body { font-family: Arial, sans-serif; color: #000; padding: 20px; }
            .print-container { max-width: 800px; margin: 0 auto; }
            .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #15a086; padding-bottom: 10px; }
            .print-row { display: flex; justify-content: space-between; margin-bottom: 15px; page-break-inside: avoid; }
            .print-field { flex: 1; margin: 0 10px; }
            .print-label { font-weight: bold; color: #15a086; margin-bottom: 5px; }
            .print-value { padding: 5px; border-bottom: 1px solid #eee; }
            .print-images { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
            .print-image { page-break-inside: avoid; break-inside: avoid; }
            .print-image img { width: 100%; height: auto; border: 1px solid #ddd; }
            @page { size: auto; margin: 10mm; }
          </style>
        </head>
        <body>
          <div class="print-container">
            <div class="print-header">
              <h1>Reporte: ${reporte.nombreCaso || 'Sin nombre'}</h1>
              <p>Fecha de impresión: ${new Date().toLocaleDateString()}</p>
            </div>
            
            <div class="print-row">
              <div class="print-field">
                <div class="print-label">Nombre del Caso:</div>
                <div class="print-value">${reporte.nombreCaso || 'No especificado'}</div>
              </div>
              <div class="print-field">
                <div class="print-label">Tipo de Caso:</div>
                <div class="print-value">${reporte.tipoCaso || 'No especificado'}</div>
              </div>
            </div>
            
            <div class="print-row">
              <div class="print-field">
                <div class="print-label">Fecha y Hora del Incidente:</div>
                <div class="print-value">${fechaIncidente}</div>
              </div>
              <div class="print-field">
                <div class="print-label">Reportado Por:</div>
                <div class="print-value">${reporte.reportadoPor || 'No especificado'}</div>
              </div>
            </div>
            
            <div class="print-row">
              <div class="print-field">
                <div class="print-label">Fecha del Reporte:</div>
                <div class="print-value">${formatearFecha(reporte.fechaReporte)}</div>
              </div>
              <div class="print-field">
                <div class="print-label">Hora del Reporte:</div>
                <div class="print-value">${reporte.horaReporte || 'No especificada'}</div>
              </div>
            </div>
            
            <div class="print-row">
              <div class="print-field">
                <div class="print-label">Descripción:</div>
                <div class="print-value">${reporte.descripcion || 'No hay descripción proporcionada.'}</div>
              </div>
            </div>
            
            ${imagenesHTML}
            
            <div class="print-row">
              <div class="print-field">
                <div class="print-label">Registrado por:</div>
                <div class="print-value">${reporte.usuario || 'Usuario desconocido'}</div>
              </div>
              <div class="print-field">
                <div class="print-label">Fecha de registro:</div>
                <div class="print-value">${formatearFecha(reporte.createdAt)}</div>
              </div>
            </div>
          </div>
        </body>
        </html>
      `);
      
      printWindow.document.close();
      setTimeout(() => {
        printWindow.print();
      }, 500);
    };

    // Function to enlarge image
    window.ampliarImagen = function(url) {
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100%';
      modal.style.height = '100%';
      modal.style.backgroundColor = 'rgba(0,0,0,0.9)';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '2000';
      modal.style.cursor = 'zoom-out';
      
      const img = document.createElement('img');
      img.src = url;
      img.style.maxWidth = '90%';
      img.style.maxHeight = '90%';
      img.style.objectFit = 'contain';
      img.style.borderRadius = '8px';
      
      modal.appendChild(img);
      modal.onclick = () => document.body.removeChild(modal);
      
      document.body.appendChild(modal);
    };

    // Function to open share modal
    window.abrirModalCompartir = function(reporteId) {
      reporteSeleccionado = reporteId;
      cargarUsuarios();
      document.getElementById('modalCompartir').style.display = 'flex';
    };

    // Function to close modal
    window.cerrarModal = function() {
      document.getElementById('modalCompartir').style.display = 'none';
    };

    // Function to load users from Firestore
    async function cargarUsuarios() {
      try {
        const usuariosRef = collection(db, "users");
        const usuariosSnapshot = await getDocs(usuariosRef);
        const usuariosLista = document.getElementById('usuariosLista');
        usuariosLista.innerHTML = "";

        usuariosSnapshot.forEach((doc) => {
          const usuario = doc.data();
          if (doc.id !== currentUser.uid) {
            const usuarioItem = document.createElement('div');
            usuarioItem.classList.add('usuario-item');
            usuarioItem.innerHTML = `
              <img src="${usuario.photoURL || 'https://via.placeholder.com/45'}" alt="Foto de perfil">
              <div class="user-info">
                <div class="user-name">${usuario.name || 'Usuario sin nombre'}</div>
                <div class="user-position">${usuario.posicion || 'Sin posición'}</div>
              </div>
              <input type="checkbox" value="${doc.id}">
            `;
            usuariosLista.appendChild(usuarioItem);
          }
        });
      } catch (error) {
        console.error("Error al cargar usuarios:", error);
        mostrarAlerta("Error al cargar la lista de usuarios.", 'error');
      }
    }

    // Function to share report with selected users
    window.compartirReporte = async function() {
      const usuariosSeleccionados = Array.from(document.querySelectorAll('#usuariosLista input:checked')).map(input => input.value);
      if (usuariosSeleccionados.length === 0) {
        mostrarAlerta("Selecciona al menos un usuario.", 'error');
        return;
      }

      try {
        const reporteRef = doc(db, "Reportes", reporteSeleccionado);
        await updateDoc(reporteRef, {
          compartidoCon: usuariosSeleccionados,
          compartidoEl: new Date().toISOString(),
          compartidoPor: currentUser.displayName || currentUser.email,
          leidoPor: []
        });
        
        mostrarAlerta(`Reporte compartido con ${usuariosSeleccionados.length} usuario(s)`);
        cerrarModal();
      } catch (error) {
        console.error(error);
        mostrarAlerta("Error al compartir el reporte.", 'error');
      }
    };

    // Function to show alert
    function mostrarAlerta(mensaje, tipo = 'success') {
      const alert = document.createElement('div');
      alert.className = `alert ${tipo === 'error' ? 'error' : ''}`;
      alert.innerHTML = `
        <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        <span>${mensaje}</span>
      `;
      
      document.body.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 3000);
    }

    // Function to open edit modal
    window.abrirModalEditar = function(reporteId) {
      const reporte = allReports.find(r => r.id === reporteId);
      if (!reporte) return;
      
      reporteEditando = reporte;
      imagenesParaSubir = [];
      imagenesParaEliminar = [];
      
      document.getElementById('editNombreCaso').value = reporte.nombreCaso || '';
      document.getElementById('editTipoCaso').value = reporte.tipoCaso || '';
      
      if (reporte.fechaHoraIncidente) {
        let fechaIncidente;
        if (Array.isArray(reporte.fechaHoraIncidente)) {
          fechaIncidente = reporte.fechaHoraIncidente[0];
        } else {
          fechaIncidente = reporte.fechaHoraIncidente;
        }
        
        const fechaObj = new Date(fechaIncidente);
        if (!isNaN(fechaObj.getTime())) {
          const fechaLocal = toLocalISOString(fechaObj).slice(0, 16);
          document.getElementById('editFechaHoraIncidente').value = fechaLocal;
        }
      }
      
      document.getElementById('editReportadoPor').value = reporte.reportadoPor || '';
      
      if (reporte.fechaReporte) {
        const fechaReporteObj = new Date(reporte.fechaReporte);
        if (!isNaN(fechaReporteObj.getTime())) {
          const fechaLocal = toLocalISOString(fechaReporteObj).slice(0, 10);
          document.getElementById('editFechaReporte').value = fechaLocal;
        }
      }
      
      document.getElementById('editHoraReporte').value = reporte.horaReporte || '';
      document.getElementById('editDescripcion').value = reporte.descripcion || '';
      
      const imagePreviewContainer = document.getElementById('imagePreviewContainer');
      imagePreviewContainer.innerHTML = '';
      
      let imagenes = [];
      if (reporte.fotoURLs && reporte.fotoURLs.length > 0) {
        imagenes = reporte.fotoURLs;
      } else if (reporte.fotoURL) {
        imagenes = [reporte.fotoURL];
      }
      
      imagenes.forEach((url, index) => {
        const imagePreview = document.createElement('div');
        imagePreview.className = 'image-preview';
        imagePreview.innerHTML = `
          <img src="${url}" alt="Imagen ${index + 1}">
          <div class="remove-image" onclick="eliminarImagenExistente('${url}', this)">
            <i class="fas fa-times"></i>
          </div>
        `;
        imagePreviewContainer.appendChild(imagePreview);
      });
      
      document.getElementById('editImagenes').addEventListener('change', function(e) {
        const files = e.target.files;
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (!file.type.match('image.*')) continue;
          
          const reader = new FileReader();
          reader.onload = function(e) {
            const imagePreview = document.createElement('div');
            imagePreview.className = 'image-preview';
            imagePreview.innerHTML = `
              <img src="${e.target.result}" alt="Nueva imagen">
              <div class="remove-image" onclick="eliminarImagenNueva(this)">
                <i class="fas fa-times"></i>
              </div>
            `;
            imagePreviewContainer.appendChild(imagePreview);
            
            imagenesParaSubir.push(file);
          };
          reader.readAsDataURL(file);
        }
        
        e.target.value = '';
      });
      
      document.getElementById('modalEditar').style.display = 'flex';
    };

    // Function to close edit modal
    window.cerrarModalEditar = function() {
      document.getElementById('modalEditar').style.display = 'none';
      imagenesParaSubir = [];
      imagenesParaEliminar = [];
    };

    // Function to delete existing image
    window.eliminarImagenExistente = function(url, element) {
      if (confirm('¿Estás seguro de que deseas eliminar esta imagen?')) {
        imagenesParaEliminar.push(url);
        element.parentElement.remove();
      }
    };

    // Function to delete new image
    window.eliminarImagenNueva = function(element) {
      const index = Array.from(element.parentElement.parentElement.children).indexOf(element.parentElement);
      if (index !== -1) {
        imagenesParaSubir.splice(index, 1);
        element.parentElement.remove();
      }
    };

    // Function to save report changes
    window.guardarCambiosReporte = async function() {
      if (!reporteEditando) return;
      
      try {
        const nombreCaso = document.getElementById('editNombreCaso').value;
        const tipoCaso = document.getElementById('editTipoCaso').value;
        const fechaHoraIncidente = document.getElementById('editFechaHoraIncidente').value;
        const reportadoPor = document.getElementById('editReportadoPor').value;
        const fechaReporte = document.getElementById('editFechaReporte').value;
        const horaReporte = document.getElementById('editHoraReporte').value;
        const descripcion = document.getElementById('editDescripcion').value;
        
        if (!nombreCaso || !tipoCaso || !fechaHoraIncidente || !reportadoPor || !fechaReporte || !horaReporte || !descripcion) {
          mostrarAlerta("Todos los campos son requeridos.", 'error');
          return;
        }
        
        const fechaHoraIncidenteObj = new Date(fechaHoraIncidente);
        const fechaReporteObj = new Date(fechaReporte);
        
        const updateData = {
          nombreCaso,
          tipoCaso,
          fechaHoraIncidente: fechaHoraIncidenteObj.toISOString(),
          reportadoPor,
          fechaReporte: fechaReporteObj.toISOString(),
          horaReporte,
          descripcion,
          updatedAt: new Date().toISOString()
        };
        
        let remainingImages = [];
        if (reporteEditando.fotoURLs && reporteEditando.fotoURLs.length > 0) {
          remainingImages = reporteEditando.fotoURLs.filter(url => !imagenesParaEliminar.includes(url));
        } else if (reporteEditando.fotoURL && !imagenesParaEliminar.includes(reporteEditando.fotoURL)) {
          remainingImages = [reporteEditando.fotoURL];
        }
        
        for (const url of imagenesParaEliminar) {
          try {
            const pathStart = url.indexOf('/o/') + 3;
            const pathEnd = url.indexOf('?');
            const path = decodeURIComponent(url.substring(pathStart, pathEnd));
            const imageRef = ref(storage, path);
            await deleteObject(imageRef);
          } catch (error) {
            console.error("Error al eliminar imagen:", error);
          }
        }
        
        const nuevasImagenesURLs = [];
        for (const file of imagenesParaSubir) {
          try {
            const storageRef = ref(storage, `reportes/${reporteEditando.id}/${file.name}`);
            await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(storageRef);
            nuevasImagenesURLs.push(downloadURL);
          } catch (error) {
            console.error("Error al subir imagen:", error);
          }
        }
        
        const todasLasImagenes = [...remainingImages, ...nuevasImagenesURLs];
        if (todasLasImagenes.length > 0) {
          updateData.fotoURLs = todasLasImagenes;
          if (todasLasImagenes.length === 1) {
            updateData.fotoURL = todasLasImagenes[0];
          }
        } else {
          updateData.fotoURLs = [];
          updateData.fotoURL = null;
        }
        
        const reporteRef = doc(db, "Reportes", reporteEditando.id);
        await updateDoc(reporteRef, updateData);
        
        mostrarAlerta("Reporte actualizado exitosamente.");
        cerrarModalEditar();
      } catch (error) {
        console.error("Error al actualizar reporte:", error);
        mostrarAlerta("Error al actualizar el reporte.", 'error');
      }
    };

    // Function to load received reports
    async function cargarReportesRecibidos() {
      try {
        const reportesRef = collection(db, "Reportes");
        const reportesSnapshot = await getDocs(reportesRef);
        reportesRecibidos = [];

        reportesSnapshot.forEach((doc) => {
          const reporte = doc.data();
          if (reporte.compartidoCon && reporte.compartidoCon.includes(currentUser.uid)) {
            reportesRecibidos.push({
              id: doc.id,
              nombreCaso: reporte.nombreCaso || 'Sin nombre',
              compartidoPor: reporte.compartidoPor || 'Usuario desconocido',
              compartidoEl: reporte.compartidoEl,
              leido: reporte.leidoPor && reporte.leidoPor.includes(currentUser.uid)
            });
          }
        });

        reportesRecibidos.sort((a, b) => new Date(b.compartidoEl) - new Date(a.compartidoEl));

        const reportesNoLeidos = reportesRecibidos.filter(reporte => !reporte.leido);
        if (reportesNoLeidos.length > 0) {
          document.getElementById('puntoRojo').style.display = 'block';
          document.getElementById('alertSound').play().catch(e => console.log("Error al reproducir sonido:", e));
        } else {
          document.getElementById('puntoRojo').style.display = 'none';
        }
      } catch (error) {
        console.error("Error al cargar reportes recibidos:", error);
      }
    }

    // Function to open received reports modal
    window.abrirModalReportesRecibidos = function() {
      const listaReportesRecibidos = document.getElementById('listaReportesRecibidos');
      listaReportesRecibidos.innerHTML = "";

      if (reportesRecibidos.length === 0) {
        listaReportesRecibidos.innerHTML = '<p style="text-align: center; color: #aaa;">No hay reportes recibidos</p>';
      } else {
        reportesRecibidos.forEach((reporte) => {
          const item = document.createElement('div');
          item.classList.add('reporte-recibido-item');
          if (!reporte.leido) {
            item.classList.add('unread');
          }
          
          item.innerHTML = `
            <div class="reporte-title">
              <span>${reporte.nombreCaso}</span>
              ${!reporte.leido ? '<span class="badge">Nuevo</span>' : ''}
            </div>
            <div class="reporte-meta">Compartido por: ${reporte.compartidoPor}</div>
            <div class="reporte-date">${formatearFecha(reporte.compartidoEl)}</div>
          `;
          
          item.onclick = () => {
            const reporteData = allReports.find(r => r.id === reporte.id);
            if (reporteData) {
              const listItem = document.querySelector(`.report-item[data-id="${reporte.id}"]`);
              if (listItem) {
                listItem.click();
              }
            }
            
            cerrarModalReportesRecibidos();
          };
          
          listaReportesRecibidos.appendChild(item);
        });
      }

      document.getElementById('modalReportesRecibidos').style.display = 'flex';
    };

    // Function to close received reports modal
    window.cerrarModalReportesRecibidos = function() {
      document.getElementById('modalReportesRecibidos').style.display = 'none';
    };
  </script>
</body>
</html>
